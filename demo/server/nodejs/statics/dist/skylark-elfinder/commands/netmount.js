/**
 * skylark-elfinder - A version of elfinder that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../elFinder"],function(e){return e.prototype.commands.netmount=function(){"use strict";var e,n=this,t=!1;this.alwaysEnabled=!0,this.updateOnSelect=!1,this.drivers=[],this.handlers={load:function(){var e=n.fm;e.cookieEnabled&&e.one("open",function(){n.drivers=e.netDrivers,n.drivers.length&&$.each(n.drivers,function(){var o=n.options[this];o&&(t=!0,o.integrateInfo&&e.trigger("helpIntegration",Object.assign({cmd:"netmount"},o.integrateInfo)))})})}},this.getstate=function(){return t?0:-1},this.exec=function(){var t,o,i,r,a,d,l,c,s=n.fm,u=$.Deferred(),f=n.options;return n.dialog?n.dialog.elfinderdialog("open"):n.dialog=(i=function(){r.protocol.trigger("change","winfocus")},r={protocol:$("<select/>").on("change",function(n,o){var i=this.value;e.find(".elfinder-netmount-tr").hide(),e.find(".elfinder-netmount-tr-"+i).show(),t&&t.children(".ui-dialog-buttonpane:first").find("button").show(),"function"==typeof f[i].select&&f[i].select(s,n,o)}).addClass("ui-corner-all")},a={title:s.i18n("netMountDialogTitle"),resizable:!0,modal:!0,destroyOnClose:!1,open:function(){$(window).on("focus."+s.namespace,i),r.protocol.trigger("change")},close:function(){"pending"==u.state()&&u.reject(),$(window).off("focus."+s.namespace,i)},buttons:{}},d=function(){var t,o=r.protocol.val(),i={cmd:"netmount",protocol:o},a=f[o];if($.each(e.find("input.elfinder-netmount-inputs-"+o),function(e,n){var t,o;(o=$(n)).is(":radio,:checkbox")?o.is(":checked")&&(t=$.trim(o.val())):t=$.trim(o.val()),t&&(i[n.name]=t)}),!i.host)return s.trigger("error",{error:"errNetMountHostReq",opts:{modal:!0}});i.mnt2res&&(t=!0),s.request({data:i,notify:{type:"netmount",cnt:1,hideCnt:!0}}).done(function(e){var n;e.added&&e.added.length&&(t&&r.protocol.trigger("change","reset"),e.added[0].phash&&(n=s.file(e.added[0].phash))&&(n.dirs||(n.dirs=1,s.change({changed:[n]}))),s.one("netmountdone",function(){s.exec("open",e.added[0].hash)})),u.resolve()}).fail(function(e){a.fail&&"function"==typeof a.fail&&a.fail(s,s.parseError(e)),u.reject(e)}),n.dialog.elfinderdialog("close")},l=$('<form autocomplete="off"/>').on("keydown","input",function(e){var n,t=!0;e.keyCode===$.ui.keyCode.ENTER&&($.each(l.find("input:visible:not(.elfinder-input-optional)"),function(){if(""===$(this).val())return t=!1,n=$(this),!1}),t?d():n.trigger("focus"))}),c=$("<div/>"),e=$('<table class="elfinder-info-tb elfinder-netmount-tb"/>').append($("<tr/>").append($("<td>"+s.i18n("protocol")+"</td>")).append($("<td/>").append(r.protocol))),$.each(n.drivers,function(n,t){f[t]&&(r.protocol.append('<option value="'+t+'">'+s.i18n(f[t].name||t)+"</option>"),$.each(f[t].inputs,function(n,o){o.attr("name",n),"hidden"!=o.attr("type")?(o.addClass("ui-corner-all elfinder-netmount-inputs-"+t),e.append($("<tr/>").addClass("elfinder-netmount-tr elfinder-netmount-tr-"+t).append($("<td>"+s.i18n(n)+"</td>")).append($("<td/>").append(o)))):(o.addClass("elfinder-netmount-inputs-"+t),c.append(o))}),f[t].protocol=r.protocol)}),e.append(c),e.find(".elfinder-netmount-tr").hide(),e.find(".elfinder-netmount-tr-"+n.drivers[0]).show(),a.buttons[s.i18n("btnMount")]=d,a.buttons[s.i18n("btnCancel")]=function(){n.dialog.elfinderdialog("close")},e.find("select,input").addClass("elfinder-tabstop"),o=n.fmDialog(l.append(e),a).ready(function(){r.protocol.trigger("change"),o.elfinderdialog("posInit")}),t=o.closest(".ui-dialog"),o),u.promise()},n.fm.bind("netmount",function(t){var o=t.data||null,i=n.options;o&&o.protocol&&i[o.protocol]&&"function"==typeof i[o.protocol].done&&(i[o.protocol].done(n.fm,o),e.find("select,input").addClass("elfinder-tabstop"),n.dialog.elfinderdialog("tabstopsInit"))})},e.prototype.commands.netunmount=function(){this.alwaysEnabled=!0,this.updateOnSelect=!1,this.drivers=[],this.handlers={load:function(){this.drivers=this.fm.netDrivers}},this.getstate=function(e){var n,t=this.fm;return e&&this.drivers.length&&!this._disabled&&(n=t.file(e[0]))&&n.netkey?0:-1},this.exec=function(e){var n=this,t=this.fm,o=$.Deferred().fail(function(e){e&&t.error(e)}),i=t.file(e[0]);return this._disabled?o.reject():("pending"==o.state()&&t.confirm({title:n.title,text:t.i18n("confirmUnmount",i.name),accept:{label:"btnUnmount",callback:function(){var e,r=i.hash,a=function(e){var n,o=[];return t.leafRoots&&(n=[],$.each(t.leafRoots,function(o,i){var r,a=t.parents(o);-1!==(r=$.inArray(e,a))&&(r=a.length-r,$.each(i,function(e,t){n.push({i:r,hash:t})}))}),n.length&&(n.sort(function(e,n){return e.i<n.i}),$.each(n,function(e,n){o.push(n.hash)}))),o}(r),d=[],l=[],c=function(){$.when(d).done(function(){t.request({data:{cmd:"netmount",protocol:"netunmount",host:i.netkey,user:r,pass:"dum"},notify:{type:"netunmount",cnt:1,hideCnt:!0},preventFail:!0}).fail(function(e){o.reject(e)}).done(function(e){i.volumeid&&delete t.volumeExpires[i.volumeid],o.resolve()})}).fail(function(e){l.length&&t.remove({removed:l}),o.reject(e)})};a.length?t.confirm({title:n.title,text:(e=["unmountChildren"],$.each(a,function(n,o){e.push([t.file(o).name])}),e),accept:{label:"btnUnmount",callback:function(){$.each(a,function(e,n){var o=t.file(n);o.netkey&&d.push(t.request({data:{cmd:"netmount",protocol:"netunmount",host:o.netkey,user:o.hash,pass:"dum"},notify:{type:"netunmount",cnt:1,hideCnt:!0},preventDefault:!0}).done(function(e){e.removed&&(o.volumeid&&delete t.volumeExpires[o.volumeid],l=l.concat(e.removed))}))}),c()}},cancel:{label:"btnCancel",callback:function(){o.reject()}}}):(d=null,c())}},cancel:{label:"btnCancel",callback:function(){o.reject()}}}),o)}},e});
//# sourceMappingURL=../sourcemaps/commands/netmount.js.map
