/**
 * skylark-elfinder - A version of elfinder that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../elFinder"],function(e){return e.prototype.commands.quicklook.plugins=[function(e){"use strict";var n,i,o=["image/jpeg","image/png","image/gif","image/svg+xml","image/x-ms-bmp"],t=e.fm.returnBytes(e.options.getDimThreshold||0),a=e.preview;(n=new Image).onload=n.onerror=function(){2==n.height&&o.push("image/webp")},n.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA",$.each(navigator.mimeTypes,function(e,n){var i=n.type;0===i.indexOf("image/")&&$.inArray(i,o)&&o.push(i)}),a.on(e.evUpdate,function(n){var r,s,d,c,p=e.fm,l=n.file,f=!1,u=null,m=function(e){var n=p.file(l.hash);n.width=e[0],n.height=e[1]},g=function(){var e,n,i,o,t;u&&u.state&&"pending"===u.state()&&u.reject(),f||(f=!0,e=r.get(0),(n=l.width&&l.height?{w:l.width,h:l.height}:e.naturalWidth?null:{w:r.width(),h:r.height()})&&r.removeAttr("width").removeAttr("height"),i=l.width||e.naturalWidth||e.width||r.width(),o=l.height||e.naturalHeight||e.height||r.height(),l.width&&l.height||m([i,o]),n&&r.width(n.w).height(n.h),t=(i/o).toFixed(2),a.on("changesize",function(){var e,n,i=parseInt(a.width()),o=parseInt(a.height());t<(i/o).toFixed(2)?(n=o,e=Math.floor(n*t)):(e=i,n=Math.floor(e/t)),r.width(e).height(n).css("margin-top",n<o?Math.floor((o-n)/2):0)}).trigger("changesize"),r.fadeIn(100))};i||(i=p.arrayFlip(o)),i[l.mime]&&e.dispInlineRegex.test(l.mime)&&(n.stopImmediatePropagation(),s=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+p.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),d=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(s),r=$("<img/>").hide().appendTo(a).on("load",function(){s.remove(),e.hideinfo(),g()}).on("error",function(){s.remove()}),c=p.openUrl(l.hash,!1,function(e){r.attr("src",e)},{progressBar:d}),a.one("change",function(){c&&c.state&&"pending"===c.state()&&c.reject()}),l.width&&l.height?g():l.size>t&&(u=p.request({data:{cmd:"dim",target:l.hash},preventDefault:!0}).done(function(e){if(e.dim){var n=e.dim.split("x");l.width=n[0],l.height=n[1],m(n),g()}})))})},function(e){"use strict";var n=e.fm,i=e.preview;window.Worker&&window.Uint8Array&&i.on(e.evUpdate,function(o){var t,a,r,s,d,c=o.file,p=function(e){s&&s.terminate(),t.remove(),n.debug("error",e)};"image/tiff"===c.mime&&(o.stopImmediatePropagation(),t=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+n.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),a=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(t),i.one("change",function(){s&&s.terminate(),t.remove()}),d=n.getContents(c.hash,"arraybuffer",{progressBar:a}).done(function(o){if(o){r=$("<div/>").css({width:"100%",height:"100%"}).hide().appendTo(i);try{(s=n.getWorker()).onmessage=function(o){var a,d,p,l,f,u,m=o.data;s&&s.terminate(),d=(a=document.createElement("canvas")).getContext("2d"),a.width=m.width,a.height=m.height,(p=d.createImageData(m.width,m.height)).data.set(new Uint8Array(m.image)),d.putImageData(p,0,0),r.append(a).show(),t.remove(),l=(m.width/m.height).toFixed(2),i.on("changesize",function(){var e,n,o=parseInt(i.width()),t=parseInt(i.height());l<(o/t).toFixed(2)?(n=t,e=Math.floor(n*l)):(e=o,n=Math.floor(e/l)),$(a).width(e).height(n).css("margin-top",n<t?Math.floor((t-n)/2):0)}).trigger("changesize"),c.width&&c.height||(f=[m.width,m.height],(u=n.file(c.hash)).width=f[0],u.height=f[1]),e.hideinfo()},s.onerror=p,s.postMessage({scripts:[n.options.cdns.tiff,n.getWorkerUrl("quicklook.tiff.js")],data:{data:o}})}catch(e){p(e)}}else p()}),i.one("change",function(){d&&d.state&&"pending"===d.state()&&d.reject()}))})},function(e){"use strict";var n,i=e.fm,o=i.arrayFlip(["image/vnd.adobe.photoshop","image/x-photoshop"]),t=e.preview,a=function(o,a,r){try{i.replaceXhrSend(),n.fromURL(o).then(function(n){var i;a.attr("src",n.image.toBase64()),requestAnimationFrame(function(){i=(a.width()/a.height()).toFixed(2),t.on("changesize",function(){var e,n,o=parseInt(t.width()),r=parseInt(t.height());i<(o/r).toFixed(2)?(n=r,e=Math.floor(n*i)):(e=o,n=Math.floor(e/i)),a.width(e).height(n).css("margin-top",n<r?Math.floor((r-n)/2):0)}).trigger("changesize"),r.remove(),e.hideinfo(),a.fadeIn(100)})},function(){r.remove(),a.remove()}),i.restoreXhrSend()}catch(e){i.restoreXhrSend(),r.remove(),a.remove()}};t.on(e.evUpdate,function(r){var s,d,c,p,l,f,u=r.file;o[u.mime]&&i.options.cdns.psd&&!i.UA.ltIE10&&e.dispInlineRegex.test(u.mime)&&(r.stopImmediatePropagation(),d=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+i.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),c=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(d),f=i.openUrl(u.hash,"sameorigin",function(e){e&&(s=$("<img/>").hide().appendTo(t),n?a(e,s,d):(p=window.define,l=window.require,window.require=null,window.define=null,i.loadScript([i.options.cdns.psd],function(){n=require("psd"),p?window.define=p:delete window.define,l?window.require=l:delete window.require,a(e,s,d)})))},{progressBar:c}),t.one("change",function(){f&&f.state&&"pending"===f.state()&&f.reject()}))})},function(e){"use strict";var n=e.fm,i=n.arrayFlip(["text/html","application/xhtml+xml"]),o=e.preview;o.on(e.evUpdate,function(t){var a,r,s,d=t.file;i[d.mime]&&e.dispInlineRegex.test(d.mime)&&(!e.options.getSizeMax||d.size<=e.options.getSizeMax)&&(t.stopImmediatePropagation(),r=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+n.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),s=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(r),o.one("change",function(){"pending"==a.state()&&a.reject()}).addClass("elfinder-overflow-auto"),a=n.request({data:{cmd:"get",target:d.hash,conv:1,_t:d.ts},options:{type:"get",cache:!0},preventDefault:!0,progressBar:s}).done(function(n){e.hideinfo();var i=$('<iframe class="elfinder-quicklook-preview-html"/>').appendTo(o)[0].contentWindow.document;i.open(),i.write(n.content),i.close()}).always(function(){r.remove()}))})},function(e){"use strict";var n=e.fm,i=n.arrayFlip(["text/x-markdown"]),o=e.preview,t=null,a=function(n,i){e.hideinfo();var a=$('<iframe class="elfinder-quicklook-preview-html"/>').appendTo(o)[0].contentWindow.document;a.open(),a.write(t(n.content)),a.close(),i.remove()},r=function(e){t=!1,e.remove()};o.on(e.evUpdate,function(s){var d,c,p,l=s.file;i[l.mime]&&n.options.cdns.marked&&!1!==t&&e.dispInlineRegex.test(l.mime)&&(!e.options.getSizeMax||l.size<=e.options.getSizeMax)&&(s.stopImmediatePropagation(),c=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+n.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),p=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(c),o.one("change",function(){"pending"==d.state()&&d.reject()}).addClass("elfinder-overflow-auto"),d=n.request({data:{cmd:"get",target:l.hash,conv:1,_t:l.ts},options:{type:"get",cache:!0},preventDefault:!0,progressBar:p}).done(function(e){t||window.marked?(t||(t=window.marked),a(e,c)):n.loadScript([n.options.cdns.marked],function(n){t=n||window.marked||!1,delete window.marked,t?a(e,c):r(c)},{tryRequire:!0,error:function(){r(c)}})}).fail(function(){r(c)}))})},function(e){if(e.options.viewerjs){var n=e.fm,i=e.preview,o=e.options.viewerjs,t=o.url?n.arrayFlip(o.mimes||[]):[],a=e.window,r=e.navbar,s=function(){r.css("bottom",a.hasClass("elfinder-quicklook-fullscreen")?"30px":"")};o.url&&i.on("update",function(r){var d,c,p,l,f=r.file;!t[f.mime]||"application/pdf"===f.mime&&o.pdfNative&&e.flags.pdfNative||(r.stopImmediatePropagation(),c=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+n.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),p=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(c),l=n.openUrl(f.hash,"sameorigin",function(n){n&&(d=$('<iframe class="elfinder-quicklook-preview-iframe"/>').css("background-color","transparent").on("load",function(){e.hideinfo(),c.remove(),d.css("background-color","#fff")}).on("error",function(){c.remove(),d.remove()}).appendTo(i).attr("src",o.url+"#"+n),a.on("viewchange.viewerjs",s),s(),i.one("change",function(){a.off("viewchange.viewerjs"),c.remove(),d.off("load").remove()}))},{progressBar:p}),i.one("change",function(){l&&l.state&&"pending"===l.state()&&l.reject()}))})}},function(e){"use strict";var n=e.fm,i="application/pdf",o=e.preview,t=!1,a="";n.UA.Safari&&"mac"===n.OS&&!n.UA.iOS||n.UA.IE||n.UA.Firefox?t=!0:$.each(navigator.plugins,function(e,n){$.each(n,function(e,n){if(n.type===i)return!(t=!0)})}),e.flags.pdfNative=t,t&&(void 0===e.options.pdfToolbar||e.options.pdfToolbar||(a="#toolbar=0"),o.on(e.evUpdate,function(r){var s,d=r.file;t&&d.mime===i&&e.dispInlineRegex.test(d.mime)&&(r.stopImmediatePropagation(),s=n.openUrl(d.hash,!1,function(i){i&&(e.hideinfo(),e.cover.addClass("elfinder-quicklook-coverbg"),$('<object class="elfinder-quicklook-preview-pdf" data="'+i+a+'" type="application/pdf" />').on("error",function(i){t=!1,e.update(void 0,n.cwd()),e.update(void 0,d)}).appendTo(o))}),o.one("change",function(){s&&s.state&&"pending"===s.state()&&s.reject()}))}))},function(e){"use strict";var n=e.fm,i="application/x-shockwave-flash",o=e.preview,t=!1;$.each(navigator.plugins,function(e,n){$.each(n,function(e,n){if(n.type===i)return!(t=!0)})}),t&&o.on(e.evUpdate,function(t){var a,r=t.file;r.mime===i&&e.dispInlineRegex.test(r.mime)&&(t.stopImmediatePropagation(),a=n.openUrl(r.hash,!1,function(n){n&&(e.hideinfo(),$('<embed class="elfinder-quicklook-preview-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" src="'+n+'" quality="high" type="application/x-shockwave-flash" wmode="transparent" />').appendTo(o))}),o.one("change",function(){a&&a.state&&"pending"===a.state()&&a.reject()}))})},function(e){"use strict";var n,i,o,t,a,r,s=e.fm,d=e.preview,c={"audio/mpeg":"mp3","audio/mpeg3":"mp3","audio/mp3":"mp3","audio/x-mpeg3":"mp3","audio/x-mp3":"mp3","audio/x-wav":"wav","audio/wav":"wav","audio/x-m4a":"m4a","audio/aac":"m4a","audio/mp4":"m4a","audio/x-mp4":"m4a","audio/ogg":"ogg","audio/webm":"webm","audio/flac":"flac","audio/x-flac":"flac","audio/amr":"amr"},p=e.window,l=e.navbar,f="string"==typeof e.options.mediaControlsList&&e.options.mediaControlsList?' controlsList="'+s.escape(e.options.mediaControlsList)+'"':"",u=function(){l.css("bottom",p.hasClass("elfinder-quicklook-fullscreen")?"50px":"")},m=function(e,i){return $('<audio class="elfinder-quicklook-preview-audio ui-front" controls'+f+' preload="auto" autobuffer><source src="'+e+'" /></audio>').on("change",function(e){e.stopPropagation()}).on("error",function(e){n&&n.data("hash")===i&&h()}).data("hash",i).appendTo(d)},g=function(e){var i,o=n.data("hash");t&&(i=e.play()),i&&i.catch&&i.catch(function(i){e.paused||n&&n.data("hash")===o&&h()})},h=function(){if(n&&n.parent().length){var e=n[0],i=n.children("source").attr("src");p.off("viewchange.audio");try{e.pause(),n.empty(),i.match(/^blob:/)&&URL.revokeObjectURL(i),e.src="",e.load()}catch(e){}n.remove(),n=null}};d.on(e.evUpdate,function(l){var f,h,v,w,k,q,x=l.file,y=c[x.mime];c[x.mime]&&e.dispInlineRegex.test(x.mime)&&((f=e.support.audio[y])||"amr"===y)&&(t=e.autoPlay(),i=x.hash,f?(l.stopImmediatePropagation(),a=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+s.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),r=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(a),h=s.openUrl(i,!1,function(e){a.remove(),e?(n=m(e,i),g(n[0]),p.on("viewchange.audio",u),u()):n.remove()},{progressBar:r}),d.one("change",function(){h&&h.state&&"pending"===h.state()&&h.reject()})):s.options.cdns.amr&&"amr"===y&&!1!==o&&(l.stopImmediatePropagation(),a=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+s.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),r=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(a),n=m("",i),(v=x.hash,k=$.Deferred(),q=$.Deferred().done(function(){var e;e=s.getContents(v,"arraybuffer",{progressBar:r}).done(function(e){try{var n=o.toWAV(new Uint8Array(e));n?k.resolve(URL.createObjectURL(new Blob([n],{type:"audio/x-wav"}))):k.reject()}catch(e){k.reject()}}).fail(function(){k.reject()}),d.one("change",function(){e&&e.state&&"pending"===e.state()&&e.reject()})}).fail(function(){o=!1,k.reject()}),window.TextEncoder&&window.URL&&URL.createObjectURL&&void 0===o?(w=window.AMR,delete window.AMR,s.loadScript([s.options.cdns.amr],function(){o=!!window.AMR&&window.AMR,window.AMR=w,q[o?"resolve":"reject"]()},{error:function(){q.reject()}})):q[o?"resolve":"reject"](),k).done(function(e){if(a.remove(),i===x.hash){var o=n[0];try{n.children("source").attr("src",e),o.pause(),o.load(),g(o),p.on("viewchange.audio",u),u()}catch(i){URL.revokeObjectURL(e),n.remove()}}else URL.revokeObjectURL(e)}).fail(function(){n.remove()})))}).one("change",h)},function(e){"use strict";var n,i,o,t,a,r,s,d,c,p,l=e.fm,f=e.preview,u={"video/mp4":"mp4","video/x-m4v":"mp4","video/quicktime":"mp4","video/mpeg":"mpeg","video/ogg":"ogg","application/ogg":"ogg","video/webm":"webm","video/x-matroska":"mkv","video/3gpp":"3gp","application/vnd.apple.mpegurl":"m3u8","application/x-mpegurl":"m3u8","application/dash+xml":"mpd","video/x-flv":"flv","video/x-msvideo":"avi"},m=e.window,g=e.navbar,h="string"==typeof e.options.mediaControlsList&&e.options.mediaControlsList?' controlsList="'+l.escape(e.options.mediaControlsList)+'"':"",v=function(){l.UA.iOS?m.hasClass("elfinder-quicklook-fullscreen")?(f.css("height","-webkit-calc(100% - 50px)"),g._show()):f.css("height",""):g.css("bottom",m.hasClass("elfinder-quicklook-fullscreen")?"50px":"")},w=function(i,o){var a,r=function(e){s>1&&(d&&clearTimeout(d),d=setTimeout(function(){!a&&U(!0)},800))},s=0;t=null,o=o||{},e.hideinfo(),(n=$('<video class="elfinder-quicklook-preview-video" controls'+h+' preload="auto" autobuffer playsinline></video>').on("change",function(e){e.stopPropagation()}).on("timeupdate progress",r).on("canplay",function(){a=!0}).data("hash",i.hash))[0].addEventListener("error",function(e){o.src&&l.convAbsUrl(o.src)===l.convAbsUrl(e.target.src)&&(++s,r())},!0),o.src&&n.append('<source src="'+o.src+'" type="'+i.mime+'"/><source src="'+o.src+'"/>'),n.appendTo(f),m.on("viewchange.video",v),v()},k=function(e){var o,t;t=l.openUrl(e.hash,!1,function(t){c.remove(),t&&(w(e),(o=new i).loadSource(t),o.attachMedia(n[0]),s&&o.on(i.Events.MANIFEST_PARSED,function(){b(n[0])}))},{progressBar:p}),f.one("change",function(){t&&t.state&&"pending"===t.state()&&t.reject()})},q=function(e){var i;i=l.openUrl(e.hash,!1,function(i){var o;c.remove(),i&&(w(e),(o=(t=window.dashjs.MediaPlayer().create()).getDebug()).setLogLevel?o.setLogLevel(dashjs.Debug.LOG_LEVEL_FATAL):o.setLogToBrowserConsole&&o.setLogToBrowserConsole(!1),t.initialize(n[0],i,s),t.on("error",function(e){U(!0)}))},{progressBar:p}),f.one("change",function(){i&&i.state&&"pending"===i.state()&&i.reject()})},x=function(e){var i;a.isSupported()?(i=l.openUrl(e.hash,!1,function(i){if(c.remove(),i){var o=a.createPlayer({type:"flv",url:i});w(e),o.on(a.Events.ERROR,function(){o.destroy(),U(!0)}),o.attachMediaElement(n[0]),o.load(),b(o)}},{progressBar:p}),f.one("change",function(){i&&i.state&&"pending"===i.state()&&i.reject()})):a=!1},y=function(e){var i;i=l.openUrl(e.hash,!1,function(i){c.remove(),i&&(w(e),n[0].src=i,r(n[0],{src:i}))},{progressBar:p}),f.one("change",function(){i&&i.state&&"pending"===i.state()&&i.reject()})},b=function(e){var i,o=n.data("hash");s&&(i=e.play()),i&&i.catch&&i.catch(function(i){e.paused||n&&n.data("hash")===o&&U(!0)})},U=function(i){if(d&&clearTimeout(d),n&&n.parent().length){var o=n[0];m.off("viewchange.video"),t&&t.reset();try{o.pause(),n.empty(),o.src="",o.load()}catch(e){}n.remove(),n=null}i&&e.info.show()};f.on(e.evUpdate,function(t){var d,m,g=t.file,h=g.mime.toLowerCase(),v=u[h];u[h]&&e.dispInlineRegex.test(g.mime)&&(s=e.autoPlay(),c=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+l.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>'),p=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(c),e.support.video[v]&&("m3u8"!==v||l.UA.Safari)?(t.stopImmediatePropagation(),c.appendTo(e.info.find(".elfinder-quicklook-info")),m=l.openUrl(g.hash,!1,function(e){c.remove(),e&&(w(g,{src:e}),b(n[0]))},{progressBar:p}),f.one("change",function(){m&&m.state&&"pending"===m.state()&&m.reject()})):!1!==i&&l.options.cdns.hls&&"m3u8"===v?(t.stopImmediatePropagation(),c.appendTo(e.info.find(".elfinder-quicklook-info")),i?k(g):(d=window.Hls,delete window.Hls,l.loadScript([l.options.cdns.hls],function(e){i=e||window.Hls||!1,window.Hls=d,i&&k(g)},{tryRequire:!0,error:function(){i=!1}}))):!1!==o&&l.options.cdns.dash&&"mpd"===v?(t.stopImmediatePropagation(),c.appendTo(e.info.find(".elfinder-quicklook-info")),o?q(g):l.loadScript([l.options.cdns.dash],function(){(o=!!window.dashjs)&&q(g)},{tryRequire:!0,error:function(){o=!1}})):!1!==a&&l.options.cdns.flv&&"flv"===v?(t.stopImmediatePropagation(),c.appendTo(e.info.find(".elfinder-quicklook-info")),a?x(g):(d=window.flvjs,delete window.flvjs,l.loadScript([l.options.cdns.flv],function(e){a=e||window.flvjs||!1,window.flvjs=d,a&&x(g)},{tryRequire:!0,error:function(){a=!1}}))):l.options.cdns.videojs&&(t.stopImmediatePropagation(),c.appendTo(e.info.find(".elfinder-quicklook-info")),r?y(g):l.loadScript([l.options.cdns.videojs+"/video.min.js"],function(e){(r=e||window.videojs||!1)&&y(g)},{tryRequire:!0,error:function(){r=!1}}).loadCss([l.options.cdns.videojs+"/video-js.min.css"])))}).one("change",U)},function(e){"use strict";var n,i=e.preview,o=[],t=e.window,a=e.navbar;$.each(navigator.plugins,function(e,n){$.each(n,function(e,n){(0===n.type.indexOf("audio/")||0===n.type.indexOf("video/"))&&o.push(n.type)})}),o=e.fm.arrayFlip(o),i.on(e.evUpdate,function(r){var s,d,c,p,l=r.file,f=l.mime,u=function(){a.css("bottom",t.hasClass("elfinder-quicklook-fullscreen")?"50px":"")};o[l.mime]&&e.dispInlineRegex.test(l.mime)&&(r.stopImmediatePropagation(),c=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+fm.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),p=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(c),d=e.fm.openUrl(l.hash,!1,function(o){c.remove(),o&&((s=0===f.indexOf("video/"))&&e.hideinfo(),n=$('<embed src="'+o+'" type="'+f+'" class="elfinder-quicklook-preview-'+(s?"video":"audio")+'"/>').appendTo(i),t.on("viewchange.embed",u),u())},{progressBar:p}),i.one("change",function(){d&&d.state&&"pending"===d.state()&&d.reject()}))}).one("change",function(){n&&n.parent().length&&(t.off("viewchange.embed"),n.remove(),n=null)})},function(e){"use strict";var n=e.fm,i=n.arrayFlip(["application/zip","application/x-gzip","application/x-tar","application/x-bzip2"]),o=e.preview,t=n.returnBytes(e.options.unzipMaxSize||0),a=!(!n.options.cdns.zlibUnzip||!n.options.cdns.zlibGunzip),r=!!n.options.cdns.bzip2;window.Worker&&window.Uint8Array&&window.DataView&&o.on(e.evUpdate,function(s){var d=s.file,c="application/x-tar"===d.mime,p="application/x-bzip2"===d.mime,l="application/zip"===d.mime||"application/x-gzip"===d.mime;if(i[d.mime]&&(!t||d.size<=t)&&(c||p&&r||l&&a)){var f,u,m,g,h=function(i){var t,a,r=0;i&&i.length&&((i=$.map(i,function(e){return n.decodeRawString(e)})).sort(),a=n.escape(i.join("\n").replace(/\{formatSize\((\d+)\)\}/g,function(e,i){return r+=parseInt(i),n.formatSize(i)})),t="<strong>"+n.escape(d.mime)+"</strong> ("+n.formatSize(d.size)+" / "+n.formatSize(r)+")<hr/>",$('<div class="elfinder-quicklook-preview-archive-wrapper">'+t+'<pre class="elfinder-quicklook-preview-text">'+a+"</pre></div>").on("touchstart",function(e){$(this)["scroll"+("ltr"===n.direction?"Right":"Left")]()>5&&(e.originalEvent._preventSwipeX=!0)}).appendTo(o),e.hideinfo()),m.remove()};s.stopImmediatePropagation(),m=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+n.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),g=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(m),o.one("change",function(){"pending"===f.state()&&f.reject(),u&&u.terminate(),m.remove()}),f=n.getContents(d.hash,"arraybuffer",{progressBar:g}).fail(function(){m.remove()}).done(function(e){var i=function(e){u&&u.terminate(),m.remove(),l?a=!1:p&&(r=!1),n.debug("error",e)};try{(u=n.getWorker()).onmessage=function(e){u&&u.terminate(),m.remove(),!e.data||e.data.error?new Error(e.data&&e.data.error?e.data.error:""):h(e.data.files)},u.onerror=i,"application/x-tar"===d.mime?u.postMessage({scripts:[n.getWorkerUrl("quicklook.unzip.js")],data:{type:"tar",bin:e}}):"application/zip"===d.mime?u.postMessage({scripts:[n.options.cdns.zlibUnzip,n.getWorkerUrl("quicklook.unzip.js")],data:{type:"zip",bin:e}}):"application/x-gzip"===d.mime?u.postMessage({scripts:[n.options.cdns.zlibGunzip,n.getWorkerUrl("quicklook.unzip.js")],data:{type:"gzip",bin:e}}):"application/x-bzip2"===d.mime&&u.postMessage({scripts:[n.options.cdns.bzip2,n.getWorkerUrl("quicklook.unzip.js")],data:{type:"bzip2",bin:e}})}catch(e){i(e)}})}})},function(e){"use strict";var n,i=e.fm,o=i.arrayFlip(["application/x-rar"]),t=e.preview;window.DataView&&t.on(e.evUpdate,function(a){var r=a.file;if(o[r.mime]&&i.options.cdns.rar&&!1!==n){var s,d,c,p,l,f,u=function(o){if(p)s.remove();else try{c=n({file:o,type:2,xhrHeaders:i.customHeaders,xhrFields:i.xhrFields},function(n){s.remove();var o,a=[];p||n?n&&i.debug("error",n):($.each(c.entries,function(){a.push(this.path+(this.size?" ("+i.formatSize(this.size)+")":""))}),a.length&&((a=$.map(a,function(e){return i.decodeRawString(e)})).sort(),o="<strong>"+i.escape(r.mime)+"</strong> ("+i.formatSize(r.size)+")<hr/>",$('<div class="elfinder-quicklook-preview-archive-wrapper">'+o+'<pre class="elfinder-quicklook-preview-text">'+i.escape(a.join("\n"))+"</pre></div>").on("touchstart",function(e){$(this)["scroll"+("ltr"===i.direction?"Right":"Left")]()>5&&(e.originalEvent._preventSwipeX=!0)}).appendTo(t),e.hideinfo()))})}catch(e){s.remove()}},m=function(){n=!1,s.remove()};a.stopImmediatePropagation(),s=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+i.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),d=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(s),t.one("change",function(){c&&(c.abort=!0),s.remove(),p=!0}),f=i.openUrl(r.hash,"sameorigin",function(e){e&&(n?u(e):(window.RarArchive&&(l=window.RarArchive,delete window.RarArchive),i.loadScript([i.options.cdns.rar],function(){i.hasRequire?require(["rar"],function(i){n=i,u(e)},m):(n=window.RarArchive)?(l?window.RarArchive=l:delete window.RarArchive,u(e)):m()},{tryRequire:!0,error:m})))},{progressBar:d,temporary:!0}),t.one("change",function(){f&&f.state&&"pending"===f.state()&&f.reject()})}})},function(e){"use strict";var n,i=e.fm,o=i.arrayFlip(e.options.sharecadMimes||[]),t=e.preview;e.window;e.options.sharecadMimes.length&&e.addIntegration({title:"ShareCAD.org CAD and 3D-Models viewer",link:"https://sharecad.org/DWGOnlinePlugin"}),t.on(e.evUpdate,function(a){var r=a.file;if(o[r.mime.toLowerCase()]&&!i.option("onetimeUrl",r.hash)){var s,d,c;e.window;a.stopImmediatePropagation(),"1"==r.url&&(t.hide(),$('<div class="elfinder-quicklook-info-data"><button class="elfinder-info-button">'+i.i18n("getLink")+"</button></div>").appendTo(e.info.find(".elfinder-quicklook-info")).on("click",function(){var n=$(this);n.html('<span class="elfinder-spinner">'),i.request({data:{cmd:"url",target:r.hash},preventDefault:!0,progressBar:d}).always(function(){n.html("")}).done(function(n){var o=i.file(r.hash);r.url=o.url=n.url||"",r.url&&t.trigger({type:e.evUpdate,file:r,forceUpdate:!0})})})),""!==r.url&&"1"!=r.url&&(t.one("change",function(){s.remove(),n.off("load").remove(),n=null}).addClass("elfinder-overflow-auto"),s=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+i.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),d=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(s),c=i.convAbsUrl(i.url(r.hash)),n=$('<iframe class="elfinder-quicklook-preview-iframe" scrolling="no"/>').css("background-color","transparent").appendTo(t).on("load",function(){e.hideinfo(),s.remove(),e.preview.after(e.info),$(this).css("background-color","#fff").show()}).on("error",function(){s.remove(),e.preview.after(e.info)}).attr("src","//sharecad.org/cadframe/load?url="+encodeURIComponent(c)),e.info.after(e.preview))}})},function(e){"use strict";var n,i,o,t,a,r=e.fm,s={"application/vnd.google-earth.kml+xml":!0,"application/vnd.google-earth.kmz":!0},d=e.preview;e.options.googleMapsApiKey&&(e.addIntegration({title:"Google Maps",link:"https://www.google.com/intl/"+r.lang.replace("_","-")+"/help/terms_maps.html"}),n=window.google&&google.maps,i=function(i,o,a){var s=e.options.googleMapsOpts.maps;r.forExternalUrl(i.hash,{progressBar:a}).done(function(i){if(i)try{new n.KmlLayer(i,Object.assign({map:new n.Map(o.get(0),s)},e.options.googleMapsOpts.kml)),e.hideinfo()}catch(e){t()}else t()})},o=window.gm_authFailure,t=function(){a=null},a="https://maps.googleapis.com/maps/api/js?key="+e.options.googleMapsApiKey,window.gm_authFailure=function(){t(),o&&o()},d.on(e.evUpdate,function(o){var t=o.file;if(a&&s[t.mime.toLowerCase()]){e.window;var c,p,l,f="1"==t.url&&!r.option("onetimeUrl",t.hash);o.stopImmediatePropagation(),c=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+r.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),p=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(c),f&&(d.hide(),$('<div class="elfinder-quicklook-info-data"><button class="elfinder-info-button">'+r.i18n("getLink")+"</button></div>").appendTo(e.info.find(".elfinder-quicklook-info")).on("click",function(){var n=$(this);n.html('<span class="elfinder-spinner">'),r.request({data:{cmd:"url",target:t.hash},preventDefault:!0,progressBar:p}).always(function(){c.remove(),n.html("")}).done(function(n){var i=r.file(t.hash);t.url=i.url=n.url||"",t.url&&d.trigger({type:e.evUpdate,file:t,forceUpdate:!0})})})),""===t.url||f||(l=$('<div style="width:100%;height:100%;"/>').appendTo(d),d.one("change",function(){l.remove(),l=null}),n?i(t,l,p):r.loadScript([a],function(){(n=window.google&&google.maps)&&i(t,l,p)}))}}))},function(e){"use strict";var n,i,o=e.fm,t=Object.assign(o.arrayFlip(e.options.googleDocsMimes||[],"g"),o.arrayFlip(e.options.officeOnlineMimes||[],"m")),a=e.preview,r=(e.window,e.navbar),s={g:"docs.google.com/gview?embedded=true&url=",m:"view.officeapps.live.com/op/embed.aspx?wdStartOn=0&src="},d={g:"56px",m:"24px"},c={xls:5242880,xlsb:5242880,xlsx:5242880,xlsm:5242880,other:10485760};e.options.googleDocsMimes.length&&(i=!0,e.addIntegration({title:"Google Docs Viewer",link:"https://docs.google.com/"})),e.options.officeOnlineMimes.length&&(i=!0,e.addIntegration({title:"MS Online Doc Viewer",link:"https://products.office.com/office-online/view-office-documents-online"})),i&&a.on(e.evUpdate,function(i){var p,l,f=i.file;if(f.size<=26214400&&(p=t[f.mime])){var u,m,g,h=e.window,v=function(){r.css("bottom",h.hasClass("elfinder-quicklook-fullscreen")?d[p]:"")},w=o.mimeTypes[f.mime],k="1"==f.url&&!o.option("onetimeUrl",f.hash);"m"===p&&(c[w]&&f.size>c[w]||f.size>c.other)&&(p="g"),k&&(a.hide(),$('<div class="elfinder-quicklook-info-data"><button class="elfinder-info-button">'+o.i18n("getLink")+"</button></div>").appendTo(e.info.find(".elfinder-quicklook-info")).on("click",function(){var n=$(this);n.html('<span class="elfinder-spinner">'),o.request({data:{cmd:"url",target:f.hash},preventDefault:!0}).always(function(){n.html("")}).done(function(n){var i=o.file(f.hash);f.url=i.url=n.url||"",f.url&&a.trigger({type:e.evUpdate,file:f,forceUpdate:!0})})})),""===f.url||k||(i.stopImmediatePropagation(),a.one("change",function(){l&&l.status&&"pending"===l.status()&&l.reject(),h.off("viewchange.googledocs"),u.remove(),n.off("load").remove(),n=null}).addClass("elfinder-overflow-auto"),u=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+o.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),m=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(u),n=$('<iframe class="elfinder-quicklook-preview-iframe"/>').css("background-color","transparent").appendTo(a),l=o.forExternalUrl(f.hash,{progressBar:m}).done(function(i){var o=function(){try{!n||n.attr("src")&&!n.get(0).contentWindow.document||(n.attr("src","https://"+s[p]+encodeURIComponent(i)),g=setTimeout(o,2e3))}catch(e){}};i?(f.ts&&(i+=(i.match(/\?/)?"&":"?")+"_t="+f.ts),n.on("load",function(){g&&clearTimeout(g),e.hideinfo(),u.remove(),e.preview.after(e.info),$(this).css("background-color","#fff").show()}).on("error",function(){g&&clearTimeout(g),u.remove(),e.preview.after(e.info)}),o()):(u.remove(),n.remove())}),h.on("viewchange.googledocs",v),v(),e.info.after(e.preview))}})},function(e){"use strict";var n,i,o=e.fm,t=e.preview,a=parseInt(e.options.textInitialLines)||150,r=parseInt(e.options.prettifyMaxLines)||500,s=function(){d=function(){return!1},i&&(window.PR=i),n=!1},d=function(e){o.options.cdns.prettify?(d=function(e){return setTimeout(function(){p(e)},100),"pending"},window.PR&&(i=window.PR),o.loadScript([o.options.cdns.prettify+(o.options.cdns.prettify.match(/\?/)?"&":"?")+"autorun=false"],function(o){"object"==typeof(n=o||window.PR)?(d=function(){return!0},i?window.PR=i:delete window.PR,c(e)):s()},{tryRequire:!0,error:s})):s()},c=function(e){e&&!e.hasClass("prettyprinted")&&(e.css("cursor","wait"),requestAnimationFrame(function(){n.prettyPrint&&n.prettyPrint(null,e.get(0)),e.css("cursor","")}))},p=function(e){!0===d(e)&&c(e)};t.on(e.evUpdate,function(i){var s,d,c,l,f=i.file;f.mime;o.mimeIsText(f.mime)&&(!e.options.getSizeMax||f.size<=e.options.getSizeMax)&&!1!==n&&(i.stopImmediatePropagation(),d=$('<div class="elfinder-quicklook-info-data"><span class="elfinder-spinner-text">'+o.i18n("nowLoading")+'</span><span class="elfinder-spinner"/></div>').appendTo(e.info.find(".elfinder-quicklook-info")),c=$('<div class="elfinder-quicklook-info-progress"/>').appendTo(d),t.one("change",function(){"pending"==s.state()&&s.reject(),l&&l.remove()}),s=o.request({data:{cmd:"get",target:f.hash,conv:f.encoding||1,_t:f.ts},options:{type:"get",cache:!0},preventDefault:!0,progressBar:c}).done(function(n){var i,s,d,c,l,u=new RegExp("^(data:"+f.mime.replace(/([.+])/g,"\\$1")+";base64,)","i"),m=n.content;"string"==typeof m&&(e.hideinfo(),window.atob&&(l=m.match(u))&&(m=atob(m.substr(l[1].length))),(s=(c=m.match(/([^\r\n]{1,100}[\r\n]*)/g)).length-a)>10?i=c.splice(0,a).join(""):s=0,d=$('<div class="elfinder-quicklook-preview-text-wrapper"><pre class="elfinder-quicklook-preview-text prettyprint"></pre></div>'),s&&d.append($('<div class="elfinder-quicklook-preview-charsleft"><hr/><span>'+o.i18n("linesLeft",o.toLocaleString(s))+"</span></div>").on("click",function(){var e=d.scrollTop();$(this).remove(),d.children("pre").removeClass("prettyprinted").text(m).scrollTop(e),c.length<=r&&p(d)})),d.children("pre").text(i||m),d.on("touchstart",function(e){$(this)["scroll"+("ltr"===o.direction?"Right":"Left")]()>5&&(e.originalEvent._preventSwipeX=!0)}).appendTo(t),n.toasts&&Array.isArray(n.toasts)&&$.each(n.toasts,function(){this.msg&&o.toast(this)}),p(d))}).always(function(n){var i,a,r;(i=o.getCommand("edit"))&&(r=[],n&&n.encoding&&r.push({value:n.encoding}),r.push({value:"UTF-8"}),(a=i.getEncSelect(r)).on("change",function(){f.encoding=a.val(),o.cache(f,"change"),t.trigger({type:e.evUpdate,file:f,forceUpdate:!0})}),l=$('<div class="elfinder-quicklook-encoding"/>').append(a),e.window.append(l)),d.remove()}))})}],e});
//# sourceMappingURL=../sourcemaps/commands/quicklook.plugins.js.map
