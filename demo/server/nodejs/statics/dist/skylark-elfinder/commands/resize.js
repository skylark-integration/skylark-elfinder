/**
 * skylark-elfinder - A version of elfinder that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../elFinder"],function(e){return e.prototype.commands.resize=function(){"use strict";var e=this.fm,t=0;this.updateOnSelect=!1,this.getstate=function(){var t=e.selectedFiles();return 1==t.length&&t[0].read&&t[0].write&&-1!==t[0].mime.indexOf("image/")?0:-1},this.resizeRequest=function(t,i,a){var n,r=i||e.file(t.target);r&&r.tmb;return e.isCommandEnabled("resize",t.target)&&(!r||r&&r.read&&r.write&&-1!==r.mime.indexOf("image/"))?e.request({data:Object.assign(t,{cmd:"resize"}),notify:{type:"resize",cnt:1}}).fail(function(e){a&&a.reject(e)}).done(function(){t.quality&&e.storage("jpgQuality",t.quality===e.option("jpgQuality")?null:t.quality),a&&a.resolve()}):(n=r?-1===r.mime.indexOf("image/")?["errResize",r.name,"errUsupportType"]:["errResize",r.name,"errPerm"]:["errResize",t.target,"errPerm"],a?a.reject(n):e.error(n),$.Deferred().reject(n))},this.exec=function(i){var a,n,r=this,s=this.files(i),o=$.Deferred(),l=e.api>1,d=this.options,c=e.getUI(),h=$().controlgroup?"controlgroup":"buttonset",u=void 0===d.grid8px||"disable"!==d.grid8px,p=Array.isArray(d.presetSize)?d.presetSize:[],f=e.res("class","editing"),g=function(i,a,n){var s,g,v,m,w,b,y,x="image/jpeg"===i.mime,z=$('<div class="elfinder-resize-container"/>'),k='<input type="number" class="ui-corner-all"/>',M='<div class="elfinder-resize-row"/>',C='<div class="elfinder-resize-label"/>',I=null,A=!1,q=function(){A=!0},R=function(){A&&(A=!1,V.trigger("change"))},V=$('<div class="elfinder-resize-control"/>').on("focus","input[type=text],input[type=number]",function(){$(this).trigger("select")}).on("change",function(){I&&cancelAnimationFrame(I),I=requestAnimationFrame(function(){var t,i,a,n,r,s,o,l,d,c,h,u;Ze&&!A&&(a=Ze.data("canvas"))&&(t=V.children("div.elfinder-resize-control-panel:visible"),(i=t.find("input.elfinder-resize-quality")).is(":visible")&&(n=Ze.data("ctx"),r=Ze.get(0),t.hasClass("elfinder-resize-uiresize")?(l=a.width=Q.val(),d=a.height=X.val(),n.drawImage(r,0,0,l,d)):t.hasClass("elfinder-resize-uicrop")?(s=B.val(),o=W.val(),l=Y.val(),d=G.val(),a.width=l,a.height=d,n.drawImage(r,s,o,l,d,0,0,l,d)):(c=J.val(),h=J.val()*Math.PI/180,u=function(e,t,i){var a=[{x:e/2,y:t/2},{x:-e/2,y:t/2},{x:-e/2,y:-t/2},{x:e/2,y:-t/2}],n=[],r={x:Number.MAX_VALUE,y:Number.MAX_VALUE},s={x:Number.MIN_VALUE,y:Number.MIN_VALUE};return $.each(a,function(e,t){n.push({x:t.x*Math.cos(i)-t.y*Math.sin(i),y:t.x*Math.sin(i)+t.y*Math.cos(i)})}),$.each(n,function(e,t){r.x=Math.min(r.x,t.x),r.y=Math.min(r.y,t.y),s.x=Math.max(s.x,t.x),s.y=Math.max(s.y,t.y)}),{width:s.x-r.x,height:s.y-r.y}}(he,ue,h),l=a.width=u.width,d=a.height=u.height,n.save(),c%90!=0&&(n.fillStyle=oe.val()||"#FFF",n.fillRect(0,0,l,d)),n.translate(l/2,d/2),n.rotate(h),n.drawImage(r,-r.width/2,-r.height/2,he,ue),n.restore()),a.toBlob(function(t){t&&i.next("span").text(" ("+e.formatSize(t.size)+")")},"image/jpeg",Math.max(Math.min(i.val(),100),1)/100)))})}).on("mouseup","input",function(e){$(e.target).trigger("change")}),T=$('<div class="elfinder-resize-preview"/>').on("touchmove",function(e){$(e.target).hasClass("touch-punch")&&(e.stopPropagation(),e.preventDefault())}),S=$('<div class="elfinder-resize-loading">'+e.i18n("ntfloadimg")+"</div>"),E=$('<div class="elfinder-resize-handle touch-punch"/>'),F=$('<div class="elfinder-resize-handle touch-punch"/>'),j=$('<div class="elfinder-resize-uiresize elfinder-resize-control-panel"/>'),H=$('<div class="elfinder-resize-uicrop elfinder-resize-control-panel"/>'),P=$('<div class="elfinder-resize-rotate elfinder-resize-control-panel"/>'),D=$("<button/>").attr("title",e.i18n("rotate-cw")).append($('<span class="elfinder-button-icon elfinder-button-icon-rotate-l"/>')),N=$("<button/>").attr("title",e.i18n("rotate-ccw")).append($('<span class="elfinder-button-icon elfinder-button-icon-rotate-r"/>')),O=$("<span />"),U=$('<button class="elfinder-resize-reset">').text(e.i18n("reset")).on("click",function(){Pe()}).button({icons:{primary:"ui-icon-arrowrefresh-1-n"},text:!1}),L=$('<div class="elfinder-resize-type"/>').append('<input type="radio" name="type" id="'+a+'-resize" value="resize" checked="checked" /><label for="'+a+'-resize">'+e.i18n("resize")+"</label>",'<input class="api2" type="radio" name="type" id="'+a+'-crop" value="crop" /><label class="api2" for="'+a+'-crop">'+e.i18n("crop")+"</label>",'<input class="api2" type="radio" name="type" id="'+a+'-rotate" value="rotate" /><label class="api2" for="'+a+'-rotate">'+e.i18n("rotate")+"</label>"),_="resize",Q=(L[h]()[h]("disable").find("input").on("change",function(){_=$(this).val(),Pe(),Ue(!0),Le(!0),_e(!0),"resize"==_?(j.show(),P.hide(),H.hide(),Ue(),x&&ze.insertAfter(j.find(".elfinder-resize-grid8"))):"crop"==_?(P.hide(),j.hide(),H.show(),Le(),x&&ze.insertAfter(H.find(".elfinder-resize-grid8"))):"rotate"==_&&(j.hide(),H.hide(),P.show(),_e())}),$(k).on("change",function(){var e=He(parseInt(Q.val())),t=He(pe?e/de:parseInt(X.val()));e>0&&t>0&&(De.updateView(e,t),Q.val(e),X.val(t))}).addClass("elfinder-focus")),X=$(k).on("change",function(){var e=He(parseInt(X.val())),t=He(pe?e*de:parseInt(Q.val()));t>0&&e>0&&(De.updateView(t,e),Q.val(t),X.val(e))}),B=$(k).on("change",function(){Ne.updateView()}),W=$(k).on("change",function(){Ne.updateView()}),Y=$(k).on("change",function(){Ne.updateView("w")}),G=$(k).on("change",function(){Ne.updateView("h")}),K=x&&l?$(k).val(e.storage("jpgQuality")>0?e.storage("jpgQuality"):e.option("jpgQuality")).addClass("elfinder-resize-quality").attr("min","1").attr("max","100").attr("title","1 - 100").on("blur",function(){var e=Math.min(100,Math.max(1,parseInt(this.value)));V.find("input.elfinder-resize-quality").val(e)}):null,J=$('<input type="number" class="ui-corner-all" maxlength="3" value="0" />').on("change",function(){Oe.update()}),Z=$('<div class="elfinder-resize-rotate-slider touch-punch"/>').slider({min:0,max:360,value:J.val(),animate:!0,start:q,stop:R,change:function(e,t){t.value!=Z.slider("value")&&Oe.update(t.value)},slide:function(e,t){Oe.update(t.value,!1)}}).find(".ui-slider-handle").addClass("elfinder-tabstop").off("keydown").on("keydown",function(e){e.keyCode!=$.ui.keyCode.LEFT&&e.keyCode!=$.ui.keyCode.RIGHT||(e.stopPropagation(),e.preventDefault(),Oe.update(Number(J.val())+(e.keyCode==$.ui.keyCode.RIGHT?1:-1),!1))}).end(),ee={},te=function(e){var t,i,a,n;try{t=ee[Math.round(e.offsetX)][Math.round(e.offsetY)]}catch(e){}t&&(i=t[0],a=t[1],n=t[2],t[3],t[4],t[5],ae(i,a,n,"click"===e.type))},ie=function(e){ae($(this).css("backgroundColor"),"","","click"===e.type)},ae=function(e,t,i,a){var n,r,s;"string"==typeof e&&(t="",e&&(n=$("<span>").css("backgroundColor",e).css("backgroundColor"))&&(r=n.match(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i))&&(e=Number(r[1]),t=Number(r[2]),i=Number(r[3]))),s=""===t?e:"#"+ne(e,t,i),oe.val(s).css({backgroundColor:s,backgroundImage:"none",color:e+t+i<384?"#fff":"#000"}),T.css("backgroundColor",s),a&&(je.off(".picker").removeClass("elfinder-resize-picking"),le.off(".picker").removeClass("elfinder-resize-picking"))},ne=function(e,t,i){return $.map([e,t,i],function(e){return("0"+parseInt(e).toString(16)).slice(-2)}).join("")},re=$("<button>").text(e.i18n("colorPicker")).on("click",function(){je.on("mousemove.picker click.picker",te).addClass("elfinder-resize-picking"),le.on("mousemove.picker click.picker","span",ie).addClass("elfinder-resize-picking")}).button({icons:{primary:"ui-icon-pin-s"},text:!1}),se=$("<button>").text(e.i18n("reset")).on("click",function(){ae("","","",!0)}).button({icons:{primary:"ui-icon-arrowrefresh-1-n"},text:!1}),oe=$('<input class="ui-corner-all elfinder-resize-bg" type="text">').on("focus",function(){$(this).attr("style","")}).on("blur",function(){ae($(this).val())}),le=$('<div class="elfinder-resize-pallet">').on("click","span",function(){ae($(this).css("backgroundColor"))}),de=1,ce=1,he=0,ue=0,pe=!0,fe=!1,ge=0,ve=0,me=0,we=0,be=0,ye=!!x&&u,$e=$("<button>").html(e.i18n("aspectRatio")).on("click",function(){pe=!pe,$e.button("option",{icons:{primary:pe?"ui-icon-locked":"ui-icon-unlocked"}}),De.fixHeight(),E.resizable("option","aspectRatio",pe).data("uiResizable")._aspectRatio=pe}).button({icons:{primary:pe?"ui-icon-locked":"ui-icon-unlocked"},text:!1}),xe=$("<button>").html(e.i18n("aspectRatio")).on("click",function(){fe=!fe,xe.button("option",{icons:{primary:fe?"ui-icon-locked":"ui-icon-unlocked"}}),F.resizable("option","aspectRatio",fe).data("uiResizable")._aspectRatio=fe}).button({icons:{primary:fe?"ui-icon-locked":"ui-icon-unlocked"},text:!1}),ze=$("<button>").html(e.i18n(ye?"enabled":"disabled")).toggleClass("ui-state-active",ye).on("click",function(){ye=!ye,ze.html(e.i18n(ye?"enabled":"disabled")).toggleClass("ui-state-active",ye),ke()}).button(),ke=function(){var e=ye?8:1;$.each([Q,X,Y,G,B,W],function(){this.attr("step",e)}),ye&&(Q.val(He(Q.val())),X.val(He(X.val())),Y.val(He(Y.val())),G.val(He(G.val())),B.val(He(B.val())),W.val(He(W.val())),j.is(":visible")?De.updateView(Q.val(),X.val()):H.is(":visible")&&Ne.updateView())},Me=function(){var t,a=function(){oe.parent().hide(),le.hide()};t=Math.min(ge,ve)/Math.sqrt(Math.pow(he,2)+Math.pow(ue,2)),me=Math.ceil(he*t),we=Math.ceil(ue*t),je.width(me).height(we).css("margin-top",(ve-we)/2+"px").css("margin-left",(ge-me)/2+"px"),je.is(":visible")&&oe.is(":visible")&&("image/png"!==i.mime?(T.css("backgroundColor",oe.val()),s=$("<img>"),e.isCORS&&s.attr("crossorigin","use-credentials"),s.on("load",function(){g&&g.width!==me&&Ie()}).on("error",a).attr("src",Je)):a())},Ce=function(){De.updateView(he,ue),Me(),Se.width(Te.width()).height(Te.height()),Ee.width(Te.width()).height(Te.height()),Ne.updateView(),et()},Ie=function(){if(v){var e,t,i,a,n,r,o,l,d,c,h,u,p,f,m,w,b,y,x={},z=[],k=function(e,t,i){var a,n=Math.max(Math.max(e,t),i),r=Math.min(Math.min(e,t),i);return n===r?a=0:e===n?a=((t-i)/(n-r)*60+360)%360:t===n?a=(i-e)/(n-r)*60+120:i===n&&(a=(e-t)/(n-r)*60+240),[a,(n-r)/n,(.3*e+.59*t+.11*i)/255,"hsl"]},M=function(e){return 8*Math.round(e/8)};e:try{t=g.width=je.width(),i=g.height=je.height(),u=t/he,v.scale(u,u),v.drawImage(s.get(0),0,0),h=v.getImageData(0,0,t,i).data,p=.1*t,f=.9*t,m=.1*i,w=.9*i;for(var C=0;C<i-1;C++)for(var I=0;I<t-1;I++){if(a=h[e=4*I+C*t*4],n=h[e+1],r=h[e+2],255!==h[e+3]){oe.parent().hide(),le.hide();break e}d=k(a,n,r),c=Math.round(d[0]),o=Math.round(100*d[1]),l=Math.round(100*d[2]),ee[I]||(ee[I]={}),ee[I][C]=[a,n,r,c,o,l],(I<p||I>f)&&(C<m||C>w)&&(x[b=M(a)+","+M(n)+","+M(r)]?++x[b]:x[b]=1)}le.children(":first").length||(y=1,$.each(x,function(e,t){z.push({c:e,v:t})}),$.each(z.sort(function(e,t){return e.v>t.v?-1:1}),function(){if(this.v<2||y>10)return!1;le.append($('<span style="width:20px;height:20px;display:inline-block;background-color:rgb('+this.c+');">')),++y}))}catch(e){re.hide(),le.hide()}}},Ae=null,qe=!1,Re=function(t){var a=e.file(i.hash);a.width=t[0],a.height=t[1]},Ve=function(){var a,n,r;qe||(qe=!0,Ae&&Ae.state&&"pending"===Ae.state()&&Ae.reject(),e.api>=2.103?0===t&&e.request({data:{cmd:"resize",target:i.hash,degree:0,mode:"rotate"},preventDefault:!0}).done(function(e){1===(t=e.losslessRotate?1:-1)&&J.val()%90==0&&P.children("div.elfinder-resize-quality").hide()}).fail(function(){t=-1}):t=-1,a=Te.get(0),(n=i.width&&i.height?{w:i.width,h:i.height}:a.naturalWidth?null:{w:Te.width(),h:Te.height()})&&Te.removeAttr("width").removeAttr("height"),he=i.width||a.naturalWidth||a.width||Te.width(),ue=i.height||a.naturalHeight||a.height||Te.height(),i.width&&i.height||Re([he,ue]),n&&Te.width(n.w).height(n.h),m.show(),(r=ue/he)<1&&T.height()>T.width()*r&&T.height(T.width()*r),T.height()>Te.height()+20&&T.height(Te.height()+20),ve=T.height()-(E.outerHeight()-E.height()),S.remove(),de=he/ue,E.append(Te.show()).show(),Q.val(he),X.val(ue),function(){try{g=document.createElement("canvas"),v=g.getContext("2d")}catch(e){re.hide(),le.hide()}}(),it.on("click","span.elfinder-resize-preset",function(){var e=$(this),t=e.data("s")[0],i=e.data("s")[1],a=he/ue;e.data("s",[i,t]).text(i+"x"+t),he>t||ue>i?he<=t?t=He(i*a):ue<=i?i=He(t/a):he-t>ue-i?i=He(t/a):t=He(i*a):(t=he,i=ue),Q.val(t),X.val(i),De.updateView(t,i),et()}),at.on("click","span.elfinder-resize-preset",function(){var e=$(this),t=e.data("s")[0],i=e.data("s")[1],a=B.val(),n=W.val();e.data("s",[i,t]).text(i+"x"+t),he>=t&&ue>=i&&(he-t-a<0&&(a=he-t),ue-i-n<0&&(n=ue-i),B.val(a),W.val(n),Y.val(t),G.val(i),Ne.updateView(),et())}),at.children("span.elfinder-resize-preset").each(function(){var e=$(this),t=e.data("s")[0],i=e.data("s")[1];e[he>=t&&ue>=i?"show":"hide"]()}),Ce(),L[h]("enable"),V.find("input,select").prop("disabled",!1).filter(":text").on("keydown",function(t){var i;if(t.keyCode==$.ui.keyCode.ENTER)return t.stopPropagation(),t.preventDefault(),i={title:$("input:checked",L).val(),text:"confirmReq",accept:{label:"btnApply",callback:function(){Xe()}},cancel:{label:"btnCancel",callback:function(){$(this).trigger("focus")}}},nt&&(i.buttons=[{label:"btnSaveAs",callback:function(){requestAnimationFrame(Be)}}]),void e.confirm(i)}).on("keyup",function(){var e=$(this);e.hasClass("elfinder-resize-bg")||requestAnimationFrame(function(){e.val(e.val().replace(/[^0-9]/g,""))})}).filter(":first"),ke(),!e.UA.Mobile&&Q.trigger("focus"),Ue())},Te=$("<img/>").on("load",Ve).on("error",function(){S.html(e.i18n("ntfsmth")).css("background","transparent")}),Se=$("<div/>"),Ee=$("<img/>"),Fe=$("<div/>"),je=$('<img class="elfinder-resize-imgrotate" />'),He=function(e,t){return e=ye?8*Math.round(e/8):Math.round(e),e=Math.max(0,e),t&&e>t&&(e=ye?8*Math.floor(t/8):t),e},Pe=function(){Q.val(he),X.val(ue),De.updateView(he,ue),B.val(0),W.val(0),Y.val(he),G.val(ue),Ne.updateView(),et()},De={update:function(){Q.val(He(Te.width()/ce)),X.val(He(Te.height()/ce)),et()},updateView:function(e,t){e>ge||t>ve?e/ge>t/ve?(ce=ge/e,Te.width(ge).height(He(t*ce))):(ce=ve/t,Te.height(ve).width(He(e*ce))):Te.width(He(e)).height(He(t)),ce=Te.width()/e,O.text("1 : "+(1/ce).toFixed(2)),De.updateHandle()},updateHandle:function(){E.width(Te.width()).height(Te.height())},fixHeight:function(){var e,t;pe&&(e=Q.val(),t=He(e/de),De.updateView(e,t),X.val(t))}},Ne={update:function(e){B.val(He((F.data("x")||F.position().left)/ce,he)),W.val(He((F.data("y")||F.position().top)/ce,ue)),"xy"!==e&&(Y.val(He((F.data("w")||F.width())/ce,he-B.val())),G.val(He((F.data("h")||F.height())/ce,ue-W.val()))),et()},updateView:function(e){var t,i,a,n,r;B.val(He(B.val(),he-(ye?8:1))),W.val(He(W.val(),ue-(ye?8:1))),Y.val(He(Y.val(),he-B.val())),G.val(He(G.val(),ue-W.val())),fe&&(t=Fe.width()/Fe.height(),"w"===e?G.val(He(parseInt(Y.val())/t)):"h"===e&&Y.val(He(parseInt(G.val())*t))),i=Math.round(parseInt(B.val())*ce),a=Math.round(parseInt(W.val())*ce),"xy"!==e?(n=Math.round(parseInt(Y.val())*ce),r=Math.round(parseInt(G.val())*ce)):(n=F.data("w"),r=F.data("h")),F.data({x:i,y:a,w:n,h:r}).width(n).height(r).css({left:i,top:a}),Fe.width(n).height(r)},resize_update:function(e,t){F.data({x:t.position.left,y:t.position.top,w:t.size.width,h:t.size.height}),Ne.update(),Ne.updateView()},drag_update:function(e,t){F.data({x:t.position.left,y:t.position.top}),Ne.update("xy")}},Oe={mouseStartAngle:0,imageStartAngle:0,imageBeingRotated:!1,setQuality:function(){P.children("div.elfinder-resize-quality")[t>0&&J.val()%90==0?"hide":"show"]()},update:function(t,i){void 0===t&&(be=t=parseInt(J.val())),void 0===i&&(i=!0),!i||e.UA.Opera||e.UA.ltIE8?je.rotate(t):je.animate({rotate:t+"deg"}),(t%=360)<0&&(t+=360),J.val(parseInt(t)),Z.slider("value",J.val()),Oe.setQuality()},execute:function(e){if(Oe.imageBeingRotated){var t=Oe.getCenter(je),i=e.originalEvent.touches?e.originalEvent.touches[0]:e,a=i.pageX-t[0],n=i.pageY-t[1],r=Math.atan2(n,a)-Oe.mouseStartAngle+Oe.imageStartAngle;return r=Math.round(180*parseFloat(r)/Math.PI),e.shiftKey&&(r=15*Math.round((r+6)/15)),je.rotate(r),(r%=360)<0&&(r+=360),J.val(r),Z.slider("value",J.val()),Oe.setQuality(),!1}},start:function(e){if(!je.hasClass("elfinder-resize-picking")){q(),Oe.imageBeingRotated=!0;var t=Oe.getCenter(je),i=e.originalEvent.touches?e.originalEvent.touches[0]:e,a=i.pageX-t[0],n=i.pageY-t[1];return Oe.mouseStartAngle=Math.atan2(n,a),Oe.imageStartAngle=parseFloat(je.rotate())*Math.PI/180,$(document).on("mousemove",Oe.execute),je.on("touchmove",Oe.execute),!1}},stop:function(e){if(Oe.imageBeingRotated)return $(document).off("mousemove",Oe.execute),je.off("touchmove",Oe.execute),requestAnimationFrame(function(){Oe.imageBeingRotated=!1}),R(),!1},getCenter:function(e){var t=je.rotate();je.rotate(0);var i=je.offset(),a=i.left+je.width()/2,n=i.top+je.height()/2;return je.rotate(t),Array(a,n)}},Ue=function(e){e?(E.filter(":ui-resizable").resizable("destroy"),E.hide()):(E.show(),E.resizable({alsoResize:Te,aspectRatio:pe,resize:De.update,start:q,stop:function(e){De.fixHeight,De.updateView(Q.val(),X.val()),R()}}),tt())},Le=function(e){e?(F.filter(":ui-resizable").resizable("destroy").filter(":ui-draggable").draggable("destroy"),Se.hide()):(Se.show(),F.resizable({containment:Se,aspectRatio:fe,resize:Ne.resize_update,start:q,stop:R,handles:"all"}).draggable({handle:Fe,containment:Ee,drag:Ne.drag_update,start:q,stop:function(){Ne.updateView("xy"),R()}}),tt(),Ne.update())},_e=function(e){e?je.hide():(je.show(),tt())},Qe=function(){var t,i,a,n,r,s,o="";if("resize"==_)t=parseInt(Q.val())||0,i=parseInt(X.val())||0;else if("crop"==_)t=parseInt(Y.val())||0,i=parseInt(G.val())||0,a=parseInt(B.val())||0,n=parseInt(W.val())||0;else if("rotate"==_){if(t=he,i=ue,(r=parseInt(J.val())||0)<0||r>360)return e.error("Invalid rotate degree"),!1;if(0==r||360==r)return e.error("errResizeNoChange"),!1;o=oe.val()}if(s=K?parseInt(K.val()):0,"rotate"!=_){if(t<=0||i<=0)return e.error("Invalid image size"),!1;if(t==he&&i==ue)return e.error("errResizeNoChange"),!1}return{w:t,h:i,x:a,y:n,d:r,q:s,b:o}},Xe=function(){var e;(e=Qe())&&(z.elfinderdialog("close"),r.resizeRequest({target:i.hash,width:e.w,height:e.h,x:e.x,y:e.y,degree:e.d,quality:e.q,bg:e.b,mode:_},i,o))},Be=function(){var t,a=function(){t.addClass(f).fadeIn(function(){w.addClass("elfinder-dialog-active")}),e.disable()},n=function(){r.mime=i.mime,r.prefix=i.name.replace(/ \d+(\.[^.]+)?$/,"$1"),r.requestCmd="mkfile",r.nextAction={},r.data={target:i.phash},$.proxy(e.res("mixin","make"),r)().done(function(n){var r,s;n.added&&n.added.length?(r=n.added[0].hash,s=e.api<2.1032?e.url(i.hash,{async:!0,temporary:!0}):null,$.when(s).done(function(n){e.request({options:{type:"post"},data:{cmd:"put",target:r,encoding:s?"scheme":"hash",content:s?e.convAbsUrl(n):i.hash},notify:{type:"copy",cnt:1},syncOnFail:!0}).fail(a).done(function(a){a=e.normalize(a),e.updateCache(a),i=e.file(r),a.changed&&a.changed.length&&e.change(a),w.show().find(".elfinder-dialog-title").html(e.escape(i.name)),Xe(),t.fadeIn()})}).fail(a)):a()}).fail(a).always(function(){delete r.mime,delete r.prefix,delete r.nextAction,delete r.data}),e.trigger("unselectfiles",{files:[i.hash]})},s=null;Qe()&&(t=c.children("."+r.dialogClass+":visible").removeClass(f).fadeOut(),w.removeClass("elfinder-dialog-active"),e.enable(),e.searchStatus.state<2&&i.phash!==e.cwd().hash&&(s=e.exec("open",[i.phash],{thash:i.phash})),$.when([s]).done(function(){s?e.one("cwdrender",n):n()}).fail(a))},We={},Ye="elfinder-resize-handle-hline",Ge="elfinder-resize-handle-vline",Ke="elfinder-resize-handle-point",Je=n,Ze=K?$("<img>").attr("crossorigin",e.isCORS?"use-credentials":"").attr("src",Je).on("load",function(){try{var e=document.createElement("canvas");Ze.data("canvas",e).data("ctx",e.getContext("2d")),et()}catch(e){Ze.removeData("canvas").removeData("ctx")}}):null,et=function(){V.find("input.elfinder-resize-quality:visible").trigger("change")},tt=function(t){if(!w.hasClass("elfinder-dialog-minimized")&&!w.is(":hidden")){it.hide(),at.hide();var i,a,n,r=e.options.dialogContained?c:$(window),s=r.height(),o=r.width(),l="auto",d=!0;w.width(Math.min(650,o-30)),T.attr("style",""),he&&ue&&(ge=T.width()-(E.outerWidth()-E.width()),ve=T.height()-(E.outerHeight()-E.height()),De.updateView(he,ue)),a=z.find("div.elfinder-resize-control").width(),(n=T.width())>(i=z.width()-20)?(T.width(i),d=!1):i-n<a&&(o>s?T.width(i-a-20):(T.css({float:"none",marginLeft:"auto",marginRight:"auto"}),d=!1)),d&&(l=a),ge=T.width()-(E.outerWidth()-E.width()),c.hasClass("elfinder-fullscreen")?w.height()>s&&(s-=2,T.height(s-w.height()+T.height()),w.css("top",0-c.offset().top)):(s-=30,T.height()>s&&T.height(s)),ve=T.height()-(E.outerHeight()-E.height()),he&&ue&&Ce(),Te.height()&&T.height()>Te.height()+20&&(T.height(Te.height()+20),ve=T.height()-(E.outerHeight()-E.height()),Me()),it.css("width",l).show(),at.css("width",l).show(),at.children("span.elfinder-resize-preset:visible").length||at.hide(),z.elfinderdialog("posInit")}},it=(y=$('<fieldset class="elfinder-resize-preset-container">').append($("<legend>").html(e.i18n("presets"))).css("box-sizing","border-box").hide(),$.each(p,function(e,t){2===t.length&&(b=!0,y.append($('<span class="elfinder-resize-preset"/>').data("s",t).text(t[0]+"x"+t[1]).button()))}),b?y:$()),at=it.clone(!0),nt=e.uploadMimeCheck(i.mime,i.phash);j.append($(M).append($(C).text(e.i18n("width")),Q),$(M).append($(C).text(e.i18n("height")),X,$('<div class="elfinder-resize-whctrls">').append($e,U)),K?$(M).append($(C).text(e.i18n("quality")),K,$("<span/>")):$(),x?$(M).append($(C).text(e.i18n("8pxgrid")).addClass("elfinder-resize-grid8"),ze):$(),$(M).append($(C).text(e.i18n("scale")),O),$(M).append(it)),l&&(H.append($(M).append($(C).text("X"),B),$(M).append($(C).text("Y")).append(W),$(M).append($(C).text(e.i18n("width")),Y),$(M).append($(C).text(e.i18n("height")),G,$('<div class="elfinder-resize-whctrls">').append(xe,U.clone(!0))),K?$(M).append($(C).text(e.i18n("quality")),K.clone(!0),$("<span/>")):$(),x?$(M).append($(C).text(e.i18n("8pxgrid")).addClass("elfinder-resize-grid8")):$(),$(M).append(at)),P.append($(M).addClass("elfinder-resize-degree").append($(C).text(e.i18n("rotate")),J,$("<span/>").text(e.i18n("degree")),$("<div/>").append(D,N)[h]()),$(M).css("height","20px").append(Z),K?$(M)[t<1?"show":"hide"]().addClass("elfinder-resize-quality").append($(C).text(e.i18n("quality")),K.clone(!0),$("<span/>")):$(),$(M).append($(C).text(e.i18n("bgcolor")),oe,re,se),$(M).css("height","20px").append(le)),D.on("click",function(){be-=90,Oe.update(be)}),N.on("click",function(){be+=90,Oe.update(be)})),z.append(L).on("resize",function(e){e.stopPropagation()}),l?V.append(j,H.hide(),P.hide()):V.append(j),E.append('<div class="'+Ye+" "+Ye+'-top"/>','<div class="'+Ye+" "+Ye+'-bottom"/>','<div class="'+Ge+" "+Ge+'-left"/>','<div class="'+Ge+" "+Ge+'-right"/>','<div class="'+Ke+" "+Ke+'-e"/>','<div class="'+Ke+" "+Ke+'-se"/>','<div class="'+Ke+" "+Ke+'-s"/>'),T.append(S).append(E.hide()).append(Te.hide()),l&&(F.css("position","absolute").append('<div class="'+Ye+" "+Ye+'-top"/>','<div class="'+Ye+" "+Ye+'-bottom"/>','<div class="'+Ge+" "+Ge+'-left"/>','<div class="'+Ge+" "+Ge+'-right"/>','<div class="'+Ke+" "+Ke+'-n"/>','<div class="'+Ke+" "+Ke+'-e"/>','<div class="'+Ke+" "+Ke+'-s"/>','<div class="'+Ke+" "+Ke+'-w"/>','<div class="'+Ke+" "+Ke+'-ne"/>','<div class="'+Ke+" "+Ke+'-se"/>','<div class="'+Ke+" "+Ke+'-sw"/>','<div class="'+Ke+" "+Ke+'-nw"/>'),T.append(Se.css("position","absolute").hide().append(Ee,F.append(Fe))),T.append(je.hide())),T.css("overflow","hidden"),z.append(T,V),We[e.i18n("btnApply")]=Xe,nt&&(We[e.i18n("btnSaveAs")]=function(){requestAnimationFrame(Be)}),We[e.i18n("btnCancel")]=function(){z.elfinderdialog("close")},z.find("input,button").addClass("elfinder-tabstop"),w=r.fmDialog(z,{title:e.escape(i.name),width:650,resizable:!1,buttons:We,open:function(){var t=function(t){Ae=e.request({data:{cmd:"dim",target:i.hash,substitute:r?400:""},preventDefault:!0}).done(function(t){if(!t.url&&a)z.elfinderdialog("close"),e.error(["errOpen",i.name]);else if(t.dim){var n=t.dim.split("x");return i.width=n[0],i.height=n[1],Re(n),t.url&&(Te.attr("src",t.url),Ee.attr("src",t.url),je.attr("src",t.url)),Ve()}})},a=!{"image/jpeg":!0,"image/png":!0,"image/gif":!0}[i.mime],r=!(!e.option("substituteImg",i.hash)||!(a||i.size>d.dimSubImgSize)),s=!(!i.width||!i.height);if(m=w.find(".ui-dialog-titlebar .elfinder-titlebar-minimize").hide(),e.bind("resize",tt),Te.attr("src",n).one("error.dimreq",function(){t()}),Ee.attr("src",n),je.attr("src",n),l&&(je.on("mousedown touchstart",Oe.start).on("touchend",Oe.stop),w.on("mouseup",Oe.stop)),s&&!r)return Ve();if(i.size>(d.getDimThreshold||0))Te.off("error.dimreq"),t();else if(s)return Ve()},close:function(){l&&(je.off("mousedown touchstart",Oe.start).off("touchend",Oe.stop),$(document).off("mouseup",Oe.stop)),e.unbind("resize",tt),$(this).elfinderdialog("destroy")},resize:function(e,t){t&&"off"===t.minimize&&tt()}}).attr("id",a).closest(".ui-dialog").addClass(f),e.UA.ltIE8&&$(".elfinder-dialog").css("filter",""),Fe.css({opacity:.2,"background-color":"#fff",position:"absolute"}),F.css("cursor","move"),F.find(".elfinder-resize-handle-point").css({"background-color":"#fff",opacity:.5,"border-color":"#000"}),l||L.find(".api2").remove(),V.find("input,select").prop("disabled",!0),V.find("input.elfinder-resize-quality").next("span").addClass("elfinder-resize-jpgsize").attr("title",e.i18n("roughFileSize"))};return s.length&&-1!==s[0].mime.indexOf("image/")?(a="resize-"+e.namespace+"-"+s[0].hash,(n=c.find("#"+a)).length?(n.elfinderdialog("toTop"),o.resolve()):(e.openUrl(s[0].hash,"sameorigin",function(e){g(s[0],a,e)}),o)):o.reject()}},function(e){var t=function(e,t){var i=0;for(i in t)if(void 0!==e[t[i]])return t[i];return e[t[i]]="",t[i]};if(e.cssHooks.rotate={get:function(t,i,a){return e(t).rotate()},set:function(t,i){return e(t).rotate(i),i}},e.cssHooks.transform={get:function(e,i,a){var n=t(e.style,["WebkitTransform","MozTransform","OTransform","msTransform","transform"]);return e.style[n]},set:function(e,i){var a=t(e.style,["WebkitTransform","MozTransform","OTransform","msTransform","transform"]);return e.style[a]=i,i}},e.fn.rotate=function(e){var t;return void 0===e?window.opera?(t=this.css("transform").match(/rotate\((.*?)\)/))&&t[1]?Math.round(180*parseFloat(t[1])/Math.PI):0:(t=this.css("transform").match(/rotate\((.*?)\)/))&&t[1]?parseInt(t[1]):0:(this.css("transform",this.css("transform").replace(/none|rotate\(.*?\)/,"")+"rotate("+parseInt(e)+"deg)"),this)},e.fx.step.rotate=function(t){0==t.state&&(t.start=e(t.elem).rotate(),t.now=t.start),e(t.elem).rotate(t.now)},void 0===window.addEventListener&&void 0===document.getElementsByClassName){var i=function(e){if("static"==e.currentStyle.position){var t=function(e){for(var t=e,i=t.offsetLeft,a=t.offsetTop;t.offsetParent&&((t=t.offsetParent)==document.body||"static"==t.currentStyle.position);)t!=document.body&&t!=document.documentElement&&(i-=t.scrollLeft,a-=t.scrollTop),i+=t.offsetLeft,a+=t.offsetTop;return{x:i,y:a}}(e);e.style.position="absolute",e.style.left=t.x+"px",e.style.top=t.y+"px"}},a=e.cssHooks.transform.set;e.cssHooks.transform.set=function(e,t){return a.apply(this,[e,t]),function(e,t){var a,n=1,r=1,s=1,o=1;if(void 0!==e.style.msTransform)return!0;i(e);var l=(a=t.match(/rotate\((.*?)\)/))&&a[1]?parseInt(a[1]):0;(l%=360)<0&&(l=360+l);var d=l*Math.PI/180,c=Math.cos(d),h=Math.sin(d);n*=c,r*=-h,s*=h,o*=c,e.style.filter=(e.style.filter||"").replace(/progid:DXImageTransform\.Microsoft\.Matrix\([^)]*\)/,"")+"progid:DXImageTransform.Microsoft.Matrix(M11="+n+",M12="+r+",M21="+s+",M22="+o+",FilterType='bilinear',sizingMethod='auto expand')";var u=parseInt(e.style.width||e.width||0),p=parseInt(e.style.height||e.height||0);d=l*Math.PI/180;var f=Math.abs(Math.cos(d)),g=Math.abs(Math.sin(d)),v=(u-(u*f+p*g))/2,m=(p-(u*g+p*f))/2;e.style.marginLeft=Math.floor(v)+"px",e.style.marginTop=Math.floor(m)+"px"}(e,t),t}}}(jQuery),e});
//# sourceMappingURL=../sourcemaps/commands/resize.js.map
