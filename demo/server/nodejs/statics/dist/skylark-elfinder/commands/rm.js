/**
 * skylark-elfinder - A version of elfinder that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../elFinder"],function(e){return e.prototype.commands.rm=function(){"use strict";var e=this,n=this.fm,t='<div class="ui-helper-clearfix elfinder-rm-title"><span class="elfinder-cwd-icon {class} ui-corner-all"/>{title}<div class="elfinder-rm-desc">{desc}</div></div>',r=function(e,t,r){var i=r?{}:{type:"rm",cnt:t.length};n.request({data:{cmd:"rm",targets:t},notify:i,preventFail:!0}).fail(function(n){e.reject(n)}).done(function(n){(n.error||n.warning)&&(n.sync=!0),e.resolve(n)}).always(function(){n.unlockfiles({files:t})})},i=function(e){var t,r=null;return e&&e.length&&(e.length>1&&2===n.searchStatus.state?(t=n.file(n.root(e[0])).volumeid,$.grep(e,function(e){return 0!==e.indexOf(t)}).length||(r=n.option("trashHash",e[0]))):r=n.option("trashHash",e[0])),r},a=!1;this.confirm=function(i,o,c,s,l){var d,u,f,h,m,p,g=o.length,v=n.cwd().hash,y=[],k=n.i18n("calc")+'<span class="elfinder-spinner"/>';g>1?(h=0,$.each(c,function(e,n){if(!n.size||"unknown"==n.size||"directory"===n.mime)return h="unknown",!1;var t=parseInt(n.size);t>=0&&h>=0&&(h+=t)}),a="unknown"===h,y.push(n.i18n("size")+": "+(a?k:n.formatSize(h))),u=[$(t.replace("{class}","elfinder-cwd-icon-group").replace("{title}","<strong>"+n.i18n("items")+": "+g+"</strong>").replace("{desc}",y.join("<br>")))]):(m=c[0],f=n.tmb(m),a="directory"===m.mime,y.push(n.i18n("size")+": "+(a?k:n.formatSize(m.size))),y.push(n.i18n("modify")+": "+n.formatDate(m)),p=n.escape(m.i18||m.name).replace(/([_.])/g,"&#8203;$1"),u=[$(t.replace("{class}",n.mime2class(m.mime)).replace("{title}","<strong>"+p+"</strong>").replace("{desc}",y.join("<br>")))]),l&&(u=u.concat(l)),u.push(s?"confirmTrash":"confirmRm"),d=n.confirm({title:e.title,text:u,accept:{label:"btnRm",callback:function(){s?e.toTrash(i,o,s):r(i,o)}},cancel:{label:"btnCancel",callback:function(){n.unlockfiles({files:o}),1===o.length&&n.file(o[0]).phash!==v?n.select({selected:o}):n.selectfiles({files:o}),i.reject()}}}),f&&$("<img/>").on("load",function(){d.find(".elfinder-cwd-icon").addClass(f.className).css("background-image","url('"+f.url+"')")}).attr("src",f.url),a&&(a=n.getSize($.map(c,function(e){return"directory"===e.mime?e.hash:null})).done(function(e){d.find("span.elfinder-spinner").parent().html(n.i18n("size")+": "+e.formated)}).fail(function(){d.find("span.elfinder-spinner").parent().html(n.i18n("size")+": "+n.i18n("unknown"))}).always(function(){a=!1}))},this.toTrash=function(t,r,i){var a,o,c,s={},l=r.length,d=e.options.toTrashMaxItems,u=[],f=$.Deferred();l>d?e.confirm(t,r,e.files(r),null,[n.i18n("tooManyToTrash")]):($.each(r,function(e,t){var r=n.file(t),i=n.path(t).replace(/\\/g,"/").match(/^[^\/]+?(\/(?:[^\/]+?\/)*)[^\/]+?$/);r&&(i&&(i[1]=i[1].replace(/(^\/.*?)\/?$/,"$1"),s[i[1]]||(s[i[1]]=[]),s[i[1]].push(t)),"directory"===r.mime&&u.push(t))}),u.length?(a=n.request({data:{cmd:"size",targets:u},notify:{type:"readdir",cnt:1,hideCnt:!0},preventDefault:!0}).done(function(e){var n=0;e.fileCnt&&(n+=parseInt(e.fileCnt)),e.dirCnt&&(n+=parseInt(e.dirCnt)),f[n>d?"reject":"resolve"]()}).fail(function(){f.reject()}),setTimeout(function(){var e=a&&a.xhr?a.xhr:null;e&&"pending"==e.state()&&(a.syncOnFail(!1),a.reject(),f.reject())},1e3*e.options.infoCheckWait)):f.resolve(),f.done(function(){o=Object.keys(s),(c=o.length)?n.request({data:{cmd:"mkdir",target:i,dirs:o},notify:{type:"chkdir",cnt:c},preventFail:!0}).fail(function(e){t.reject(e),n.unlockfiles({files:r})}).done(function(e){var i,a,o,l,d=["errTrash"],u={},f=function(){return n.ui.notify.children(".elfinder-notify-trash").length};(i=e.hashes)?(o=1/c*100,l=1===c?100:5,a=setTimeout(function(){n.notify({type:"trash",cnt:1,hideCnt:!0,progress:l})},n.notifyDelay),$.each(s,function(e,s){var h;n.file(s[0]).phash,i[e]&&(h={cmd:"paste",dst:i[e],targets:s,cut:1},n.request({data:h,preventDefault:!0}).fail(function(e){e&&(d=d.concat(e))}).done(function(e){e=n.normalize(e),n.updateCache(e),function(e,t,i){var a,o,c,s;$.each(e,function(e,n){Array.isArray(n)&&(u[e]?u[e]=u[e].concat(n):u[e]=n)}),e.sync&&(u.sync=1),e.added&&e.added.length&&(a=function(){var t=[],r=$.map(e.added,function(e){return"directory"===e.mime?e.hash:null});return $.each(e.added,function(e,n){-1===$.inArray(n.phash,r)&&t.push(n.hash)}),n.exec("restore",t,{noToast:!0})},c=function(){return n.request({data:i,notify:{type:"redo",cnt:r.length}})},u.undo?(o=u.undo,u.undo=function(){a(),o()}):u.undo=a,u.redo?(s=u.redo,u.redo=function(){c(),s()}):u.redo=c)}(e,0,h),e.warning&&(d=d.concat(e.warning),delete e.warning),e.removed&&e.removed.length&&n.remove(e),e.added&&e.added.length&&n.add(e),e.changed&&e.changed.length&&n.change(e),n.trigger("paste",e),n.trigger("pastedone"),e.sync&&n.sync()}).always(function(){var e=[],i=2;f()?n.notify({type:"trash",cnt:0,hideCnt:!0,progress:o}):l+=o,--c<1&&(a&&clearTimeout(a),f()&&n.notify({type:"trash",cnt:-1}),n.unlockfiles({files:r}),Object.keys(u).length?(d.length>1&&((u.removed||u.removed.length)&&(e=$.grep(r,function(e){return-1===$.inArray(e,u.removed)})),e.length?(d.length>i&&(i=-1===(n.messages[d[i-1]]||"").indexOf("$")?i:i+1),t.reject(),n.exec("rm",e,{addTexts:d.slice(0,i),forceRm:!0})):n.error(d)),u._noSound=!0,u.undo&&u.redo&&(u.undo={cmd:"trash",callback:u.undo},u.redo={cmd:"trash",callback:u.redo}),t.resolve(u)):t.reject(d))}))})):(t.reject("errFolderNotFound"),n.unlockfiles({files:r}))}):(t.reject(["error","The folder hierarchy to be deleting can not be determined."]),n.unlockfiles({files:r}))}).fail(function(){e.confirm(t,r,e.files(r),null,[n.i18n("tooManyToTrash")])}))},this.remove=r,this.syncTitleOnChange=!0,this.updateOnSelect=!1,this.shortcuts=[{pattern:"delete ctrl+backspace shift+delete"}],this.value="rm",this.init=function(){e=this,n=this.fm,e.change(function(){delete e.extra,e.title=n.i18n("cmd"+e.value),e.className=e.value,e.button&&e.button.children("span.elfinder-button-icon")["trash"===e.value?"addClass":"removeClass"]("elfinder-button-icon-trash"),"trash"===e.value&&(e.extra={icon:"rm",node:$("<span/>").attr({title:n.i18n("cmdrm")}).on("ready",function(e,n){}).on("click touchstart",function(e){"touchstart"===e.type&&e.originalEvent.touches.length>1||(e.stopPropagation(),e.preventDefault(),n.getUI().trigger("click"),n.exec("rm",void 0,{_userAction:!0,forceRm:!0}))})})})},this.getstate=function(e){var t=this.hashes(e);return t.length&&$.grep(t,function(e){var t=n.file(e);return!(!t||t.locked||n.isRoot(t))}).length==t.length?0:-1},this.exec=function(t,o){var c,s=o||{},l=$.Deferred().always(function(){a&&a.state&&"pending"===a.state()&&a.reject()}).fail(function(e){e&&n.error(e)}).done(function(e){!s.quiet&&!e._noSound&&e.removed&&e.removed.length&&n.trigger("playsound",{soundFile:"rm.wav"})}),d=e.files(t),u=d.length,f=null,h=s.addTexts?s.addTexts:null,m=s.forceRm,p=s.quiet;return u?($.each(d,function(e,t){return n.isRoot(t)?!l.reject(["errRm",t.name,"errPerm"]):t.locked?!l.reject(["errLocked",t.name]):void 0}),"pending"===l.state()&&(c=e.hashes(t),u=d.length,(m||e.event&&e.event.originalEvent&&e.event.originalEvent.shiftKey)&&(f="",e.title=n.i18n("cmdrm")),null===f&&(f=i(c)),n.lockfiles({files:c}),f&&e.options.quickTrash?e.toTrash(l,c,f):p?r(l,c,p):e.confirm(l,c,d,f,h)),l):l.reject()},n.bind("select contextmenucreate closecontextmenu",function(t){var r=(t.data?t.data.selected||t.data.targets:null)||n.selected();r&&r.length&&e.update(void 0,(r?i(r):n.option("trashHash"))?"trash":"rm")})},e});
//# sourceMappingURL=../sourcemaps/commands/rm.js.map
