{"version":3,"sources":["commands/search.js"],"names":["define","elFinder","prototype","commands","search","this","title","options","ui","alwaysEnabled","updateOnSelect","getstate","exec","q","target","mime","type","phash","rootCnt","fm","reqDef","sType","onlyMimes","targetVolids","setType","data","$","trim","replace","split","length","map","m","inArray","grep","om","indexOf","concat","trigger","query","mimes","api","Object","keys","roots","each","id","hash","push","request","cmd","notify","cnt","hideCnt","cancel","preventDone","leafRoots","f","file","volumeid","Deferred","resolve","files","searchStatus","mixed","when","apply","done","i","argLen","arguments","warning","error","cache","lazy","then","sync","getUI","find","res","reject"],"mappings":"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","file":"../../commands/search.js","sourcesContent":["define([\n\t\"../elFinder\"\n],function(elFinder){\n\t/**\n\t * @class  elFinder command \"search\"\n\t * Find files\n\t *\n\t * @author Dmitry (dio) Levashov\n\t **/\n\telFinder.prototype.commands.search = function() {\n\t\t\"use strict\";\n\t\tthis.title          = 'Find files';\n\t\tthis.options        = {ui : 'searchbutton'};\n\t\tthis.alwaysEnabled  = true;\n\t\tthis.updateOnSelect = false;\n\t\t\n\t\t/**\n\t\t * Return command status.\n\t\t * Search does not support old api.\n\t\t *\n\t\t * @return Number\n\t\t **/\n\t\tthis.getstate = function() {\n\t\t\treturn 0;\n\t\t};\n\t\t\n\t\t/**\n\t\t * Send search request to backend.\n\t\t *\n\t\t * @param  String  search string\n\t\t * @return $.Deferred\n\t\t **/\n\t\tthis.exec = function(q, target, mime, type) {\n\t\t\tvar fm = this.fm,\n\t\t\t\treqDef = [],\n\t\t\t\tsType = type || '',\n\t\t\t\tonlyMimes = fm.options.onlyMimes,\n\t\t\t\tphash, targetVolids = [],\n\t\t\t\tsetType = function(data) {\n\t\t\t\t\tif (sType && sType !== 'SearchName' && sType !== 'SearchMime') {\n\t\t\t\t\t\tdata.type = sType;\n\t\t\t\t\t}\n\t\t\t\t\treturn data;\n\t\t\t\t},\n\t\t\t\trootCnt;\n\t\t\t\n\t\t\tif (typeof q == 'string' && q) {\n\t\t\t\tif (typeof target == 'object') {\n\t\t\t\t\tmime = target.mime || '';\n\t\t\t\t\ttarget = target.target || '';\n\t\t\t\t}\n\t\t\t\ttarget = target? target : '';\n\t\t\t\tif (mime) {\n\t\t\t\t\tmime = $.trim(mime).replace(',', ' ').split(' ');\n\t\t\t\t\tif (onlyMimes.length) {\n\t\t\t\t\t\tmime = $.map(mime, function(m){ \n\t\t\t\t\t\t\tm = $.trim(m);\n\t\t\t\t\t\t\treturn m && ($.inArray(m, onlyMimes) !== -1\n\t\t\t\t\t\t\t\t\t\t|| $.grep(onlyMimes, function(om) { return m.indexOf(om) === 0? true : false; }).length\n\t\t\t\t\t\t\t\t\t\t)? m : null;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tmime = [].concat(onlyMimes);\n\t\t\t\t}\n\n\t\t\t\tfm.trigger('searchstart', setType({query : q, target : target, mimes : mime}));\n\t\t\t\t\n\t\t\t\tif (! onlyMimes.length || mime.length) {\n\t\t\t\t\tif (target === '' && fm.api >= 2.1) {\n\t\t\t\t\t\trootCnt = Object.keys(fm.roots).length;\n\t\t\t\t\t\t$.each(fm.roots, function(id, hash) {\n\t\t\t\t\t\t\treqDef.push(fm.request({\n\t\t\t\t\t\t\t\tdata   : setType({cmd : 'search', q : q, target : hash, mimes : mime}),\n\t\t\t\t\t\t\t\tnotify : {type : 'search', cnt : 1, hideCnt : (rootCnt > 1? false : true)},\n\t\t\t\t\t\t\t\tcancel : true,\n\t\t\t\t\t\t\t\tpreventDone : true\n\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\treqDef.push(fm.request({\n\t\t\t\t\t\t\tdata   : setType({cmd : 'search', q : q, target : target, mimes : mime}),\n\t\t\t\t\t\t\tnotify : {type : 'search', cnt : 1, hideCnt : true},\n\t\t\t\t\t\t\tcancel : true,\n\t\t\t\t\t\t\tpreventDone : true\n\t\t\t\t\t\t}));\n\t\t\t\t\t\tif (target !== '' && fm.api >= 2.1 && Object.keys(fm.leafRoots).length) {\n\t\t\t\t\t\t\t$.each(fm.leafRoots, function(hash, roots) {\n\t\t\t\t\t\t\t\tphash = hash;\n\t\t\t\t\t\t\t\twhile(phash) {\n\t\t\t\t\t\t\t\t\tif (target === phash) {\n\t\t\t\t\t\t\t\t\t\t$.each(roots, function() {\n\t\t\t\t\t\t\t\t\t\t\tvar f = fm.file(this);\n\t\t\t\t\t\t\t\t\t\t\tf && f.volumeid && targetVolids.push(f.volumeid);\n\t\t\t\t\t\t\t\t\t\t\treqDef.push(fm.request({\n\t\t\t\t\t\t\t\t\t\t\t\tdata   : setType({cmd : 'search', q : q, target : this, mimes : mime}),\n\t\t\t\t\t\t\t\t\t\t\t\tnotify : {type : 'search', cnt : 1, hideCnt : false},\n\t\t\t\t\t\t\t\t\t\t\t\tcancel : true,\n\t\t\t\t\t\t\t\t\t\t\t\tpreventDone : true\n\t\t\t\t\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tphash = (fm.file(phash) || {}).phash;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\treqDef = [$.Deferred().resolve({files: []})];\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfm.searchStatus.mixed = (reqDef.length > 1)? targetVolids : false;\n\t\t\t\t\n\t\t\t\treturn $.when.apply($, reqDef).done(function(data) {\n\t\t\t\t\tvar argLen = arguments.length,\n\t\t\t\t\t\ti;\n\t\t\t\t\t\n\t\t\t\t\tdata.warning && fm.error(data.warning);\n\t\t\t\t\t\n\t\t\t\t\tif (argLen > 1) {\n\t\t\t\t\t\tdata.files = (data.files || []);\n\t\t\t\t\t\tfor(i = 1; i < argLen; i++) {\n\t\t\t\t\t\t\targuments[i].warning && fm.error(arguments[i].warning);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (arguments[i].files) {\n\t\t\t\t\t\t\t\tdata.files.push.apply(data.files, arguments[i].files);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t// because \"preventDone : true\" so update files cache\n\t\t\t\t\tdata.files && data.files.length && fm.cache(data.files);\n\t\t\t\t\t\n\t\t\t\t\tfm.lazy(function() {\n\t\t\t\t\t\tfm.trigger('search', data);\n\t\t\t\t\t}).then(function() {\n\t\t\t\t\t\t// fire event with command name + 'done'\n\t\t\t\t\t\treturn fm.lazy(function() {\n\t\t\t\t\t\t\tfm.trigger('searchdone');\n\t\t\t\t\t\t});\n\t\t\t\t\t}).then(function() {\n\t\t\t\t\t\t// force update content\n\t\t\t\t\t\tdata.sync && fm.sync();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t\tfm.getUI('toolbar').find('.'+fm.res('class', 'searchbtn')+' :text').trigger('focus');\n\t\t\treturn $.Deferred().reject();\n\t\t};\n\n\t};\n\n\treturn elFinder;\n\n});"]}