{"version":3,"sources":["commands/upload.js"],"names":["define","elFinder","prototype","commands","upload","hover","this","fm","res","disableOnSearch","updateOnSelect","shortcuts","pattern","getstate","select","f","sel","cwd","hash","_disabled","length","file","mime","write","exec","data","dialog","dropUpload","paste","spinner","uidialog","tgts","input","cwdHash","targets","Array","selected","check","target","targetDir","fmUpload","fail","error","dfrd","reject","done","node","getUI","resolve","added","ui","notify","children","newItem","findCwdNodes","trigger","$","append","i18n","on","e","toggleClass","type","one","files","map","toast","msg","extNode","progress","notifyWith","from","arguments","elfinderdialog","getSelector","dirs","stopPropagation","preventDefault","sortFiles","$this","base","closest","getRaw","icon","label","escape","i18","name","remain","callback","title","find","html","options","className","iconClass","csscls","iconImg","raw","each","i","push","x","pageX","offset","left","y","pageY","top","prevNode","fitHeight","inputButton","caption","UA","IE","setTimeout","form","css","requestAnimationFrame","get","originalEvent","dataTransfer","dropEffect","Deferred","errors","elfFrom","mycwd","_target","trf","kind","items","getData","window","location","href","getAsEntry","webkitGetAsEntry","inArray","types","match","dropEvt","ev","clipboardData","getAsFile","clipdata","my","srcElement","src","innerHTML","v","remove","Mobile","document","createElement","webkitdirectory","directory","navHash2Elm","hasClass","appendTo","request","cmd","replaceWith","dragUpload","addClass","removeClass","prependTo","after","fmDialog","modal","resizable","destroyOnClose","propagationEvents","close","cm","is","click"],"mappings":";;;;;;;AAAAA,QACC,eACC,SAASC,GA8ZV,OArZAA,EAASC,UAAUC,SAASC,OAAS,WACpC,aACA,IAAIC,EAAQC,KAAKC,GAAGC,IAAI,QAAS,SAEjCF,KAAKG,iBAAkB,EACvBH,KAAKI,gBAAkB,EAGvBJ,KAAKK,YACJC,QAAc,WAQfN,KAAKO,SAAW,SAASC,GACxB,IAAkBC,EAAdR,EAAKD,KAAKC,GACdS,EAAOF,IAAWP,EAAGU,MAAMC,MAI3B,OAHKZ,KAAKa,WAA2B,GAAdH,EAAII,SAC1BL,EAAIR,EAAGc,KAAKL,EAAI,KAETD,GAAe,aAAVA,EAAEO,MAAuBP,EAAEQ,MAAQ,GAAK,GAItDjB,KAAKkB,KAAO,SAASC,GACpB,IAoJCC,EAA2BC,EAAYC,EAAaC,EAASC,EAhJ3Dd,EADGe,EA0Q0BC,EA7Q5BzB,EAAKD,KAAKC,GACb0B,EAAU1B,EAAGU,MAAMC,KAanBgB,GAXKH,EAAON,GAASA,aAAgBU,MAAQV,EAAO,OAE7CA,GAAQA,aAAgBU,SACvBJ,GAAyC,KAAhCf,EAAMT,EAAG6B,YAAYhB,QAAyC,cAAzBb,EAAGc,KAAKL,EAAI,IAAIM,KAExDS,GAAwB,IAAhBA,EAAKX,QAA0C,cAA1Bb,EAAGc,KAAKU,EAAK,IAAIT,OACzDS,GAASE,IAFTF,EAAOf,GAKFe,GAGRM,EAAQH,EAASA,EAAQ,GAAMT,GAAQA,EAAKa,OAAQb,EAAKa,OAAS,KAClEC,EAAYF,EAAO9B,EAAGc,KAAKgB,GAAS9B,EAAGU,MACvCuB,EAAW,SAASf,GACnBlB,EAAGH,OAAOqB,GACRgB,KAAK,SAASC,GACdC,EAAKC,OAAOF,KAEZG,KAAK,SAASpB,GACd,IACCqB,EADSvC,EAAGwC,MAAM,OAGnB,GADAJ,EAAKK,QAAQvB,GACTA,GAAQA,EAAKwB,OAASxB,EAAKwB,MAAM,KAAQ1C,EAAG2C,GAAGC,OAAOC,SAAS,2BAA2BhC,OAAQ,CACrG,IAAIiC,EAAU9C,EAAG+C,aAAa7B,EAAKwB,OAC/BI,EAAQjC,OACXiC,EAAQE,QAAQ,iBAEZhB,EAAUrB,OAASe,EACtBa,EAAOU,EAAE,UAAUC,OAClBD,EAAE,kIAAkIjD,EAAGmD,KAAK,cAAc,oBACzJC,GAAG,wBAAyB,SAASC,GACrCJ,EAAElD,MAAMuD,YAAY,iBAA4B,cAAVD,EAAEE,QACtCH,GAAG,QAAS,WACdpD,EAAGiB,KAAK,OAAQa,GAAOQ,KAAK,WAC3BtC,EAAGwD,IAAI,WAAY,WAClBxD,EAAGgD,QAAQ,eAAgBS,MAAQR,EAAES,IAAIxC,EAAKwB,MAAO,SAASlC,GAAI,OAAOA,EAAEG,gBAM/EX,EAAGgD,QAAQ,eAAgBS,MAAQR,EAAES,IAAIxC,EAAKwB,MAAO,SAASlC,GAAI,OAAOA,EAAEG,SAE5EX,EAAG2D,OAAOC,IAAK5D,EAAGmD,MAAM,WAAYnD,EAAGmD,KAAK,eAAgBU,QAAStB,QAIvEuB,SAAS,WACT1B,EAAK2B,WAAWhE,KAAM6B,MAAMoC,KAAKC,eAGpCpE,EAAS,SAASqB,GACjBC,EAAO+C,eAAe,SAClBvC,IACHT,EAAKa,OAASJ,EAAQ,IAEvBM,EAASf,IAEViD,EAAc,WACb,IAAIxD,EAAOqB,EAAUrB,KACpByD,EAAOnB,EAAES,IAAI1D,EAAGyD,MAAM9C,GAAO,SAASH,GACrC,MAAmB,cAAXA,EAAEO,MAAwBP,EAAEQ,MAAQR,EAAI,OAGlD,OAAM4D,EAAKvD,OAIJoC,EAAE,kEAAoEjD,EAAGmD,KAAK,WAAa,OACjGC,GAAG,QAAS,SAASC,GACrBA,EAAEgB,kBACFhB,EAAEiB,iBACFF,EAAOpE,EAAGuE,UAAUH,GACpB,IAAII,EAASvB,EAAElD,MAEd0E,GADSzE,EAAGU,MACHS,EAAOuD,QAAQ,kBACxBC,EAAS,SAASnE,EAAGoE,GACpB,OACCC,MAAW7E,EAAG8E,OAAOtE,EAAEuE,KAAOvE,EAAEwE,MAChCJ,KAAWA,EACXK,QAAW,EACXC,SAAW,WACV,IAAIC,EAAQV,EAAK5B,SAAS,6BAA6BuC,KAAK,+BAC5DzD,GAAYnB,EAAEG,MACdwE,EAAME,KAAK,MAAQrF,EAAG8E,OAAOtE,EAAEuE,KAAOvE,EAAEwE,OACxCR,EAAMxB,QAAQ,UAEfsC,SACCC,UAAa5D,GAAWA,EAAQd,QAAUL,EAAEG,OAASgB,EAAQ,GAAK,kBAAoB,GACtF6D,UAAYhF,EAAEiF,QAAU,GACxBC,QAAYlF,EAAEoE,MAAU,MAI3Be,GAAQhB,EAAO3C,EAAW,WAAY,KACvCiB,EAAE2C,KAAKxB,EAAM,SAASyB,EAAGrF,GACxBmF,EAAIG,KAAKnB,EAAOnE,EAAG,UAEpBgE,EAAMxB,QAAQ,QACdhD,EAAGgD,QAAQ,eACV2C,IAAKA,EACLI,EAAG1C,EAAE2C,OAAS/C,EAAElD,MAAMkG,SAASC,KAC/BC,EAAG9C,EAAE+C,OAASnD,EAAElD,MAAMkG,SAASI,IAC/BC,SAAU7B,EACV8B,WAAW,MAEVrD,OAAO,kEAzCFD,KA2CTuD,EAAc,SAASjD,EAAMkD,GAC5B,IACChF,EAAQwB,EAAE,sBAAwBM,EAAO,MACxCH,GAAG,QAAS,WAERpD,EAAG0G,GAAGC,IACTC,WAAW,WACVC,EAAKC,IAAI,UAAW,QAAQA,IAAI,WAAY,YAC5CC,sBAAsB,WACrBF,EAAKC,IAAI,UAAW,IAAIA,IAAI,WAAY,OAEvC,OAGJ1D,GAAG,SAAU,WACbvD,GAAQ4B,MAAQA,EAAMuF,IAAI,GAAIzD,KAAO,YAErCH,GAAG,WAAY,SAASC,GACxBA,EAAE4D,cAAcC,aAAaC,WAAa,SAE3CN,EAAO5D,EAAE,WAAWC,OAAOzB,GAAO2B,GAAG,QAAS,SAASC,GACtDA,EAAEgB,oBAGJ,OAAOpB,EAAE,oJAAoJjD,EAAGmD,KAAKsD,GAAS,iBAC5KvD,OAAO2D,GACPzD,GAAG,QAAS,SAASC,GACrBA,EAAEgB,kBACFhB,EAAEiB,iBACF7C,EAAMuB,QAAQ,WAEdI,GAAG,wBAAyB,SAASC,GACrCJ,EAAElD,MAAMuD,YAAYxD,EAAkB,eAAXuD,EAAEE,SAGhCnB,EAAOa,EAAEmE,WAgEV,OA7DAhG,EAAa,SAASiC,GACrBA,EAAEgB,kBACFhB,EAAEiB,iBACF,IAQC+C,EARGvG,GAAO,EACVyC,EAAO,GACP+D,EAAU,KACVC,EAAQ,GACRrG,EAAO,KACPa,EAASsB,EAAEmE,SAAW,KACtBC,EAAMpE,EAAE6D,cAAgB,KACxBQ,EAAQD,EAAIE,OAASF,EAAIE,MAAM9G,QAAU4G,EAAIE,MAAM,GAAGD,KAAOD,EAAIE,MAAM,GAAGD,KAAO,GAGlF,GAAID,EAAK,CACR,IAEC,IADAH,EAAUG,EAAIG,QAAQ,mBAErBL,EAAQM,OAAOC,SAASC,KAAO/H,EAAGU,MAAMC,MAClCoB,GAAUuF,IAAYC,GAAUxF,IAAWwF,GAEhD,YADAnF,EAAKC,SAIN,MAAMgB,IAER,GAAa,SAATqE,IAAoBD,EAAIE,MAAM,GAAGK,YAAcP,EAAIE,MAAM,GAAGM,kBAC/DnH,EAAO2G,EACPlE,EAAO,YACD,GAAa,WAATmE,GAAqBD,EAAIhE,OAASgE,EAAIhE,MAAM5C,SAA4C,IAAlCoC,EAAEiF,QAAQ,OAAQT,EAAIU,OACtFrH,EAAO2G,EAAIhE,MACXF,EAAO,YACD,CACN,KACMrC,EAAOuG,EAAIG,QAAQ,eAAiB1G,EAAKkH,MAAM,iBACnDtH,GAASI,GACTqC,EAAO,QAEP,MAAMF,IACFvC,KACDI,EAAOuG,EAAIG,QAAQ,UACtB9G,GAASI,GACTqC,EAAO,QACGkE,GAAOA,EAAIhE,QAErBiE,EAAO,UAKP5G,EACHmB,GAAUwB,MAAQ3C,EAAMyC,KAAOA,EAAMxB,OAASA,EAAQsG,QAAUhF,KAEhEgE,GAAU,oBACG,SAATK,GACHL,EAAOvB,KAAK,mBAEb9F,EAAGmC,MAAMkF,GACTjF,EAAKC,YAIFV,GAAWT,GACXA,EAAKO,OAASP,EAAKuC,OACtBvC,EAAKqC,KAAO,QACZtB,EAASf,IACCA,EAAKmH,SACfjH,EAAWF,EAAKmH,SAEVjG,IAGRf,EAAQ,SAASiH,GAChB,IAEIxH,EAFAuC,EAAIiF,EAAGrB,eAAiBqB,EACxB7E,KAAYkE,KAEhB,GAAItE,EAAEkF,cAAe,CACpB,GAAIlF,EAAEkF,cAAcZ,OAAStE,EAAEkF,cAAcZ,MAAM9G,OAAO,CACzD8G,EAAQtE,EAAEkF,cAAcZ,MACxB,IAAK,IAAI9B,EAAE,EAAGA,EAAI8B,EAAM9G,OAAQgF,IACM,QAAjCxC,EAAEkF,cAAcZ,MAAM9B,GAAG6B,OAC5B5G,EAAOuC,EAAEkF,cAAcZ,MAAM9B,GAAG2C,YAChC/E,EAAMqC,KAAKhF,SAGHuC,EAAEkF,cAAc9E,OAASJ,EAAEkF,cAAc9E,MAAM5C,SACzD4C,EAAQJ,EAAEkF,cAAc9E,OAEzB,GAAIA,EAAM5C,OAET,YADAhB,GAAQ4D,MAAQA,EAAOF,KAAO,QAASkF,UAAW,IAIpD,IAAIC,EAAKrF,EAAEtB,QAAUsB,EAAEsF,WACvB5B,sBAAsB,WACrB,IACC6B,EADGrF,EAAO,OAEPmF,EAAGG,YACN5F,EAAEyF,GAAItD,KAAK,OAAOQ,KAAK,SAASC,EAAGiD,GAC9BA,EAAEF,IAAIR,MAAM,0BAIfnF,EAAE6F,GAAGC,WAIH9F,EAAEyF,GAAItD,KAAK,SAASvE,SACvB0C,EAAO,QAERqF,EAAMF,EAAGG,UACTH,EAAGG,UAAY,GACfhJ,GAAQ4D,OAAUmF,GAAOrF,KAAOA,QAKnCpC,EAAS8B,EAAE,iDACTC,OAAOsD,EAAY,WAAY,oBAE3BxG,EAAG0G,GAAGsC,aAC8B,KADVvH,EACoEwH,SAASC,cAAc,UAArGC,sBAA8D,IAApB1H,EAAM2H,WACrEjI,EAAO+B,OAAOsD,EAAY,qCAAsC,iBAG7DxE,EAAUoC,OAETpC,EAAUrB,OAASe,GAAW1B,EAAGqJ,YAAYrH,EAAUrB,MAAM2I,SAAS,2BACzEnF,IAAcoF,SAASpI,IAEvBG,EAAU2B,EAAE,iDAAmDjD,EAAGmD,KAAK,cAAgB,OACrFD,OAAO,sEACPqG,SAASpI,GACXnB,EAAGwJ,SAASC,IAAM,OAAQ1H,OAASC,EAAUrB,OAC3C2B,KAAK,WACLtC,EAAGwD,IAAI,WAAY,WAClBlC,EAAQoI,YAAYvF,KACpB5C,EAAS2C,eAAe,oBAGzBhC,KAAK,WACLZ,EAAQyH,aAKR/I,EAAG2J,WACI1G,EAAE,uGAAuGjD,EAAGmD,KAAK,kBAAkB,YAC3IC,GAAG,QAAS,SAASC,GACrBhC,EAAMgC,KAEND,GAAG,kBAAmB,WACtBH,EAAElD,MAAMiD,QAAQ,WAEhBI,GAAG,QAAS,WACZrD,KAAK8I,UAAY,KAEjBzF,GAAG,YAAa,WAChBH,EAAElD,MAAM6J,SAAS9J,KAEjBsD,GAAG,WAAY,WACfH,EAAElD,MAAM8J,YAAY/J,KAEpBsD,GAAG,YAAa,SAASC,GACzBA,EAAEgB,kBACAhB,EAAEiB,iBACFrB,EAAElD,MAAM6J,SAAS9J,KAEnBsD,GAAG,YAAa,SAASC,GACzBA,EAAEgB,kBACAhB,EAAEiB,iBACFrB,EAAElD,MAAM8J,YAAY/J,KAEtBsD,GAAG,WAAY,SAASC,GACxBA,EAAEgB,kBACAhB,EAAEiB,iBACJjB,EAAE4D,cAAcC,aAAaC,WAAa,OAC1ClE,EAAElD,MAAM6J,SAAS9J,KAEjBsD,GAAG,OAAQ,SAASC,GACpBlC,EAAO+C,eAAe,SACtBvC,IAAY0B,EAAE4D,cAAcO,QAAU7F,EAAQ,IAC9CP,EAAWiC,EAAE4D,iBAEb6C,UAAU3I,GACV4I,MAAM,0CAA0C/J,EAAGmD,KAAK,MAAM,UAAU,GAG/DF,EAAE,6EAA6EjD,EAAGmD,KAAK,oBAAoB,UACpHC,GAAG,aAAc,SAASC,GAC1BhC,EAAMgC,KAEND,GAAG,kBAAmB,WACtBH,EAAElD,MAAMiD,QAAQ,WAEhBI,GAAG,QAAS,WACZrD,KAAK8I,UAAY,KAEjBzF,GAAG,sBAAuB,WAC1BH,EAAElD,MAAM6J,SAAS9J,KAEjBsD,GAAG,qBAAsB,WACzBH,EAAElD,MAAM8J,YAAY/J,KAEpBgK,UAAU3I,GACV4I,MAAM,0CAA0C/J,EAAGmD,KAAK,MAAM,UAAU,GAI3E5B,EAAWxB,KAAKiK,SAAS7I,GACxBgE,MAAiBpF,KAAKoF,MAAQ,yCAA2CnD,EAAW,MAAQhC,EAAG8E,OAAO9C,EAAU+C,KAAO/C,EAAUgD,MAAQ,IAAM,UAC/IiF,OAAiB,EACjBC,WAAiB,EACjBC,gBAAiB,EACjBC,mBAAqB,YAAa,UAAW,SAC7CC,MAAiB,WAChB,IAAIC,EAAKtK,EAAGwC,MAAM,eACd8H,EAAGC,GAAG,aACTD,EAAGE,WAKCpI,KAKF1C","file":"../../commands/upload.js","sourcesContent":["define([\n\t\"../elFinder\"\n],function(elFinder){\n\t/**\n\t * @class elFinder command \"upload\"\n\t * Upload files using iframe or XMLHttpRequest & FormData.\n\t * Dialog allow to send files using drag and drop\n\t *\n\t * @type  elFinder.command\n\t * @author  Dmitry (dio) Levashov\n\t */\n\telFinder.prototype.commands.upload = function() {\n\t\t\"use strict\";\n\t\tvar hover = this.fm.res('class', 'hover');\n\t\t\n\t\tthis.disableOnSearch = true;\n\t\tthis.updateOnSelect  = false;\n\t\t\n\t\t// Shortcut opens dialog\n\t\tthis.shortcuts = [{\n\t\t\tpattern     : 'ctrl+u'\n\t\t}];\n\t\t\n\t\t/**\n\t\t * Return command state\n\t\t *\n\t\t * @return Number\n\t\t **/\n\t\tthis.getstate = function(select) {\n\t\t\tvar fm = this.fm, f,\n\t\t\tsel = (select || [fm.cwd().hash]);\n\t\t\tif (!this._disabled && sel.length == 1) {\n\t\t\t\tf = fm.file(sel[0]);\n\t\t\t}\n\t\t\treturn (f && f.mime == 'directory' && f.write)? 0 : -1;\n\t\t};\n\t\t\n\t\t\n\t\tthis.exec = function(data) {\n\t\t\tvar fm = this.fm,\n\t\t\t\tcwdHash = fm.cwd().hash,\n\t\t\t\tgetTargets = function() {\n\t\t\t\t\tvar tgts = data && (data instanceof Array)? data : null,\n\t\t\t\t\t\tsel;\n\t\t\t\t\tif (! data || data instanceof Array) {\n\t\t\t\t\t\tif (! tgts && (sel = fm.selected()).length === 1 && fm.file(sel[0]).mime === 'directory') {\n\t\t\t\t\t\t\ttgts = sel;\n\t\t\t\t\t\t} else if (!tgts || tgts.length !== 1 || fm.file(tgts[0]).mime !== 'directory') {\n\t\t\t\t\t\t\ttgts = [ cwdHash ];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn tgts;\n\t\t\t\t},\n\t\t\t\ttargets = getTargets(),\n\t\t\t\tcheck = targets? targets[0] : (data && data.target? data.target : null),\n\t\t\t\ttargetDir = check? fm.file(check) : fm.cwd(),\n\t\t\t\tfmUpload = function(data) {\n\t\t\t\t\tfm.upload(data)\n\t\t\t\t\t\t.fail(function(error) {\n\t\t\t\t\t\t\tdfrd.reject(error);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.done(function(data) {\n\t\t\t\t\t\t\tvar cwd = fm.getUI('cwd'),\n\t\t\t\t\t\t\t\tnode;\n\t\t\t\t\t\t\tdfrd.resolve(data);\n\t\t\t\t\t\t\tif (data && data.added && data.added[0] && ! fm.ui.notify.children('.elfinder-notify-upload').length) {\n\t\t\t\t\t\t\t\tvar newItem = fm.findCwdNodes(data.added);\n\t\t\t\t\t\t\t\tif (newItem.length) {\n\t\t\t\t\t\t\t\t\tnewItem.trigger('scrolltoview');\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tif (targetDir.hash !== cwdHash) {\n\t\t\t\t\t\t\t\t\t\tnode = $('<div/>').append(\n\t\t\t\t\t\t\t\t\t\t\t$('<button type=\"button\" class=\"ui-button ui-widget ui-state-default ui-corner-all elfinder-tabstop\"><span class=\"ui-button-text\">'+fm.i18n('cmdopendir')+'</span></button>')\n\t\t\t\t\t\t\t\t\t\t\t.on('mouseenter mouseleave', function(e) { \n\t\t\t\t\t\t\t\t\t\t\t\t$(this).toggleClass('ui-state-hover', e.type == 'mouseenter');\n\t\t\t\t\t\t\t\t\t\t\t}).on('click', function() {\n\t\t\t\t\t\t\t\t\t\t\t\tfm.exec('open', check).done(function() {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfm.one('opendone', function() {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfm.trigger('selectfiles', {files : $.map(data.added, function(f) {return f.hash;})});\n\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tfm.trigger('selectfiles', {files : $.map(data.added, function(f) {return f.hash;})});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tfm.toast({msg: fm.i18n(['complete', fm.i18n('cmdupload')]), extNode: node});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.progress(function() {\n\t\t\t\t\t\t\tdfrd.notifyWith(this, Array.from(arguments));\n\t\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tupload = function(data) {\n\t\t\t\t\tdialog.elfinderdialog('close');\n\t\t\t\t\tif (targets) {\n\t\t\t\t\t\tdata.target = targets[0];\n\t\t\t\t\t}\n\t\t\t\t\tfmUpload(data);\n\t\t\t\t},\n\t\t\t\tgetSelector = function() {\n\t\t\t\t\tvar hash = targetDir.hash,\n\t\t\t\t\t\tdirs = $.map(fm.files(hash), function(f) {\n\t\t\t\t\t\t\treturn (f.mime === 'directory' && f.write)? f : null; \n\t\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t\tif (! dirs.length) {\n\t\t\t\t\t\treturn $();\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\treturn $('<div class=\"elfinder-upload-dirselect elfinder-tabstop\" title=\"' + fm.i18n('folders') + '\"/>')\n\t\t\t\t\t.on('click', function(e) {\n\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\tdirs = fm.sortFiles(dirs);\n\t\t\t\t\t\tvar $this  = $(this),\n\t\t\t\t\t\t\tcwd    = fm.cwd(),\n\t\t\t\t\t\t\tbase   = dialog.closest('div.ui-dialog'),\n\t\t\t\t\t\t\tgetRaw = function(f, icon) {\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\tlabel    : fm.escape(f.i18 || f.name),\n\t\t\t\t\t\t\t\t\ticon     : icon,\n\t\t\t\t\t\t\t\t\tremain   : false,\n\t\t\t\t\t\t\t\t\tcallback : function() {\n\t\t\t\t\t\t\t\t\t\tvar title = base.children('.ui-dialog-titlebar:first').find('span.elfinder-upload-target');\n\t\t\t\t\t\t\t\t\t\ttargets = [ f.hash ];\n\t\t\t\t\t\t\t\t\t\ttitle.html(' - ' + fm.escape(f.i18 || f.name));\n\t\t\t\t\t\t\t\t\t\t$this.trigger('focus');\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\toptions  : {\n\t\t\t\t\t\t\t\t\t\tclassName : (targets && targets.length && f.hash === targets[0])? 'ui-state-active' : '',\n\t\t\t\t\t\t\t\t\t\ticonClass : f.csscls || '',\n\t\t\t\t\t\t\t\t\t\ticonImg   : f.icon   || ''\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\traw = [ getRaw(targetDir, 'opendir'), '|' ];\n\t\t\t\t\t\t$.each(dirs, function(i, f) {\n\t\t\t\t\t\t\traw.push(getRaw(f, 'dir'));\n\t\t\t\t\t\t});\n\t\t\t\t\t\t$this.trigger('blur');\n\t\t\t\t\t\tfm.trigger('contextmenu', {\n\t\t\t\t\t\t\traw: raw,\n\t\t\t\t\t\t\tx: e.pageX || $(this).offset().left,\n\t\t\t\t\t\t\ty: e.pageY || $(this).offset().top,\n\t\t\t\t\t\t\tprevNode: base,\n\t\t\t\t\t\t\tfitHeight: true\n\t\t\t\t\t\t});\n\t\t\t\t\t}).append('<span class=\"elfinder-button-icon elfinder-button-icon-dir\" />');\n\t\t\t\t},\n\t\t\t\tinputButton = function(type, caption) {\n\t\t\t\t\tvar button,\n\t\t\t\t\t\tinput = $('<input type=\"file\" ' + type + '/>')\n\t\t\t\t\t\t.on('click', function() {\n\t\t\t\t\t\t\t// for IE's bug\n\t\t\t\t\t\t\tif (fm.UA.IE) {\n\t\t\t\t\t\t\t\tsetTimeout(function() {\n\t\t\t\t\t\t\t\t\tform.css('display', 'none').css('position', 'relative');\n\t\t\t\t\t\t\t\t\trequestAnimationFrame(function() {\n\t\t\t\t\t\t\t\t\t\tform.css('display', '').css('position', '');\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}, 100);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.on('change', function() {\n\t\t\t\t\t\t\tupload({input : input.get(0), type : 'files'});\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.on('dragover', function(e) {\n\t\t\t\t\t\t\te.originalEvent.dataTransfer.dropEffect = 'copy';\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tform = $('<form/>').append(input).on('click', function(e) {\n\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t});\n\n\t\t\t\t\treturn $('<div class=\"ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only elfinder-tabstop elfinder-focus\"><span class=\"ui-button-text\">'+fm.i18n(caption)+'</span></div>')\n\t\t\t\t\t\t.append(form)\n\t\t\t\t\t\t.on('click', function(e) {\n\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\tinput.trigger('click');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.on('mouseenter mouseleave', function(e) {\n\t\t\t\t\t\t\t$(this).toggleClass(hover, e.type === 'mouseenter');\n\t\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tdfrd = $.Deferred(),\n\t\t\t\tdialog, dropbox, pastebox, dropUpload, paste, dirs, spinner, uidialog;\n\t\t\t\n\t\t\tdropUpload = function(e) {\n\t\t\t\te.stopPropagation();\n\t\t\t\te.preventDefault();\n\t\t\t\tvar file = false,\n\t\t\t\t\ttype = '',\n\t\t\t\t\telfFrom = null,\n\t\t\t\t\tmycwd = '',\n\t\t\t\t\tdata = null,\n\t\t\t\t\ttarget = e._target || null,\n\t\t\t\t\ttrf = e.dataTransfer || null,\n\t\t\t\t\tkind = (trf.items && trf.items.length && trf.items[0].kind)? trf.items[0].kind : '',\n\t\t\t\t\terrors;\n\t\t\t\t\n\t\t\t\tif (trf) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\telfFrom = trf.getData('elfinderfrom');\n\t\t\t\t\t\tif (elfFrom) {\n\t\t\t\t\t\t\tmycwd = window.location.href + fm.cwd().hash;\n\t\t\t\t\t\t\tif ((!target && elfFrom === mycwd) || target === mycwd) {\n\t\t\t\t\t\t\t\tdfrd.reject();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch(e) {}\n\t\t\t\t\t\n\t\t\t\t\tif (kind === 'file' && (trf.items[0].getAsEntry || trf.items[0].webkitGetAsEntry)) {\n\t\t\t\t\t\tfile = trf;\n\t\t\t\t\t\ttype = 'data';\n\t\t\t\t\t} else if (kind !== 'string' && trf.files && trf.files.length && $.inArray('Text', trf.types) === -1) {\n\t\t\t\t\t\tfile = trf.files;\n\t\t\t\t\t\ttype = 'files';\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif ((data = trf.getData('text/html')) && data.match(/<(?:img|a)/i)) {\n\t\t\t\t\t\t\t\tfile = [ data ];\n\t\t\t\t\t\t\t\ttype = 'html';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch(e) {}\n\t\t\t\t\t\tif (! file) {\n\t\t\t\t\t\t\tif (data = trf.getData('text')) {\n\t\t\t\t\t\t\t\tfile = [ data ];\n\t\t\t\t\t\t\t\ttype = 'text';\n\t\t\t\t\t\t\t} else if (trf && trf.files) {\n\t\t\t\t\t\t\t\t// maybe folder uploading but this UA dose not support it\n\t\t\t\t\t\t\t\tkind = 'file';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (file) {\n\t\t\t\t\tfmUpload({files : file, type : type, target : target, dropEvt : e});\n\t\t\t\t} else {\n\t\t\t\t\terrors = ['errUploadNoFiles'];\n\t\t\t\t\tif (kind === 'file') {\n\t\t\t\t\t\terrors.push('errFolderUpload');\n\t\t\t\t\t}\n\t\t\t\t\tfm.error(errors);\n\t\t\t\t\tdfrd.reject();\n\t\t\t\t}\n\t\t\t};\n\t\t\t\n\t\t\tif (!targets && data) {\n\t\t\t\tif (data.input || data.files) {\n\t\t\t\t\tdata.type = 'files';\n\t\t\t\t\tfmUpload(data);\n\t\t\t\t} else if (data.dropEvt) {\n\t\t\t\t\tdropUpload(data.dropEvt);\n\t\t\t\t}\n\t\t\t\treturn dfrd;\n\t\t\t}\n\t\t\t\n\t\t\tpaste = function(ev) {\n\t\t\t\tvar e = ev.originalEvent || ev;\n\t\t\t\tvar files = [], items = [];\n\t\t\t\tvar file;\n\t\t\t\tif (e.clipboardData) {\n\t\t\t\t\tif (e.clipboardData.items && e.clipboardData.items.length){\n\t\t\t\t\t\titems = e.clipboardData.items;\n\t\t\t\t\t\tfor (var i=0; i < items.length; i++) {\n\t\t\t\t\t\t\tif (e.clipboardData.items[i].kind == 'file') {\n\t\t\t\t\t\t\t\tfile = e.clipboardData.items[i].getAsFile();\n\t\t\t\t\t\t\t\tfiles.push(file);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (e.clipboardData.files && e.clipboardData.files.length) {\n\t\t\t\t\t\tfiles = e.clipboardData.files;\n\t\t\t\t\t}\n\t\t\t\t\tif (files.length) {\n\t\t\t\t\t\tupload({files : files, type : 'files', clipdata : true});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tvar my = e.target || e.srcElement;\n\t\t\t\trequestAnimationFrame(function() {\n\t\t\t\t\tvar type = 'text',\n\t\t\t\t\t\tsrc;\n\t\t\t\t\tif (my.innerHTML) {\n\t\t\t\t\t\t$(my).find('img').each(function(i, v){\n\t\t\t\t\t\t\tif (v.src.match(/^webkit-fake-url:\\/\\//)) {\n\t\t\t\t\t\t\t\t// For Safari's bug.\n\t\t\t\t\t\t\t\t// ref. https://bugs.webkit.org/show_bug.cgi?id=49141\n\t\t\t\t\t\t\t\t//      https://dev.ckeditor.com/ticket/13029\n\t\t\t\t\t\t\t\t$(v).remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t\tif ($(my).find('a,img').length) {\n\t\t\t\t\t\t\ttype = 'html';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsrc = my.innerHTML;\n\t\t\t\t\t\tmy.innerHTML = '';\n\t\t\t\t\t\tupload({files : [ src ], type : type});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t};\n\t\t\t\n\t\t\tdialog = $('<div class=\"elfinder-upload-dialog-wrapper\"/>')\n\t\t\t\t.append(inputButton('multiple', 'selectForUpload'));\n\t\t\t\n\t\t\tif (! fm.UA.Mobile && (function(input) {\n\t\t\t\treturn (typeof input.webkitdirectory !== 'undefined' || typeof input.directory !== 'undefined');})(document.createElement('input'))) {\n\t\t\t\tdialog.append(inputButton('multiple webkitdirectory directory', 'selectFolder'));\n\t\t\t}\n\t\t\t\n\t\t\tif (targetDir.dirs) {\n\t\t\t\t\n\t\t\t\tif (targetDir.hash === cwdHash || fm.navHash2Elm(targetDir.hash).hasClass('elfinder-subtree-loaded')) {\n\t\t\t\t\tgetSelector().appendTo(dialog);\n\t\t\t\t} else {\n\t\t\t\t\tspinner = $('<div class=\"elfinder-upload-dirselect\" title=\"' + fm.i18n('nowLoading') + '\"/>')\n\t\t\t\t\t\t.append('<span class=\"elfinder-button-icon elfinder-button-icon-spinner\" />')\n\t\t\t\t\t\t.appendTo(dialog);\n\t\t\t\t\tfm.request({cmd : 'tree', target : targetDir.hash})\n\t\t\t\t\t\t.done(function() { \n\t\t\t\t\t\t\tfm.one('treedone', function() {\n\t\t\t\t\t\t\t\tspinner.replaceWith(getSelector());\n\t\t\t\t\t\t\t\tuidialog.elfinderdialog('tabstopsInit');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.fail(function() {\n\t\t\t\t\t\t\tspinner.remove();\n\t\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif (fm.dragUpload) {\n\t\t\t\tdropbox = $('<div class=\"ui-corner-all elfinder-upload-dropbox elfinder-tabstop\" contenteditable=\"true\" data-ph=\"'+fm.i18n('dropPasteFiles')+'\"></div>')\n\t\t\t\t\t.on('paste', function(e){\n\t\t\t\t\t\tpaste(e);\n\t\t\t\t\t})\n\t\t\t\t\t.on('mousedown click', function(){\n\t\t\t\t\t\t$(this).trigger('focus');\n\t\t\t\t\t})\n\t\t\t\t\t.on('focus', function(){\n\t\t\t\t\t\tthis.innerHTML = '';\n\t\t\t\t\t})\n\t\t\t\t\t.on('mouseover', function(){\n\t\t\t\t\t\t$(this).addClass(hover);\n\t\t\t\t\t})\n\t\t\t\t\t.on('mouseout', function(){\n\t\t\t\t\t\t$(this).removeClass(hover);\n\t\t\t\t\t})\n\t\t\t\t\t.on('dragenter', function(e) {\n\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t  \te.preventDefault();\n\t\t\t\t\t  \t$(this).addClass(hover);\n\t\t\t\t\t})\n\t\t\t\t\t.on('dragleave', function(e) {\n\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t  \te.preventDefault();\n\t\t\t\t\t  \t$(this).removeClass(hover);\n\t\t\t\t\t})\n\t\t\t\t\t.on('dragover', function(e) {\n\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t  \te.preventDefault();\n\t\t\t\t\t\te.originalEvent.dataTransfer.dropEffect = 'copy';\n\t\t\t\t\t\t$(this).addClass(hover);\n\t\t\t\t\t})\n\t\t\t\t\t.on('drop', function(e) {\n\t\t\t\t\t\tdialog.elfinderdialog('close');\n\t\t\t\t\t\ttargets && (e.originalEvent._target = targets[0]);\n\t\t\t\t\t\tdropUpload(e.originalEvent);\n\t\t\t\t\t})\n\t\t\t\t\t.prependTo(dialog)\n\t\t\t\t\t.after('<div class=\"elfinder-upload-dialog-or\">'+fm.i18n('or')+'</div>')[0];\n\t\t\t\t\n\t\t\t} else {\n\t\t\t\tpastebox = $('<div class=\"ui-corner-all elfinder-upload-dropbox\" contenteditable=\"true\">'+fm.i18n('dropFilesBrowser')+'</div>')\n\t\t\t\t\t.on('paste drop', function(e){\n\t\t\t\t\t\tpaste(e);\n\t\t\t\t\t})\n\t\t\t\t\t.on('mousedown click', function(){\n\t\t\t\t\t\t$(this).trigger('focus');\n\t\t\t\t\t})\n\t\t\t\t\t.on('focus', function(){\n\t\t\t\t\t\tthis.innerHTML = '';\n\t\t\t\t\t})\n\t\t\t\t\t.on('dragenter mouseover', function(){\n\t\t\t\t\t\t$(this).addClass(hover);\n\t\t\t\t\t})\n\t\t\t\t\t.on('dragleave mouseout', function(){\n\t\t\t\t\t\t$(this).removeClass(hover);\n\t\t\t\t\t})\n\t\t\t\t\t.prependTo(dialog)\n\t\t\t\t\t.after('<div class=\"elfinder-upload-dialog-or\">'+fm.i18n('or')+'</div>')[0];\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\tuidialog = this.fmDialog(dialog, {\n\t\t\t\ttitle          : this.title + '<span class=\"elfinder-upload-target\">' + (targetDir? ' - ' + fm.escape(targetDir.i18 || targetDir.name) : '') + '</span>',\n\t\t\t\tmodal          : true,\n\t\t\t\tresizable      : false,\n\t\t\t\tdestroyOnClose : true,\n\t\t\t\tpropagationEvents : ['mousemove', 'mouseup', 'click'],\n\t\t\t\tclose          : function() {\n\t\t\t\t\tvar cm = fm.getUI('contextmenu');\n\t\t\t\t\tif (cm.is(':visible')) {\n\t\t\t\t\t\tcm.click();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\t\treturn dfrd;\n\t\t};\n\n\t};\n\n\treturn elFinder;\n\n});"]}