/**
 * skylark-elfinder - A version of elfinder that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["skylark-jquery"],function(e){return e.fn.elfindertree=function(a,n){"use strict";var t=a.res("class","tree");return this.not("."+t).each(function(){var r,s,i,o,l="class",d=a.UA.Mobile,h=a.res(l,"treeroot"),c=n.openRootOnLoad,u=n.openCwdOnOpen,p=u||n.syncTree,f=a.res(l,"navsubtree"),v=a.res(l,"treedir"),g="span."+v,m=a.res(l,"navcollapse"),b=a.res(l,"navexpand"),C="elfinder-subtree-loaded",y=a.res(l,"navarrow"),H=a.res(l,"active"),w=a.res(l,"adroppable"),x=a.res(l,"hover"),T=a.res(l,"disabled"),k=a.res(l,"draggable"),I=a.res(l,"droppable"),E="elfinder-navbar-wrapper-root",P="elfinder-navbar-wrapper-pastable",U="elfinder-navbar-wrapper-uploadable",A=function(e){var a=ie.offset().left;return a<=e&&e<=a+ie.width()},D={},O=[],M=function(n){var t=[];if(e.each(n,function(e,n){D[n]&&t.push(a.navId2Hash(n)),delete D[n]}),t.length)return a.request({data:{cmd:"subdirs",targets:t,preventDefault:!0}}).done(function(n){n&&n.subdirs&&e.each(n.subdirs,function(e,n){var t=a.navHash2Elm(e);t.removeClass("elfinder-subtree-chksubdir"),t[n?"addClass":"removeClass"](m)})})},j=null,z=function(){var n=Object.keys(D);n.length&&(j&&j._abort(),r&&clearTimeout(r),O=[],j=a.asyncJob(function(n){return a.isInWindow(e("#"+n))?n:null},n,{numPerOnce:200}).done(function(e){e.length&&(O=e,F())}))},q=0,F=function(){var e,t=n.subdirsMaxConn-q,s=a.maxTargets?Math.min(a.maxTargets,n.subdirsAtOnce):n.subdirsAtOnce;if(r&&cancelAnimationFrame(r),O.length)if(t>0)for(e=0;e<t;e++)O.length&&(q++,M(O.splice(0,s)).always(function(){q--,F()}));else r=requestAnimationFrame(function(){O.length&&F()})},R=a.droppable.drop,X=e.extend(!0,{},a.droppable,{over:function(n,t){var r,s,i=e(this),o=t.helper,l=x+" "+w;if(n.stopPropagation(),o.data("dropover",o.data("dropover")+1),i.data("dropover",!0),t.helper.data("namespace")!==a.namespace||!a.insideWorkzone(n.pageX,n.pageY))return i.removeClass(l),void o.removeClass("elfinder-drag-helper-move elfinder-drag-helper-plus");A(n.clientX)?(o.removeClass("elfinder-drag-helper-move elfinder-drag-helper-plus"),i.addClass(x),i.is("."+m+":not(."+b+")")&&i.data("expandTimer",setTimeout(function(){i.is("."+m+"."+x)&&i.children("."+y).trigger("click")},500)),i.is(".elfinder-ro,.elfinder-na")?i.removeClass(w):(r=a.navId2Hash(i.attr("id")),i.data("dropover",r),e.each(t.helper.data("files"),function(e,n){if(n===r||a.file(n).phash===r&&!t.helper.hasClass("elfinder-drag-helper-plus"))return i.removeClass(l),!1}),o.data("locked")?s="elfinder-drag-helper-plus":(s="elfinder-drag-helper-move",(n.shiftKey||n.ctrlKey||n.metaKey)&&(s+=" elfinder-drag-helper-plus")),i.hasClass(w)&&o.addClass(s),requestAnimationFrame(function(){i.hasClass(w)&&o.addClass(s)}))):i.removeClass(l)},out:function(a,n){var t=e(this),r=n.helper;a.stopPropagation(),A(a.clientX)&&r.removeClass("elfinder-drag-helper-move elfinder-drag-helper-plus"),r.data("dropover",Math.max(r.data("dropover")-1,0)),t.data("expandTimer")&&clearTimeout(t.data("expandTimer")),t.removeData("dropover").removeClass(x+" "+w)},deactivate:function(){e(this).removeData("dropover").removeClass(x+" "+w)},drop:function(e,a){A(e.clientX)&&R.call(this,e,a)}}),N=e(a.res("tpl","navspinner")),W=a.res("tpl","navdir"),B=a.res("tpl","perms"),K=(a.res("tpl","lock"),a.res("tpl","symlink")),S={},Y={id:function(e){return a.navHash2Id(e.hash)},name:function(e){return a.escape(e.i18||e.name)},cssclass:function(e){var t=(e.phash&&!e.isroot?"":h)+" "+v+" "+a.perms2class(e);return e.dirs&&!e.link&&(t+=" "+m)&&-1==e.dirs&&(t+=" elfinder-subtree-chksubdir"),n.getClass&&(t+=" "+n.getClass(e)),e.csscls&&(t+=" "+a.escape(e.csscls)),t},title:function(e){return n.attrTitle?' title="'+a.escape(a.path(e.hash,!0)||e.i18||e.name)+'"':""},root:function(a){var n="";return!a.phash||a.isroot?(n+=" "+E,!a.disabled||a.disabled.length<1?n+=" "+P+" "+U:(-1===e.inArray("paste",a.disabled)&&(n+=" "+P),-1===e.inArray("upload",a.disabled)&&(n+=" "+U)),n):""},permissions:function(e){return e.read&&e.write?"":B},symlink:function(e){return e.alias?K:""},style:function(e){return e.icon?a.getIconStyle(e):""}},J=function(e){return W.replace(/(?:\{([a-z]+)\})/gi,function(a,n){var t=Y[n]?Y[n](e):e[n]||"";return"id"===n&&-1==e.dirs&&(D[t]=t),t})},L=function(n,t){return e.map(n||[],function(e){return"directory"!==e.mime||t&&!a.navHash2Elm(e.hash).length?null:e})},_=function(e){return e?a.navHash2Elm(e).next("."+f):re},G=function(e,n){for(var t,r=e.children(":first");r.length;){if(t=a.file(a.navId2Hash(r.children("[id]").attr("id"))),(t=a.file(a.navId2Hash(r.children("[id]").attr("id"))))&&V(n,t)<0)return r;r=r.next()}return e.children("button.elfinder-navbar-pager-next")},Q=function(t){for(var r,s,i,o,l,h,c,u=t.length,p=[],f=u,v=e(),g={},m=a.cwd(),b=function(t,r,s,i){var o={},l=0,h=a.newAPI?Math.min(1e4,Math.max(10,n.subTreeMax)):1e4,c=function(){o={},e.each(r,function(e,a){o[a.hash]=e})},u=function(a,n){var s,i;(a.stopPropagation(),n.select)?v(p(n.select)):n.change?"prepare"===(i=n.change)?e.each(r,function(e,a){a.node&&t.append(a.node.hide())}):"done"===i&&e.each(r,function(e,a){a.node&&a.node.detach().show()}):(n.removed&&n.removed.length&&(r=e.grep(r,function(e){return-1===n.removed.indexOf(e.hash)||(!s&&(s=!0),!1)})),n.added&&n.added.length&&(r=r.concat(e.grep(n.added,function(e){return void 0===o[e.hash]&&(!s&&(s=!0),!0)}))),s&&(r.sort(V),c(),v(l)))},p=function(e){if(void 0!==o[e])return Math.floor(o[e]/h)*h},f=a.navId2Hash(t.prev("[id]").attr("id")),v=function(n,s){var i,o,b,C,y,H,w,x=[],T={};delete S[f],l=n,t.off("update."+a.namespace,u),r.length>h&&(t.on("update."+a.namespace,u),void 0===n&&(0,c(),void 0===(n=p(m.hash))&&(n=0)),b=r.slice(n,n+h),S[f]=t,C=n?Math.max(-1,n-h):-1,y=n+h>=r.length?0:n+h,i=Math.ceil(r.length/h),o=Math.ceil(n/h)),e.each(b||r,function(e,a){x.push(J(a)),a.node&&(T[a.hash]=a.node)}),H=C>-1?e('<button class="elfinder-navbar-pager elfinder-navbar-pager-prev"/>').text(a.i18n("btnPrevious",o,i)).button({icons:{primary:"ui-icon-caret-1-n"}}).on("click",function(e){e.preventDefault(),e.stopPropagation(),v(C,"up")}):e(),w=y?e('<button class="elfinder-navbar-pager elfinder-navbar-pager-next"/>').text(a.i18n("btnNext",o+2,i)).button({icons:{primary:"ui-icon-caret-1-s"}}).on("click",function(e){e.preventDefault(),e.stopPropagation(),v(y,"down")}):e(),g(),t.empty()[b?"addClass":"removeClass"]("elfinder-navbar-hasmore").append(H,x.join(""),w),e.each(T,function(e,n){a.navHash2Elm(e).parent().replaceWith(n)}),s&&Z(a.navHash2Id(b["up"===s?b.length-1:0].hash)),!d&&a.lazy(function(){ne(null,t)})},g=function(){e.each(t.children(".elfinder-navbar-wrapper"),function(n,t){var s,i,l=e(t),d=l.children("[id]:first");d.hasClass(C)&&(s=a.navId2Hash(d.attr("id")))&&void 0!==(i=o[s])&&(r[i].node=l.detach())})};v()},y={},H=[],w={};f--;)g[(r=t[f]).hash]||a.navHash2Elm(r.hash).length||(g[r.hash]=!0,(s=_(r.phash)).length?(void 0===w[c=r.phash||"treeroot"]&&(w[c]=s.children(":last")),o=!w[c].length,r.phash&&(o||s.hasClass("elfinder-navbar-hasmore")||(i=G(s,r)).length)?o?(y[r.phash]||(y[r.phash]=[]),y[r.phash].push(r)):i?(h=J(r),i.before(h),!d&&(v=v.add(h))):H.push(r):(h=J(r),o?s.prepend(h):w[c].after(h),r.phash&&!r.isroot||(l=a.navHash2Elm(r.hash).parent()),!d&&ne(null,l))):p.push(r));Object.keys(y).length&&e.each(y,function(e,a){var n=_(e);a.sort(V),b(n,a)}),H.length&&s.trigger("update."+a.namespace,{added:H}),p.length&&p.length<u?Q(p):!d&&v.length&&a.lazy(function(){ne(v)})},V=function(e,n){if(a.sortAlsoTreeview){var t,r="asc"==a.sortOrder,s=a.sortType,i=a.sortRules;return t=r?i[a.sortType](e,n):i[a.sortType](n,e),"name"!==s&&0===t?t=r?i.name(e,n):i.name(n,e):t}return a.sortRules.name(e,n)},Z=function(t){var r,i,o,l,d,h,c=e.Deferred();return s&&clearTimeout(s),s=setTimeout(function(){(r=e(document.getElementById(t||a.navHash2Id(a.cwd().hash)))).length?((u?r:r.parent()).parents(".elfinder-navbar-wrapper").children("."+C).addClass(b).next("."+f).show(),i=re.parent().stop(!1,!0),o=i.offset().top,l=i.height(),d=o+l-r.outerHeight(),(h=r.offset().top)<o||h>d?i.animate({scrollTop:i.scrollTop()+h-o-l/3},{duration:n.durations.autoScroll,complete:function(){c.resolve()}}):c.resolve()):c.reject()},100),c},$=function(e){var n,t,r,s=e||a.cwd(),i=s.hash?[s.hash]:[];for(t=a.root(s.hash),r=a.file(t);r&&(n=r.phash)&&(i.unshift(n),t=a.root(n),r=a.file(t),!a.navHash2Elm(r.hash).hasClass(C)););return i},ee=function(e){var n=e||a.cwd(),t=n.hash,r=a.navHash2Elm(t);if(!r.length){for(;n&&n.phash;)S[n.phash]&&!a.navHash2Elm(n.hash).length&&S[n.phash].trigger("update."+a.namespace,{select:n.hash}),n=a.file(n.phash);r=a.navHash2Elm(t)}return r},ae=function(n,t){var r,s,o,l,d,h,u,f,w=a.cwd(),x=w.hash,T=void 0===t?p:t,k=function(t,s){var i,o=function(){c&&r&&(_(r.hash).show().prev(g).addClass(b),c=!1),T?Z().done(z):z()};t&&e.each(t,function(e,n){n&&Q(n),ee(a.file(e)),n&&te(n,C)}),n&&(a.api<2.1&&n.push(w),Q(n)),(i=ee()).hasClass(H)||(re.find(g+"."+H).removeClass(H),i.addClass(H)),i.parents(".elfinder-navbar-wrapper").children("."+v).addClass(C),t?a.lazy(o).done(function(){s.resolve()}):(o(),s.resolve())},I=function(e){r&&(s.remove(),r.addClass(m+(e?"":" "+C)))},E=e.Deferred();return a.navHash2Elm(x).length?k(void 0,E):(i=!0,(u=e.Deferred(),f=$(o),(l=e.map(f,function(e){var n,t,r=a.file(e),s=!!r&&a.isRoot(r),i=a.navHash2Elm(e),o=function(e,n){var t,r,s=n||1;return(r=!!(t=a.file(e))&&t.phash)&&s>1?o(r,--s):r},l=function(){var t=o(e);for(n=t;t&&!a.navHash2Elm(t).hasClass(C);)n=t,t=o(t);return t||(n=void 0,t=a.root(e)),t}();return i.hasClass(C)||!s&&r&&a.navHash2Elm(r.phash).hasClass(C)?null:(s||l===o(e)||l===o(e,2)?(n=void 0,t="tree",s||(e=o(e))):t="parents",d||(d="tree"===t?e:l),function(e,n,t){var r={cmd:e,target:n};return t&&(r.until=t),a.request({data:r,preventFail:!0})}(t,e,n))})).length?(ee(a.file(d)),h=a.navHash2Id(d),T&&Z(h),r=e("#"+h),s=e(a.res("tpl","navspinner")).insertBefore(r.children("."+y)),r.removeClass(m),e.when.apply(e,l).done(function(){var e,a,n,t={};if((a=arguments.length)>0)for(n=0;n<a;n++)e=arguments[n].tree||[],t[f[n]]=Object.assign([],L(e));u.resolve(t)}).fail(function(){u.reject()}),u):u.resolve()).done(function(e){k(e,E),I()}).fail(function(){I(!0),E.reject()}).always(function(){i=!1})),a.trigger("treesync",E),E},ne=function(n,t){n||(t&&!t.closest("div."+E).hasClass(U)||(t||re.find("div."+U)).find(g+":not(.elfinder-ro,.elfinder-na)").addClass("native-droppable"),n=!t||t.closest("div."+E).hasClass(P)?(t||re.find("div."+P)).find(g+":not(."+I+")"):e(),t&&t.children("div."+E).each(function(){ne(null,e(this))})),n.length&&a.asyncJob(function(a){e(a).droppable(X)},e.makeArray(n),{interval:20,numPerOnce:100})},te=function(n,t){var r=t==C?"."+m+":not(."+C+")":":not(."+m+")";e.each(n,function(n,s){a.navHash2Elm(s.phash).filter(r).filter(function(){return e.grep(e(this).next("."+f).children(),function(a){return!e(a).children().hasClass(h)}).length>0}).addClass(t)})},re=e(this).addClass(t).on("mouseenter mouseleave",g,function(t){var r="mouseenter"===t.type;if(!r||!se){var s,i,o=e(this);o.hasClass(w+" "+T)||(d||!r||o.data("dragRegisted")||o.hasClass(h+" "+k+" elfinder-na elfinder-wo")||(o.data("dragRegisted",!0),a.isCommandEnabled("copy",s=a.navId2Hash(o.attr("id")))&&o.draggable(a.draggable)),o.toggleClass(x,r)),r&&n.attrTitle&&((i=a.file(s||a.navId2Hash(o.attr("id")))).isroot||o.attr("title")!==(i.i18||i.name)||o.attr("title",a.path(s,!0)))}}).on("dragenter",g,function(a){if(a.originalEvent.dataTransfer){var n=e(this);n.addClass(x),n.is("."+m+":not(."+b+")")&&n.data("expandTimer",setTimeout(function(){n.is("."+m+"."+x)&&n.children("."+y).trigger("click")},500))}}).on("dragleave",g,function(a){if(a.originalEvent.dataTransfer){var n=e(this);n.data("expandTimer")&&clearTimeout(n.data("expandTimer")),n.removeClass(x)}}).on("click",g,function(n){var t=e(this),r=a.navId2Hash(t.attr("id"));a.file(r);if(t.data("longtap"))return t.removeData("longtap"),void n.stopPropagation();t.hasClass(H)||(re.find(g+"."+H).removeClass(H),t.addClass(H)),r==a.cwd().hash||t.hasClass(T)?(t.hasClass(m),a.select({selected:[r],origin:"navbar"})):a.exec("open",r).done(function(){a.one("opendone",function(){a.select({selected:[r],origin:"navbar"})})})}).on("touchstart",g,function(n){if(!(n.originalEvent.touches.length>1)){var t,r=n.originalEvent;"INPUT"!==n.target.nodeName?t=e(this).addClass(x).removeData("longtap").data("tmlongtap",setTimeout(function(e){t.data("longtap",!0),a.trigger("contextmenu",{type:"navbar",targets:[a.navId2Hash(t.attr("id"))],x:r.touches[0].pageX,y:r.touches[0].pageY})},500)):n.stopPropagation()}}).on("touchmove touchend",g,function(a){"INPUT"!==a.target.nodeName?(clearTimeout(e(this).data("tmlongtap")),e(this).removeData("tmlongtap"),"touchmove"==a.type&&e(this).removeClass(x)):a.stopPropagation()}).on("click",g+"."+m+" ."+y,function(t){var r=e(this),s=r.parent(g),i=s.next("."+f),o=e.Deferred();t.stopPropagation(),s.hasClass(C)?(s.toggleClass(b),a.lazy(function(){(s.hasClass(b)?i.children().length+i.find("div.elfinder-navbar-subtree[style*=block]").children().length:i.find("div:visible").length)>30?(i.toggle(),a.draggingUiHelper&&a.draggingUiHelper.data("refreshPositions",1),z()):i.stop(!0,!0)[s.hasClass(b)?"slideDown":"slideUp"](n.durations.slideUpDown,function(){a.draggingUiHelper&&a.draggingUiHelper.data("refreshPositions",1),z()})}).always(function(){o.resolve()})):(N.insertBefore(r),s.removeClass(m),a.request({cmd:"tree",target:a.navId2Hash(s.attr("id"))}).done(function(e){Q(Object.assign([],L(e.tree))),i.children().length&&(s.addClass(m+" "+b),i.children().length>30?(i.show(),a.draggingUiHelper&&a.draggingUiHelper.data("refreshPositions",1),z()):i.stop(!0,!0).slideDown(n.durations.slideUpDown,function(){a.draggingUiHelper&&a.draggingUiHelper.data("refreshPositions",1),z()}))}).always(function(e){N.remove(),s.addClass(C),a.one("treedone",function(){o.resolve()})})),r.data("dfrd",o)}).on("contextmenu",g,function(n){var t=e(this);t.find("input:text").length?n.stopPropagation():(n.preventDefault(),t.data("tmlongtap")||a.trigger("contextmenu",{type:"navbar",targets:[a.navId2Hash(e(this).attr("id"))],x:n.pageX,y:n.pageY}),t.addClass("ui-state-hover"),a.getUI("contextmenu").children().on("mouseenter",function(){t.addClass("ui-state-hover")}),a.bind("closecontextmenu",function(){t.removeClass("ui-state-hover")}))}).on("scrolltoview",g,function(n,t){var r=e(this);Z(r.attr("id")).done(function(){t&&"undefined"!==t.blink&&!t.blink||a.resources.blink(r,"lookme")})}).on("create."+a.namespace,function(n,t){var r=_(t.phash),s=t.move||!1,i=e(J(t)).addClass("elfinder-navbar-wrapper-tmp"),o=a.selected();s&&o.length&&a.trigger("lockfiles",{files:o}),r.prepend(i)}),se=!1,ie=a.getUI("navbar").append(re).show().on("scroll",function(){se=!0,o&&cancelAnimationFrame(o),o=requestAnimationFrame(function(){se=!1,z()})}),oe=a.sortAlsoTreeview;a.open(function(e){var n=e.data,t=L(n.files),r=a.getUI("contextmenu");n.init&&re.empty(),a.UA.iOS&&ie.removeClass("overflow-scrolling-touch").addClass("overflow-scrolling-touch"),t.length?a.lazy(function(){r.data("cmdMaps")||r.data("cmdMaps",{}),Q(t),te(t,C),ae(t)}):ae()}).add(function(e){var a=L(e.data.added);a.length&&(Q(a),te(a,m))}).change(function(n){if(!i){var t,r,s,o,l,h,c,u,p,v,m,y,H=L(n.data.changed,!0),w=H.length,x=w;e();for(e.each(S,function(e,n){n.trigger("update."+a.namespace,{change:"prepare"})});x--;)if(r=(t=H[x]).phash,(s=a.navHash2Elm(t.hash)).length){if(m=s.parent(),r){if(l=s.closest("."+f),h=_(r),c=s.parent().next(),u=G(h,t),!h.length)continue;h[0]===l[0]&&c.get(0)===u.get(0)||(u.length?u.before(m):h.append(m))}p=s.hasClass(b),v=s.hasClass(C),o=e(J(t)),s.replaceWith(o.children(g)),!d&&ne(null,m),t.dirs&&(p||v)&&(s=a.navHash2Elm(t.hash))&&s.next("."+f).children().length&&(p&&s.addClass(b),v&&s.addClass(C)),y|=-1==t.dirs}y&&z(),e.each(S,function(e,n){n.trigger("update."+a.namespace,{change:"done"})}),w&&ae(void 0,!1)}}).remove(function(n){var t,r,s,i=n.data.removed,o=i.length;for(e.each(S,function(e,n){n.trigger("update."+a.namespace,{removed:i}),n.trigger("update."+a.namespace,{change:"prepare"})});o--;)(t=a.navHash2Elm(i[o])).length&&(s=!0,r=t.closest("."+f),t.parent().detach(),r.children().length||r.hide().prev(g).removeClass(m+" "+b+" "+C));s&&a.getUI("navbar").children(".ui-resizable-handle").trigger("resize"),e.each(S,function(e,n){n.trigger("update."+a.namespace,{change:"done"})})}).bind("lockfiles unlockfiles",function(n){var t="lockfiles"==n.type,r=!!n.data.helper&&n.data.helper.data("locked"),s=t&&!r?"disable":"enable",i=e.grep(n.data.files||[],function(e){var n=a.file(e);return!(!n||"directory"!=n.mime)});e.each(i,function(e,n){var i=a.navHash2Elm(n);i.length&&!r&&(i.hasClass(k)&&i.draggable(s),i.hasClass(I)&&i.droppable(s),i[t?"addClass":"removeClass"](T))})}).bind("sortchange",function(){if(a.sortAlsoTreeview||oe!==a.sortAlsoTreeview){var n,t=[],r={},s={},i="",o=!1;a.lazy(function(){n=L(a.files()),oe=a.sortAlsoTreeview,re.empty(),Q(e.map(a.roots,function(e){var n=a.file(e);return n&&!n.phash?n:null})),Object.keys(S).length?((t=$()).length>1?(e.each(t,function(e,n){var t=a.file(a.root(n)).volumeid;0===e&&(i=t),s[t]=n,r[n]=[]}),e.each(n,function(e,a){if(!a.volumeid)return o=!0,!1;r[s[a.volumeid]||s[i]].push(a)})):o=!0,o?e.each(t,function(e,t){Q(n),ee(a.file(t)),te(n,C)}):e.each(r,function(e,n){Q(n),ee(a.file(e)),te(n,C)})):(Q(n),ee(),te(n,C)),ae()},100)}})}),this},e});
//# sourceMappingURL=../sourcemaps/ui/tree.js.map
