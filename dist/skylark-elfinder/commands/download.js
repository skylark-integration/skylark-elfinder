/**
 * skylark-elfinder - A version of elfinder that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../elFinder"],function(e){return e.prototype.commands.zipdl=function(){},e.prototype.commands.download=function(){"use strict";var e=this,n=this.fm,t=null,o=!1,i=!1,a=!1,r=window.location.pathname||"/",l=function(a,r){var l,d;if(null!==t&&(n.searchStatus.state>1?i=n.searchStatus.mixed:n.leafRoots[n.cwd().hash]&&(l=n.cwd().volumeid,$.each(a,function(e,n){if(0!==n.indexOf(l))return i=!0,!1})),o=n.isCommandEnabled("zipdl",a[0])),i){if(d=t?"zipdl":"download",!(a=$.grep(a,function(e){var o=n.file(e),i=!(!o||!t&&"directory"===o.mime||!n.isCommandEnabled(d,e));return o&&r&&!i&&n.cwdHash2Elm(o.hash).trigger("unselect"),i})).length)return[]}else if(!n.isCommandEnabled("download",a[0]))return[];return $.grep(e.files(a),function(e){var t=!(!e.read||!o&&"directory"==e.mime);return r&&!t&&n.cwdHash2Elm(e.hash).trigger("unselect"),t})};this.linkedCmds=["zipdl"],this.shortcuts=[{pattern:"shift+enter"}],this.getstate=function(e){var t=this.hashes(e),i=t.length,a=this.options.maxRequests||10;return i<1?-1:(i=l(t).length)&&(o||i<=a&&(!n.UA.IE&&!n.UA.Mobile||1==i))?0:-1},n.bind("contextmenu",function(n){var t,o,i,a=e.fm,r=null,l=function(e){var n=e.url||a.url(e.hash);return{icon:"link",node:$("<a/>").attr({href:n,target:"_blank",title:a.i18n("link")}).text(e.name).on("mousedown click touchstart touchmove touchend contextmenu",function(e){e.stopPropagation()}).on("dragstart",function(n){var t,o,i,l,d=n.dataTransfer||n.originalEvent.dataTransfer||null;if(r=null,d){d.effectAllowed="copyLink",d.setDragImage&&(r=$('<div class="elfinder-drag-helper html5-native">').append((t=e,i=t.mime,l=a.tmb(t),o='<div class="elfinder-cwd-icon '+a.mime2class(i)+' ui-corner-all"/>',l&&(o=$(o).addClass(l.className).css("background-image","url('"+l.url+"')").get(0).outerHTML),o)).appendTo($(document.body)),d.setDragImage(r.get(0),50,47)),a.UA.IE||(d.setData("elfinderfrom",window.location.href+e.phash),d.setData("elfinderfrom:"+d.getData("elfinderfrom"),""))}}).on("dragend",function(e){r&&r.remove()})}};(e.extra=null,n.data)&&(1===(t=n.data.targets||[]).length&&(o=a.file(t[0]))&&"directory"!==o.mime&&("1"!=o.url?e.extra=l(o):(e.extra={icon:"link",node:$("<a/>").attr({href:"#",title:a.i18n("getLink"),draggable:"false"}).text(o.name).on("click touchstart",function(e){if(!("touchstart"===e.type&&e.originalEvent.touches.length>1)){var n=i.parent();e.stopPropagation(),e.preventDefault(),n.removeClass("ui-state-disabled").addClass("elfinder-button-icon-spinner"),a.request({data:{cmd:"url",target:o.hash},preventDefault:!0}).always(function(e){(n.removeClass("elfinder-button-icon-spinner"),e.url)?(a.file(o.hash).url=e.url,i.replaceWith(l(o).node)):n.addClass("ui-state-disabled")})}})},(i=e.extra.node).ready(function(){requestAnimationFrame(function(){i.parent().addClass("ui-state-disabled").css("pointer-events","auto")})}))))}).one("open",function(){n.api>=2.1012&&(t=n.getCommand("zipdl")),a=n.cookieEnabled&&n.api>2.1038&&!n.isCORS}),this.exec=function(n){var t,d,s,c,u,f,p,h,m,g=this.hashes(n),v=this.fm,y=(v.options.url,l(g,!0)),w=$.Deferred(),b="",k={},C=!1,U=function(e){var n;"function"==typeof MouseEvent?n=new MouseEvent("click"):(n=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),v.pauseUnloadCheck(!0),e.dispatchEvent(n)},E=function(e){var n="elfdl"+e;2===document.cookie.split(n+"=").length?(f&&clearTimeout(f),document.cookie=n+"=; path="+r+"; max-age=0",D()):setTimeout(function(){E(e)},200)},D=function(){v.ui.notify.children(".elfinder-notify-download").length&&v.notify({type:"download",cnt:-1})},T=[];if(!y.length)return w.reject();if(u=$.grep(y,function(e){return"directory"!==e.mime}).length,s=$("<a>").hide().appendTo("body"),c="string"==typeof s.get(0).download,o&&(u!==y.length||u>=(this.options.minFilesZipdl||1)))return s.remove(),C=!c&&v.UA.Mobile,i?(k={},$.each(y,function(e,n){var t=n.hash.split("_",2);k[t[0]]?k[t[0]].push(n.hash):k[t[0]]=[n.hash]}),!C&&v.UA.Mobile&&Object.keys(k).length>1&&(C=!0)):k=[$.map(y,function(e){return e.hash})],w=v.sequence($.map(k,function(n){return t=n,function(){var n,o,i,a=$.Deferred(),r=v.file(v.root(t[0])),l=1===t.length,s=r?r.i18||r.name:null;return l?(n=v.file(t[0]))&&(o=n.i18||n.name):($.each(t,function(){var e=v.file(this);if(!e||i&&i!==e.phash)return i=null,!1;i=e.phash}),i&&(n=v.file(i))&&(o=(n.i18||n.name)+"-"+t.length)),o&&(s=o),s&&(s=" ("+s+")"),v.request({data:{cmd:"zipdl",targets:t},notify:{type:"zipdl",cnt:1,hideCnt:!0,msg:v.i18n("ntfzipdl")+s},cancel:!0,eachCancel:!0,preventDefault:!0}).done(function(n){var i,r,l,s,u,f,p={},h="dlw"+ +new Date,m=function(n){l=$("<a/>").attr("href",n).attr("download",v.escape(o)).on("click",function(){a.resolve(),r&&r.elfinderdialog("destroy")}),C?(l.attr("target","_blank").append('<span class="elfinder-button-icon elfinder-button-icon-download"></span>'+v.escape(o)),p[v.i18n("btnCancel")]=function(){r.elfinderdialog("destroy")},r=e.fmDialog(l,{title:v.i18n("link"),buttons:p,width:"200px",destroyOnClose:!0,close:function(){"resolved"!==a.state()&&a.resolve()}})):(U(l.hide().appendTo("body").get(0)),l.remove())};n.error?(v.error(n.error),a.resolve()):n.zipdl&&(i=n.zipdl,o?(f=v.splitFileExtention(i.name||""),o+=f[1]?"."+f[1]:".zip"):o=i.name,c&&(!v.UA.Safari||v.isSameOrigin(v.options.url))||C?(d=v.options.url+(-1===v.options.url.indexOf("?")?"?":"&")+"cmd=zipdl&download=1",$.each([t[0],i.file,o,i.mime],function(e,n){d+="&targets%5B%5D="+encodeURIComponent(n)}),$.each(v.customData,function(e,n){d+="&"+encodeURIComponent(e)+"="+encodeURIComponent(n)}),d+="&"+encodeURIComponent(o),v.hasParrotHeaders()?v.getBinaryByUrl({url:d},function(e){e instanceof Blob?(d=(window.URL||window.webkitURL).createObjectURL(e),m(d)):v.error(["errUploadTransfer",v.i18n("kindZIP")])}):m(d)):(s=$('<form action="'+v.options.url+'" method="post" target="'+h+'" style="display:none"/>').append('<input type="hidden" name="cmd" value="zipdl"/>').append('<input type="hidden" name="download" value="1"/>'),$.each([t[0],i.file,o,i.mime],function(e,n){s.append('<input type="hidden" name="targets[]" value="'+v.escape(n)+'"/>')}),$.each(v.customData,function(e,n){s.append('<input type="hidden" name="'+e+'" value="'+v.escape(n)+'"/>')}),s.attr("target",h).appendTo("body"),u=$('<iframe style="display:none" name="'+h+'">').appendTo("body").ready(function(){s.submit().remove(),a.resolve(),setTimeout(function(){u.remove()},2e4)})))}).fail(function(e){e&&v.error(e),a.resolve()}),a.promise()};var t})).always(function(){v.trigger("download",{files:y})});for(T=[],h=$.Deferred().done(function(e){for(t=0;t<e.length;t++)d=e[t],a&&d.substr(0,v.options.url.length)===v.options.url&&(p=v.getRequestId(),T.push(p),d+="&cpath="+r+"&reqid="+p,f=setTimeout(function(){v.notify({type:"download",cnt:1,cancel:v.UA.IE||v.UA.Edge?void 0:function(){T.length&&$.each(T,function(){v.request({data:{cmd:"abort",id:this},preventDefault:!0})}),T=[]}})},v.notifyDelay),E(p)),!c||v.UA.Safari&&!v.isSameOrigin(d)?v.UA.Mobile?setTimeout(function(){window.open(d)||(v.error("errPopup"),f&&cleaerTimeout(f),D())},100):b+='<iframe class="downloader" id="downloader-'+y[t].hash+'" style="display:none" src="'+d+'"/>':U(s.attr("href",d).attr("download",v.escape(y[t].name)).get(0));s.remove(),$(b).appendTo("body").ready(function(){setTimeout(function(){$(b).each(function(){$("#"+$(this).attr("id")).remove()})},2e4+1e4*t)}),v.trigger("download",{files:y}),w.resolve()}),u=y.length,m=[],t=0;t<y.length;t++)v.openUrl(y[t].hash,!0,function(e){e&&m.push(e),--u<1&&h.resolve(m)});return w}},e});
//# sourceMappingURL=../sourcemaps/commands/download.js.map
