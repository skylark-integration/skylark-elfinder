/**
 * skylark-elfinder - A version of elfinder that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../elFinder"],function(e){return e.prototype.commands.edit=function(){"use strict";var e,n=this,t=this.fm,i=t.res("class","editing"),o=[],r=[],a=!1,c=function(e){var i,o=$('<select class="ui-corner-all"/>');return e&&$.each(e,function(e,n){i=t.escape(n.value),o.append('<option value="'+i+'">'+(n.caption?t.escape(n.caption):i)+"</option>")}),$.each(n.options.encodings,function(e,n){o.append('<option value="'+n+'">'+n+"</option>")}),o},s=function(e){var i,c,s,f=e.length;return f>1&&(i=e[0].mime,c=e[0].name.replace(/^.*(\.[^.]+)$/,"$1")),$.grep(e,function(e){var l;return!s&&"directory"!==e.mime&&((l=e.read&&(a||t.mimeIsText(e.mime)||-1!==$.inArray(e.mime,1===f?o:r))&&(!n.onlyMimes.length||-1!==$.inArray(e.mime,n.onlyMimes))&&(1===f||e.mime===i&&e.name.substr(-1*c.length)===c)&&!!t.uploadMimeCheck(e.mime,e.phash)&&h(e,f)&&Object.keys(u).length)||(s=!0),l)})},f=function(e){var n,i=t.file(e);t.request({cmd:"info",targets:[e],preventDefault:!0}).done(function(e){var o;e&&e.files&&e.files.length&&(n=e.files[0],i.ts==n.ts&&i.size==n.size||(o={changed:[n]},t.updateCache(o),t.change(o)))})},l=function(e,o,r,a,s,l){var u,m,h,p,g,y,b,k,x,w=$.Deferred(),C=!1,A=function(){return!!C||(t.toast({mode:"warning",msg:t.i18n("nowLoading")}),!1)},j=function(){l&&Array.isArray(l)&&$.each(l,function(){this.msg&&t.toast(this)})},E=function(){var e,n,i,o=p?p.val():void 0,r=$.Deferred().fail(function(e){h.show().find("button.elfinder-btncnt-0,button.elfinder-btncnt-1").hide()});return A()?(u.editor&&(u.editor.save(u[0],u.editor.instance),(e=u.editor.confObj).info&&(e.info.schemeContent||e.info.arrayBufferContent)&&(o="scheme")),n=z(),D(n),n.promise?(i=setTimeout(function(){t.notify({type:"chkcontent",cnt:1,hideCnt:!0,cancel:function(){n.reject()}})},100),n.always(function(){i&&clearTimeout(i),t.notify({type:"chkcontent",cnt:-1})}).done(function(e){w.notifyWith(u,[o,u.data("hash"),m,r])}).fail(function(e){r.reject(e)})):w.notifyWith(u,[o,u.data("hash"),m,r]),r):r.resolve()},I=function(){A()&&E().fail(function(e){e&&t.error(e)})},M=function(){u.elfinderdialog("close")},T=function(){A()&&(h.hide(),E().done(function(){C=!1,h.show(),M()}).fail(function(e){h.show(),e&&t.error(e)}))},O=function(){if(A()){var e=m,r=o.phash,a=function(n){l.addClass(i).fadeIn(function(){n&&t.error(n)}),m=e,t.disable()},c=function(){n.mime=H.mime||o.mime,n.prefix=(H.name||o.name).replace(/ \d+(\.[^.]+)?$/,"$1"),n.requestCmd="mkfile",n.nextAction={},n.data={target:r},$.proxy(t.res("mixin","make"),n)().done(function(e){var n;e.added&&e.added.length?(n=u.data("hash"),u.data("hash",e.added[0].hash),E().done(function(){C=!1,h.show(),M(),l.fadeIn()}).fail(function(){t.exec("rm",[e.added[0].hash],{forceRm:!0,quiet:!0}),u.data("hash",n),h.find("button.elfinder-btncnt-2").hide(),a()})):a()}).progress(function(e){e&&"errUploadMime"===e&&u.trigger("saveAsFail")}).fail(a).always(function(){delete n.mime,delete n.prefix,delete n.nextAction,delete n.data}),t.trigger("unselectfiles",{files:[o.hash]})},s=null,f=null,l=t.getUI().children("."+n.dialogClass+":visible");h.is(":hidden")&&(l=l.add(h)),l.removeClass(i).fadeOut(),t.enable(),t.searchStatus.state<2&&r!==t.cwd().hash?s=t.exec("open",[r],{thash:r}):t.file(r)||(f=t.request({cmd:"info",targets:[r]})),$.when([s,f]).done(function(){f?t.one("infodone",function(){t.file(r)?c():a("errFolderNotFound")}):s?t.one("cwdrender",c):c()}).fail(a)}},F=function(){var e,n,i=$.Deferred();return C?(u.editor&&u.editor.save(u[0],u.editor.instance),(e=z())&&e.promise?(n=setTimeout(function(){t.notify({type:"chkcontent",cnt:1,hideCnt:!0,cancel:function(){e.reject()}})},100),e.always(function(){n&&clearTimeout(n),t.notify({type:"chkcontent",cnt:-1})}).done(function(e){i.resolve(m!==e)}).fail(function(e){i.resolve(e||void 0!==m)})):i.resolve(m!==e),i):i.resolve(!1)},S={title:t.escape(o.name),width:(x=t.options.dialogContained?t.getUI():$(window),k="string"==typeof n.options.dialogWidth&&(b=n.options.dialogWidth.match(/(\d+)%/))?parseInt(x.width()*(b[1]/100)):parseInt(n.options.dialogWidth||650),Math.min(k,x.width())),height:function(){if(n.options.dialogHeight){var e,i,o=t.options.dialogContained?t.getUI():$(window);return i="string"==typeof n.options.dialogHeight&&(e=n.options.dialogHeight.match(/(\d+)%/))?parseInt(o.height()*(e[1]/100)):parseInt(n.options.dialogHeight||o.height()),Math.min(i,o.height())}}(),buttons:{},cssClass:i,maxWidth:"window",maxHeight:"window",allowMinimize:!0,allowMaximize:!0,openMaximized:v()||s&&s.info&&s.info.openMaximized,btnHoverFocus:!1,closeOnEscape:!1,propagationEvents:["mousemove","mouseup","click"],minimize:function(){var e;u.editor&&h.closest(".ui-dialog").is(":hidden")&&(e=u.editor.confObj).info&&e.info.syncInterval&&f(o.hash)},close:function(){var e=function(){var e;w.resolve(),u.editor&&(u.editor.close(u[0],u.editor.instance),(e=u.editor.confObj).info&&e.info.syncInterval&&f(o.hash)),u.elfinderdialog("destroy")},i=void 0!==H.name,r=i?{label:"btnSaveAs",callback:function(){requestAnimationFrame(O)}}:{label:"btnSaveClose",callback:function(){E().done(function(){e()})}};F().done(function(o){var a=["confirmNotSave"];o?("string"==typeof o&&a.unshift(o),t.confirm({title:n.title,text:a,accept:r,cancel:{label:"btnClose",callback:e},buttons:i?null:[{label:"btnSaveAs",callback:function(){requestAnimationFrame(O)}}]})):e()})},open:function(){var n,i,a;if(u.initEditArea.call(u,e,o,r,t),u.editor){if((n=u.editor.load(u[0])||null)&&n.done)n.always(function(){C=!0}).done(function(e){u.editor.instance=e,u.editor.focus(u[0],u.editor.instance),D(z()),requestAnimationFrame(function(){h.trigger("resize")})}).fail(function(e){e&&t.error(e),u.elfinderdialog("destroy")}).always(j);else{if(C=!0,n&&("string"==typeof n||Array.isArray(n)))return t.error(n),void u.elfinderdialog("destroy");u.editor.instance=n,u.editor.focus(u[0],u.editor.instance),D(z()),requestAnimationFrame(function(){h.trigger("resize")}),j()}(i=u.editor.confObj).info&&i.info.syncInterval&&(a=parseInt(i.info.syncInterval))&&setTimeout(function(){q(a)},a)}else C=!0,D(z())},resize:function(e,n){u.editor&&u.editor.resize(u[0],u.editor.instance,e,n||{})}},z=function(){var e=u.getContent.call(u,u[0]);return void 0!==e&&!1!==e&&null!==e||(e=$.Deferred().reject()),e},D=function(e){e&&e.promise?e.done(function(e){m=e}):m=e},q=function(e){h.is(":visible")&&(f(o.hash),setTimeout(function(){q(e)},e))},U=function(){p&&F().done(function(e){e?p.attr("title",t.i18n("saveAsEncoding")).addClass("elfinder-edit-changed"):p.attr("title",t.i18n("openAsEncoding")).removeClass("elfinder-edit-changed")})},H={};if(s&&(s.html&&(u=$(s.html)),g={init:s.init||null,load:s.load,getContent:s.getContent||null,save:s.save,beforeclose:"function"==typeof s.beforeclose?s.beforeclose:void 0,close:"function"==typeof s.close?s.close:function(){},focus:"function"==typeof s.focus?s.focus:function(){},resize:"function"==typeof s.resize?s.resize:function(){},instance:null,doSave:I,doCancel:M,doClose:T,file:o,fm:t,confObj:s,trigger:function(e,n){t.trigger("editEditor"+e,Object.assign({},s.info||{},n))}}),!u){if(!t.mimeIsText(o.mime))return w.reject("errEditorNotFound");u=$('<textarea class="elfinder-file-edit" rows="20" id="'+e+'-ta"></textarea>').on("input propertychange",U),s&&s.info&&!s.info.useTextAreaEvent||u.on("keydown",function(e){var n,t,i=e.keyCode;e.stopPropagation(),i==$.ui.keyCode.TAB&&(e.preventDefault(),this.setSelectionRange&&(n=this.value,t=this.selectionStart,this.value=n.substr(0,t)+"\t"+n.substr(this.selectionEnd),t+=1,this.setSelectionRange(t,t))),(e.ctrlKey||e.metaKey)&&(i!="Q".charCodeAt(0)&&i!="W".charCodeAt(0)||(e.preventDefault(),M()),i=="S".charCodeAt(0)&&(e.preventDefault(),I()))}).on("mouseenter",function(){this.focus()}),u.initEditArea=function(e,n,t){u.hide().val(t),this._setupSelEncoding(t)}}return u._setupSelEncoding=function(e){var n=a&&"unknown"!==a?[{value:a}]:[],i=$("<select/>").hide(),r=function(e){e&&i.appendTo(p.parent()),i.empty().append($("<option/>").text(p.val())),p.width(i.width())};""!==e&&a&&"UTF-8"===a||n.push({value:"UTF-8"}),p=c(n).on("touchstart",function(e){e.stopPropagation()}).on("change",function(){F().done(function(e){e||""===z()||(M(),d(o,p.val(),s).fail(function(e){e&&t.error(e)}))}),r()}).on("mouseover",U),u.parent().next().prepend($('<div class="ui-dialog-buttonset elfinder-edit-extras"/>').append(p)),r(!0)},u.data("hash",o.hash),g&&(u.editor=g,"function"==typeof g.beforeclose&&(S.beforeclose=function(){return g.beforeclose(u[0],g.instance)}),"function"==typeof g.init&&(u.initEditArea=g.init),"function"==typeof g.getContent&&(u.getContent=g.getContent)),u.initEditArea||(u.initEditArea=function(){}),u.getContent||(u.getContent=function(){return u.val().replace(/\s+$/,"")}),s&&s.info&&s.info.preventGet||(S.buttons[t.i18n("btnSave")]=I,S.buttons[t.i18n("btnSaveClose")]=T,S.buttons[t.i18n("btnSaveAs")]=O,S.buttons[t.i18n("btnCancel")]=M),s&&"function"==typeof s.prepare&&s.prepare(u,S,o),h=n.fmDialog(u,S).attr("id",e).on("keydown keyup keypress",function(e){e.stopPropagation()}).css({overflow:"hidden",minHeight:"7em"}).addClass("elfinder-edit-editor").closest(".ui-dialog").on("changeType",function(e,n){if(n.extention&&n.mime){n.extention,n.mime;var i=$(this).children(".ui-dialog-buttonpane").children(".ui-dialog-buttonset");i.children(".elfinder-btncnt-0,.elfinder-btncnt-1").hide(),H.name=t.splitFileExtention(o.name)[0]+"."+n.extention,H.mime=n.mime,n.keepEditor||i.children(".elfinder-btncnt-2").trigger("click")}}),y=(t.options.dialogContained?t.getUI():$(window)).width(),h.width()>y&&h.width(y),w.promise()},d=function(e,i,o){var r,a,s,f=e.hash,u=(t.options,$.Deferred()),m="edit-"+t.namespace+"-"+e.hash,h=t.getUI().find("#"+m),p=i||0,g=!1;if(h.length)return h.elfinderdialog("toTop"),u.resolve();if(!(e.read&&(e.write||o.info&&o.info.converter)))return a=["errOpen",e.name,"errPerm"],u.reject(a);if(o&&o.info){if("function"==typeof o.info.edit)return(s=o.info.edit.call(t,e,o)).promise?s.done(function(){u.resolve()}).fail(function(e){u.reject(e)}):s?u.resolve():u.reject(),u;g=o.info.preventGet||o.info.noContent,o.info.urlAsContent||g?(r=$.Deferred(),o.info.urlAsContent?t.url(f,{async:!0,onetime:!0,temporary:!0}).done(function(e){r.resolve({content:e})}):r.resolve({})):(p&&(e.encoding=p,t.cache(e,"change")),r=t.request({data:{cmd:"get",target:f,conv:p,_t:e.ts},options:{type:"get",cache:!0},notify:{type:"file",cnt:1},preventDefault:!0})),r.done(function(i){var r,a,s;i.doconv?t.confirm({title:n.title,text:"unknown"===i.doconv?"confirmNonUTF8":"confirmConvUTF8",accept:{label:"btnConv",callback:function(){u=d(e,r.val(),o)}},cancel:{label:"btnCancel",callback:function(){u.reject()}},optionsCallback:function(e){e.create=function(){var e=$('<div class="elfinder-dialog-confirm-encoding"/>'),n={value:i.doconv};"unknown"===i.doconv&&(n.caption="-"),r=c([n]),$(this).next().find(".ui-dialog-buttonset").prepend(e.append($("<label>"+t.i18n("encoding")+" </label>").append(r)))}}}):(!g&&t.mimeIsText(e.mime)&&(a=new RegExp("^(data:"+e.mime.replace(/([.+])/g,"\\$1")+";base64,)","i"),o.info.dataScheme?window.btoa&&!i.content.match(a)&&(i.content="data:"+e.mime+";base64,"+btoa(i.content)):window.atob&&(s=i.content.match(a))&&(i.content=atob(i.content.substr(s[1].length)))),l(m,e,i.content,i.encoding,o,i.toasts).done(function(e){u.resolve(e)}).progress(function(e,n,i,o){var r=this;n&&(f=n),t.request({options:{type:"post"},data:{cmd:"put",target:f,encoding:e||i.encoding,content:i},notify:{type:"save",cnt:1},syncOnFail:!0,preventFail:!0,navigate:{target:"changed",toast:{inbuffer:{msg:t.i18n(["complete",t.i18n("btnSave")])}}}}).fail(function(e){u.reject(e),o.reject()}).done(function(e){requestAnimationFrame(function(){r.trigger("focus"),r.editor&&r.editor.focus(r[0],r.editor.instance)}),o.resolve()})}).fail(function(e){u.reject(e)}))}).fail(function(n){var i=t.parseError(n);i=Array.isArray(i)?i[0]:i,e.encoding&&(e.encoding="",t.cache(e,"change")),"errConvUTF8"!==i&&t.sync(),u.reject(n)})}return u.promise()},u={},m={info:{id:"textarea",name:"TextArea",useTextAreaEvent:!0},load:function(e){this.trigger("Prepare",{node:e,editorObj:void 0,instance:void 0,opts:{}}),e.setSelectionRange&&e.setSelectionRange(0,0),$(e).trigger("focus").show()},save:function(){}},h=function(i,o){var r=n.options.editors||[],a=t.cwd().write;return e=t.storage("storedEditors")||{},u={},r.length||(r=[m]),$.each(r,function(e,n){var r;(1===o||!n.info.single)&&(n.info&&n.info.converter?a:i.write)&&(i.size>0||!n.info.converter&&!1!==n.info.canMakeEmpty&&t.mimesCanMakeEmpty[i.mime])&&(!n.info.maxSize||i.size<=n.info.maxSize)&&function(e,n){if(n){if("*"===n[0]||-1!==$.inArray(e,n))return!0;var i,o;for(o=n.length,i=0;i<o;i++)if(0===e.indexOf(n[i]))return!0;return!1}return t.mimeIsText(e)}(i.mime,n.mimes||null)&&function(e,n){if(!n||!n.length)return!0;var t,i,o=e.replace(/^.+\.([^.]+)|(.+)$/,"$1$2").toLowerCase();for(i=n.length,t=0;t<i;t++)if(o===n[t].toLowerCase())return!0;return!1}(i.name,n.exts||null)&&"function"==typeof n.load&&"function"==typeof n.save&&(r=n.info.name?n.info.name:"Editor "+e,n.id=n.info.id?n.info.id:"editor"+e,n.name=r,n.i18n=t.i18n(r),u[n.id]=n)}),!!Object.keys(u).length},p=function(n,i){n&&i&&($.isPlainObject(e)||(e={}),e[n]=i.id,t.storage("storedEditors",e),t.trigger("selectfiles",{files:t.selected()}))},g=function(){var e=t.storage("useStoredEditor");return e?e>0:n.options.useStoredEditor},v=function(){var e=t.storage("editorMaximized");return e?e>0:n.options.editorMaximized},y=function(e,n){var i=[];return $.each(u,function(o,r){i.push({label:t.escape(r.i18n),icon:r.info&&r.info.icon?r.info.icon:"edit",options:{iconImg:r.info&&r.info.iconImg?t.baseUrl+r.info.iconImg:void 0},callback:function(){p(e[0].mime,r),n&&n.call(r)}})}),i},b=function(n){var t=e[n];return t&&Object.keys(u).length?u[function(e){return e.toLowerCase().replace(/ +/g,"")}(t)]:void 0};this.getEncSelect=c,this.shortcuts=[{pattern:"ctrl+e"}],this.init=function(){var e,n,t=this,i=this.fm,c=this.options,s=[];this.onlyMimes=this.options.mimes||[],i.one("open",function(){c.editors&&Array.isArray(c.editors)&&(i.trigger("canMakeEmptyFile",{mimes:Object.keys(i.storage("mkfileTextMimes")||{}).concat(c.makeTextMimes||["text/plain"])}),$.each(c.editors,function(e,n){n.info&&n.info.cmdCheck&&s.push(n.info.cmdCheck)}),s.length?i.api>=2.103?n=i.request({data:{cmd:"editor",name:s,method:"enabled"},preventDefault:!0}).done(function(n){e=n}).fail(function(){e={}}):(e={},n=$.Deferred().resolve()):n=$.Deferred().resolve(),n.always(function(){e&&(c.editors=$.grep(c.editors,function(n){return!n.info||!n.info.cmdCheck||!!e[n.info.cmdCheck]})),$.each(c.editors,function(e,n){n.setup&&"function"==typeof n.setup&&n.setup.call(n,c,i),n.disabled||(n.mimes&&Array.isArray(n.mimes)&&(o=o.concat(n.mimes),n.info&&n.info.single||(r=r.concat(n.mimes))),!a&&n.mimes&&"*"===n.mimes[0]&&(a=!0),n.info||(n.info={}),n.info.integrate&&i.trigger("helpIntegration",Object.assign({cmd:"edit"},n.info.integrate)),n.info.canMakeEmpty&&i.trigger("canMakeEmptyFile",{mimes:Array.isArray(n.info.canMakeEmpty)?n.info.canMakeEmpty:n.mimes}))}),o=($.uniqueSort||$.unique)(o),r=($.uniqueSort||$.unique)(r),c.editors=$.grep(c.editors,function(e){return!e.disabled})}))}).bind("select",function(){u=null}).bind("contextmenucreate",function(e){var n,o,r=function(e){var n=t.title;i.one("contextmenucreatedone",function(){t.title=n}),t.title=i.escape(e.i18n),e.info&&e.info.iconImg&&(t.contextmenuOpts={iconImg:i.baseUrl+e.info.iconImg}),delete t.variants};t.contextmenuOpts=void 0,"files"===e.data.type&&t.enabled()&&(n=i.file(e.data.targets[0]),h(n,e.data.targets.length)&&(Object.keys(u).length>1?g()&&(o=b(n.mime))?(r(o),t.extra={icon:"menu",node:$("<span/>").attr({title:i.i18n("select")}).on("click touchstart",function(e){if(!("touchstart"===e.type&&e.originalEvent.touches.length>1)){var n=$(this);e.stopPropagation(),e.preventDefault(),i.trigger("contextmenu",{raw:y(i.selectedFiles(),function(){var e=i.selected();i.exec("edit",e,{editor:this}),i.trigger("selectfiles",{files:e})}),x:n.offset().left,y:n.offset().top})}})}):(delete t.extra,t.variants=[],$.each(u,function(e,n){t.variants.push([{editor:n},n.i18n,n.info&&n.info.iconImg?i.baseUrl+n.info.iconImg:"edit"])})):(r(u[Object.keys(u)[0]]),delete t.extra)))}).bind("canMakeEmptyFile",function(e){if(e.data&&e.data.resetTexts){var n=i.arrayFlip(t.options.makeTextMimes||["text/plain"]),o=t.getMkfileHides();$.each(i.storage("mkfileTextMimes")||{},function(e,t){n[e]||(delete i.mimesCanMakeEmpty[e],delete o[e])}),i.storage("mkfileTextMimes",null),Object.keys(o).length?i.storage("mkfileHides",o):i.storage("mkfileHides",null)}})},this.getstate=function(e){var n=this.files(e),t=n.length;return t&&s(n).length==t?0:-1},this.exec=function(e,n){var t,i,o=this.fm,r=s(this.files(e)),a=$.map(r,function(e){return e.hash}),c=[],f=n&&n.editor?n.editor:null,l=$(n&&n._currentNode?n._currentNode:o.cwdHash2Elm(a[0])),m=$.Deferred();return null===u&&h(r[0],a.length),l.length||(l=o.getUI("cwd")),(i=$.Deferred(),!f&&Object.keys(u).length>1?g()&&(f=b(r[0].mime))?i.resolve(f):(o.trigger("contextmenu",{raw:y(r,function(){i.resolve(this)}),x:l.offset().left,y:l.offset().top+22,opened:function(){o.one("closecontextmenu",function(){requestAnimationFrame(function(){"pending"===i.state()&&i.reject()})})}}),o.trigger("selectfiles",{files:a}),i):(Object.keys(u).length>1&&f&&p(r[0].mime,f),i.resolve(f||(Object.keys(u).length?u[Object.keys(u)[0]]:null)))).done(function(e){for(;t=r.shift();)c.push(d(t,t.encoding||void 0,e).fail(function(e){e&&o.error(e)}));c.length?$.when.apply(null,c).done(function(){m.resolve()}).fail(function(){m.reject()}):m.reject()}).fail(function(){m.reject()}),m},this.getMkfileHides=function(){return t.storage("mkfileHides")||t.arrayFlip(n.options.mkfileHideMimes||[])}},e});
//# sourceMappingURL=../sourcemaps/commands/edit.js.map
