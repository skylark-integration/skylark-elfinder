/**
 * skylark-elfinder - A version of elfinder that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../elFinder"],function(e){return(e.prototype.commands.restore=function(){"use strict";var e=this,t=this.fm,n=0,r=function(e){var i,o=$.Deferred(),c=[],a=[],s=[],h=[];return o._xhrReject=function(){$.each(s,function(){this&&this.reject&&this.reject()}),i&&i._xhrReject()},$.each(e,function(e,t){"directory"===t.mime?c.push(t):a.push(t)}),c.length?($.each(c,function(e,n){s.push(t.request({data:{cmd:"open",target:n.hash},preventDefault:!0,asNotOpen:!0})),h[e]=n.hash}),$.when.apply($,s).fail(function(){o.reject()}).done(function(){var e=[];$.each(arguments,function(t,r){r.files&&(r.files.length?e=e.concat(r.files):e.push({hash:"fakefile_"+n++,phash:h[t],mime:"fakefile",name:"fakefile",ts:0}))}),t.cache(e),i=r(e).done(function(e){a=a.concat(e),o.resolve(a)})})):o.resolve(a),o};this.restore=function(e,i,o,c){var a,s,h,f={},u=[],l=!1,d=c||{},p=+new Date;t.lockfiles({files:o}),a=$.map(i,function(e){return"directory"===e.mime?e.hash:null}),e.done(function(){a&&t.exec("rm",a,{forceRm:!0,quiet:!0})}).always(function(){t.unlockfiles({files:o})}),s=setTimeout(function(){t.notify({type:"search",id:p,cnt:1,hideCnt:!0,cancel:function(){h&&h._xhrReject(),e.reject()}})},t.notifyDelay),n=0,h=r(i).always(function(){s&&clearTimeout(s),t.notify({type:"search",id:p,cnt:-1,hideCnt:!0})}).fail(function(){e.reject("errRestore","errFileNotFound")}).done(function(n){var r=["errRestore","errFolderNotFound"],i="";n.length?($.each(n,function(e,n){for(var r,o,c,a=n.phash;a;){if(o=t.trashes[a]){if(!f[o]){if(l)return u.push(n.hash),null;f[o]={},l=!0}""===(c=(c=t.path(n.hash).substr(t.path(a).length).replace(/\\/g,"/")).replace(/\/[^\/]+?$/,""))&&(c="/"),f[o][c]||(f[o][c]=[]),"fakefile"===n.mime?t.updateCache({removed:[n.hash]}):f[o][c].push(n.hash),(!i||i.length>c.length)&&(i=c);break}(r=t.file(a))?a=r.phash:(a=!1,$.each(t.trashes,function(e){var r=t.file(e),i=t.path(e);if((!r.volumeid||0===n.hash.indexOf(r.volumeid))&&0===t.path(n.hash).indexOf(i))return a=e,!1}))}}),l?$.each(f,function(n,c){var a=Object.keys(c),s=a.length;t.request({data:{cmd:"mkdir",target:n,dirs:a},notify:{type:"chkdir",cnt:s},preventFail:!0}).fail(function(n){e.reject(n),t.unlockfiles({files:o})}).done(function(n){var o;(o=n.hashes)?t.getCommand("paste")?t.one("mkdirdone",function(){var n=!1;$.each(c,function(c,a){o[c]&&(a.length?t.file(o[c])?(t.clipboard(a,!0),t.exec("paste",[o[c]],{_cmd:"restore",noToast:d.noToast||c!==i}).done(function(e){e&&(e.error||e.warning)&&(n=!0)}).fail(function(){n=!0}).always(function(){--s<1&&(e[n?"reject":"resolve"](),u.length&&t.exec("restore",u))})):e.reject(r):--s<1&&(e.resolve(),u.length&&t.exec("restore",u)))})}):e.reject(["errRestore","errCmdNoSupport","(paste)"]):e.reject(r)})}):e.reject(r)):(e.reject("errFileNotFound"),a&&t.exec("rm",a,{forceRm:!0,quiet:!0}))})},this.linkedCmds=["copy","paste","mkdir","rm"],this.updateOnSelect=!1,this.init=function(){e=this,t=this.fm},this.getstate=function(e,n){return(e=e||t.selected()).length&&$.grep(e,function(e){var n=t.file(e);return!(!n||n.locked||t.isRoot(n))}).length==e.length?0:-1},this.exec=function(n,r){var i=$.Deferred().fail(function(e){e&&t.error(e)}),o=e.files(n);return o.length?($.each(o,function(e,n){return t.isRoot(n)?!i.reject(["errRestore",n.name]):n.locked?!i.reject(["errLocked",n.name]):void 0}),"pending"===i.state()&&this.restore(i,o,n,r),i):i.reject()}}).prototype={forceLoad:!0},e});
//# sourceMappingURL=../sourcemaps/commands/restore.js.map
