{"version":3,"sources":["commands/getfile.js"],"names":["define","elFinder","prototype","commands","getfile","self","this","fm","alwaysEnabled","callback","options","getFileCallback","_disabled","getstate","select","files","o","sel","cnt","length","$","grep","file","mime","folders","read","multiple","exec","hashes","i","dim","opts","url","option","tmb","dfrd","Deferred","done","data","res","oncomplete","hide","destroy","fail","error","onerror","trigger","e","message","result","onlyURL","map","f","req","reject","baseUrl","push","request","cmd","target","hash","notify","type","hideCnt","preventDefault","bind","getPath","path","phash","dfd","always","resolve","width","height","split","getImgSize","indexOf","rfile","when","apply","forceLoad"],"mappings":";;;;;;;AAAAA,QACC,eACC,SAASC,GAoKV,OA5JCA,EAASC,UAAUC,SAASC,QAAU,WACtC,aACA,IAAIC,EAASC,KACZC,EAASD,KAAKC,GAWfD,KAAKE,eAAgB,EACrBF,KAAKG,SAAgBF,EAAGG,QAAQC,gBAChCL,KAAKM,UAAyC,mBAAlBN,KAAa,SAEzCA,KAAKO,SAAW,SAASC,GACxB,IAfkBC,EACbC,EAcDC,EAAMX,KAAKS,MAAMD,GACpBI,EAAMD,EAAIE,OAEX,OAAOb,KAAKG,UAAYS,IAlBNH,EAkBoBE,EAjBjCD,EAAIX,EAAKK,QAEbK,EAAQK,EAAEC,KAAKN,EAAO,SAASO,GAC9B,QAAqB,aAAbA,EAAKC,OAAuBP,EAAEQ,UAAYF,EAAKG,QAGjDT,EAAEU,UAA4B,GAAhBX,EAAMI,OAAcJ,MAWCI,QAAUD,EAAM,GAAK,GAGjEZ,KAAKqB,KAAO,SAASC,GACpB,IA+CCC,EAAGP,EAAMQ,EA/CNvB,EAAQD,KAAKC,GAChBwB,EAAQzB,KAAKI,QACbK,EAAQT,KAAKS,MAAMa,GACnBV,EAAQH,EAAMI,OACda,EAAQzB,EAAG0B,OAAO,OAClBC,EAAQ3B,EAAG0B,OAAO,UAClBE,EAAQf,EAAEgB,WACRC,KAAK,SAASC,GACd,IAAIC,EACHF,EAAO,WACiB,SAAnBN,EAAKS,WACRjC,EAAGkC,OAC0B,WAAnBV,EAAKS,YACfjC,EAAGmC,WAGLC,EAAO,SAASC,GACK,SAAhBb,EAAKc,QACRtC,EAAGkC,OACuB,WAAhBV,EAAKc,QACftC,EAAGmC,UAEHE,GAASrC,EAAGqC,MAAMA,IAIrBrC,EAAGuC,QAAQ,WAAY/B,MAAQuB,IAE/B,IACCC,EAAMlC,EAAKI,SAAS6B,EAAM/B,GACzB,MAAMwC,GAEP,YADAJ,GAAM,8BAA+BI,EAAEC,UAIrB,iBAART,GAAwC,mBAAbA,EAAIF,KACzCE,EAAIF,KAAKA,GAAMM,KAAKA,GAEpBN,MAGHY,EAAS,SAAS3B,GACjB,OAAOS,EAAKmB,QACTnB,EAAKL,SAAWN,EAAE+B,IAAIpC,EAAO,SAASqC,GAAK,OAAOA,EAAEpB,MAAUjB,EAAM,GAAGiB,IACvED,EAAKL,SAAWX,EAAQA,EAAM,IAElCsC,KAGD,IAAKxB,EAAI,EAAGA,EAAIX,EAAKW,IAAK,CAEzB,GAAiB,cADjBP,EAAOP,EAAMc,IACJN,OAAwBQ,EAAKP,QACrC,OAAOW,EAAKmB,SAEbhC,EAAKiC,QAAUvB,EACC,KAAZV,EAAKU,IACRqB,EAAIG,KAAKjD,EAAGkD,SACXnB,MAAQoB,IAAM,MAAOC,OAASrC,EAAKsC,MACnCC,QAAUC,KAAO,MAAO5C,IAAM,EAAG6C,SAAU,GAC3CC,gBAAiB,IAEjB3B,KAAK,SAASC,GACVA,EAAKN,MACIzB,EAAGe,KAAKhB,KAAKsD,MACnB5B,IAAM1B,KAAK0B,IAAMM,EAAKN,MAE5BiC,KAAK3C,KAEPA,EAAKU,IAAMzB,EAAGyB,IAAIV,EAAKsC,MAElB7B,EAAKmB,UACNnB,EAAKmC,UACR5C,EAAK6C,KAAO5D,EAAG4D,KAAK7C,EAAKsC,MACP,KAAdtC,EAAK6C,MAAe7C,EAAK8C,OAE5B,WACC,IAAIC,EAAOjD,EAAEgB,WACbiB,EAAIG,KAAKa,GACT9D,EAAG4D,KAAK7C,EAAKsC,MAAM,MACjBvB,KAAK,SAAS8B,GACd7C,EAAK6C,KAAOA,IAEZxB,KAAK,WACLrB,EAAK6C,KAAO,KAEZG,OAAO,WACPD,EAAIE,YAXP,IAgBEjD,EAAKY,KAAmB,GAAZZ,EAAKY,MACpBZ,EAAKY,IAAMA,EAAMZ,EAAKY,KAElBZ,EAAKkD,OAAUlD,EAAKmD,SACpBnD,EAAKQ,KACRA,EAAMR,EAAKQ,IAAI4C,MAAM,KACrBpD,EAAKkD,MAAQ1C,EAAI,GACjBR,EAAKmD,OAAS3C,EAAI,IACRC,EAAK4C,aAA8C,IAAhCrD,EAAKC,KAAKqD,QAAQ,UAC/CvB,EAAIG,KAAKjD,EAAGkD,SACXnB,MAAQoB,IAAM,MAAOC,OAASrC,EAAKsC,MACnCC,QAAUC,KAAO,MAAO5C,IAAM,EAAG6C,SAAU,GAC3CC,gBAAiB,IAEjB3B,KAAK,SAASC,GACd,GAAIA,EAAKR,IAAK,CACb,IAAIA,EAAMQ,EAAKR,IAAI4C,MAAM,KACrBG,EAAQtE,EAAGe,KAAKhB,KAAKsD,MACzBiB,EAAML,MAAQlE,KAAKkE,MAAQ1C,EAAI,GAC/B+C,EAAMJ,OAASnE,KAAKmE,OAAS3C,EAAI,KAEjCmC,KAAK3C,OAMX,OAAI+B,EAAIlC,QACPC,EAAE0D,KAAKC,MAAM,KAAM1B,GAAKiB,OAAO,WAC9BnC,EAAKoC,QAAQtB,OAEPd,GAGDA,EAAKoC,QAAQtB,QAGnB/C,WAAc8E,WAAY,GAEtB/E","file":"../../commands/getfile.js","sourcesContent":["define([\n\t\"../elFinder\"\n],function(elFinder){\n\t/**\n\t * @class elFinder command \"getfile\". \n\t * Return selected files info into outer callback.\n\t * For use elFinder with wysiwyg editors etc.\n\t *\n\t * @author Dmitry (dio) Levashov, dio@std42.ru\n\t **/\n\t(elFinder.prototype.commands.getfile = function() {\n\t\t\"use strict\";\n\t\tvar self   = this,\n\t\t\tfm     = this.fm,\n\t\t\tfilter = function(files) {\n\t\t\t\tvar o = self.options;\n\n\t\t\t\tfiles = $.grep(files, function(file) {\n\t\t\t\t\treturn (file.mime != 'directory' || o.folders) && file.read ? true : false;\n\t\t\t\t});\n\n\t\t\t\treturn o.multiple || files.length == 1 ? files : [];\n\t\t\t};\n\t\t\n\t\tthis.alwaysEnabled = true;\n\t\tthis.callback      = fm.options.getFileCallback;\n\t\tthis._disabled     = typeof(this.callback) == 'function';\n\t\t\n\t\tthis.getstate = function(select) {\n\t\t\tvar sel = this.files(select),\n\t\t\t\tcnt = sel.length;\n\t\t\t\t\n\t\t\treturn this.callback && cnt && filter(sel).length == cnt ? 0 : -1;\n\t\t};\n\t\t\n\t\tthis.exec = function(hashes) {\n\t\t\tvar fm    = this.fm,\n\t\t\t\topts  = this.options,\n\t\t\t\tfiles = this.files(hashes),\n\t\t\t\tcnt   = files.length,\n\t\t\t\turl   = fm.option('url'),\n\t\t\t\ttmb   = fm.option('tmbUrl'),\n\t\t\t\tdfrd  = $.Deferred()\n\t\t\t\t\t.done(function(data) {\n\t\t\t\t\t\tvar res,\n\t\t\t\t\t\t\tdone = function() {\n\t\t\t\t\t\t\t\tif (opts.oncomplete == 'close') {\n\t\t\t\t\t\t\t\t\tfm.hide();\n\t\t\t\t\t\t\t\t} else if (opts.oncomplete == 'destroy') {\n\t\t\t\t\t\t\t\t\tfm.destroy();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tfail = function(error) {\n\t\t\t\t\t\t\t\tif (opts.onerror == 'close') {\n\t\t\t\t\t\t\t\t\tfm.hide();\n\t\t\t\t\t\t\t\t} else if (opts.onerror == 'destroy') {\n\t\t\t\t\t\t\t\t\tfm.destroy();\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\terror && fm.error(error);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\n\t\t\t\t\t\tfm.trigger('getfile', {files : data});\n\t\t\t\t\t\t\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tres = self.callback(data, fm);\n\t\t\t\t\t\t} catch(e) {\n\t\t\t\t\t\t\tfail(['Error in `getFileCallback`.', e.message]);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (typeof res === 'object' && typeof res.done === 'function') {\n\t\t\t\t\t\t\tres.done(done).fail(fail);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tdone();\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\tresult = function(file) {\n\t\t\t\t\treturn opts.onlyURL\n\t\t\t\t\t\t? opts.multiple ? $.map(files, function(f) { return f.url; }) : files[0].url\n\t\t\t\t\t\t: opts.multiple ? files : files[0];\n\t\t\t\t},\n\t\t\t\treq = [], \n\t\t\t\ti, file, dim;\n\n\t\t\tfor (i = 0; i < cnt; i++) {\n\t\t\t\tfile = files[i];\n\t\t\t\tif (file.mime == 'directory' && !opts.folders) {\n\t\t\t\t\treturn dfrd.reject();\n\t\t\t\t}\n\t\t\t\tfile.baseUrl = url;\n\t\t\t\tif (file.url == '1') {\n\t\t\t\t\treq.push(fm.request({\n\t\t\t\t\t\tdata : {cmd : 'url', target : file.hash},\n\t\t\t\t\t\tnotify : {type : 'url', cnt : 1, hideCnt : true},\n\t\t\t\t\t\tpreventDefault : true\n\t\t\t\t\t})\n\t\t\t\t\t.done(function(data) {\n\t\t\t\t\t\tif (data.url) {\n\t\t\t\t\t\t\tvar rfile = fm.file(this.hash);\n\t\t\t\t\t\t\trfile.url = this.url = data.url;\n\t\t\t\t\t\t}\n\t\t\t\t\t}.bind(file)));\n\t\t\t\t} else {\n\t\t\t\t\tfile.url = fm.url(file.hash);\n\t\t\t\t}\n\t\t\t\tif (! opts.onlyURL) {\n\t\t\t\t\tif (opts.getPath) {\n\t\t\t\t\t\tfile.path = fm.path(file.hash);\n\t\t\t\t\t\tif (file.path === '' && file.phash) {\n\t\t\t\t\t\t\t// get parents\n\t\t\t\t\t\t\t(function() {\n\t\t\t\t\t\t\t\tvar dfd  = $.Deferred();\n\t\t\t\t\t\t\t\treq.push(dfd);\n\t\t\t\t\t\t\t\tfm.path(file.hash, false, {})\n\t\t\t\t\t\t\t\t\t.done(function(path) {\n\t\t\t\t\t\t\t\t\t\tfile.path = path;\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.fail(function() {\n\t\t\t\t\t\t\t\t\t\tfile.path = '';\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.always(function() {\n\t\t\t\t\t\t\t\t\t\tdfd.resolve();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t})();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (file.tmb && file.tmb != 1) {\n\t\t\t\t\t\tfile.tmb = tmb + file.tmb;\n\t\t\t\t\t}\n\t\t\t\t\tif (!file.width && !file.height) {\n\t\t\t\t\t\tif (file.dim) {\n\t\t\t\t\t\t\tdim = file.dim.split('x');\n\t\t\t\t\t\t\tfile.width = dim[0];\n\t\t\t\t\t\t\tfile.height = dim[1];\n\t\t\t\t\t\t} else if (opts.getImgSize && file.mime.indexOf('image') !== -1) {\n\t\t\t\t\t\t\treq.push(fm.request({\n\t\t\t\t\t\t\t\tdata : {cmd : 'dim', target : file.hash},\n\t\t\t\t\t\t\t\tnotify : {type : 'dim', cnt : 1, hideCnt : true},\n\t\t\t\t\t\t\t\tpreventDefault : true\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.done(function(data) {\n\t\t\t\t\t\t\t\tif (data.dim) {\n\t\t\t\t\t\t\t\t\tvar dim = data.dim.split('x');\n\t\t\t\t\t\t\t\t\tvar rfile = fm.file(this.hash);\n\t\t\t\t\t\t\t\t\trfile.width = this.width = dim[0];\n\t\t\t\t\t\t\t\t\trfile.height = this.height = dim[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}.bind(file)));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif (req.length) {\n\t\t\t\t$.when.apply(null, req).always(function() {\n\t\t\t\t\tdfrd.resolve(result(files));\n\t\t\t\t});\n\t\t\t\treturn dfrd;\n\t\t\t}\n\t\t\t\n\t\t\treturn dfrd.resolve(result(files));\n\t\t};\n\n\t}).prototype = { forceLoad : true }; // this is required command\n\n\treturn elFinder;\n\n});"]}