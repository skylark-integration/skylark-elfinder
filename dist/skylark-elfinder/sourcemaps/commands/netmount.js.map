{"version":3,"sources":["commands/netmount.js"],"names":["define","elFinder","prototype","commands","netmount","content","self","this","hasMenus","alwaysEnabled","updateOnSelect","drivers","handlers","load","fm","cookieEnabled","one","netDrivers","length","$","each","d","options","integrateInfo","trigger","Object","assign","cmd","getstate","exec","dialogNode","dialog","winFocus","inputs","opts","doMount","form","hidden","dfrd","Deferred","o","elfinderdialog","protocol","on","e","data","value","find","hide","show","children","select","addClass","title","i18n","resizable","modal","destroyOnClose","open","window","namespace","close","state","reject","off","buttons","mnt2res","val","cur","name","input","elm","is","trim","host","error","request","notify","type","cnt","hideCnt","done","pdir","added","phash","file","dirs","change","changed","hash","resolve","fail","parseError","next","comp","keyCode","ui","ENTER","append","i","attr","fmDialog","ready","closest","promise","bind","netunmount","sel","_disabled","netkey","hashes","drive","confirm","text","accept","label","callback","msgs","target","roots","work","leafRoots","idx","parents","inArray","h","push","sort","a","b","childrenRoots","requests","removed","doUmount","when","user","pass","preventFail","volumeid","volumeExpires","remove","preventDefault","concat","cancel"],"mappings":";;;;;;;AAAAA,QACC,eACC,SAASC,GAgXV,OAzWAA,EAASC,UAAUC,SAASC,SAAW,WACtC,aACA,IAECC,EAFGC,EAAOC,KACVC,GAAW,EAGZD,KAAKE,eAAiB,EACtBF,KAAKG,gBAAiB,EAEtBH,KAAKI,WAELJ,KAAKK,UACJC,KAAO,WACN,IAAIC,EAAKR,EAAKQ,GACVA,EAAGC,eACND,EAAGE,IAAI,OAAQ,WACdV,EAAKK,QAAUG,EAAGG,WACdX,EAAKK,QAAQO,QAChBC,EAAEC,KAAKd,EAAKK,QAAS,WACpB,IAAIU,EAAIf,EAAKgB,QAAQf,MACjBc,IACHb,GAAW,EACPa,EAAEE,eACLT,EAAGU,QAAQ,kBAAmBC,OAAOC,QAAQC,IAAK,YAAaN,EAAEE,uBAUzEhB,KAAKqB,SAAW,WACf,OAAOpB,EAAW,GAAK,GAGxBD,KAAKsB,KAAO,WACX,IAwJCC,EA1CEC,EA1GGC,EAGHC,EAaAC,EAeAC,EAwDAC,EAkBAC,EA7GCvB,EAAKR,EAAKQ,GACbwB,EAAOnB,EAAEoB,WACTC,EAAIlC,EAAKgB,QA8JV,OANKhB,EAAKyB,OAGTzB,EAAKyB,OAAOU,eAAe,QAF3BnC,EAAKyB,QAvJAC,EAAW,WACbC,EAAOS,SAASlB,QAAQ,SAAU,aAEnCS,GACCS,SAAWvB,EAAE,aACZwB,GAAG,SAAU,SAASC,EAAGC,GACzB,IAAIH,EAAWnC,KAAKuC,MACpBzC,EAAQ0C,KAAK,yBAAyBC,OACtC3C,EAAQ0C,KAAK,yBAAyBL,GAAUO,OAChDnB,GAAcA,EAAWoB,SAAS,+BAA+BH,KAAK,UAAUE,OAC/C,mBAAtBT,EAAEE,GAAUS,QACtBX,EAAEE,GAAUS,OAAOrC,EAAI8B,EAAGC,KAG3BO,SAAS,kBAEXlB,GACCmB,MAAiBvC,EAAGwC,KAAK,uBACzBC,WAAiB,EACjBC,OAAiB,EACjBC,gBAAiB,EACjBC,KAAiB,WAChBvC,EAAEwC,QAAQhB,GAAG,SAAS7B,EAAG8C,UAAW5B,GACpCC,EAAOS,SAASlB,QAAQ,WAEzBqC,MAAiB,WACA,WAAhBvB,EAAKwB,SAAwBxB,EAAKyB,SAClC5C,EAAEwC,QAAQK,IAAI,SAASlD,EAAG8C,UAAW5B,IAEtCiC,YAED9B,EAAU,WACT,IAGC+B,EAHGxB,EAAWT,EAAOS,SAASyB,MAC9BtB,GAAQlB,IAAM,WAAYe,SAAUA,GACpC0B,EAAM5B,EAAEE,GAiBT,GAfAvB,EAAEC,KAAKf,EAAQ0C,KAAK,kCAAkCL,GAAW,SAAS2B,EAAMC,GAC/E,IAAIH,EAAKI,GACTA,EAAMpD,EAAEmD,IACAE,GAAG,oBACND,EAAIC,GAAG,cACVL,EAAMhD,EAAEsD,KAAKF,EAAIJ,QAGlBA,EAAMhD,EAAEsD,KAAKF,EAAIJ,OAEdA,IACHtB,EAAKyB,EAAMD,MAAQF,MAIhBtB,EAAK6B,KACT,OAAO5D,EAAGU,QAAQ,SAAUmD,MAAQ,qBAAsBzC,MAAQsB,OAAO,KAGtEX,EAAKqB,UACRA,GAAU,GAGXpD,EAAG8D,SAAS/B,KAAOA,EAAMgC,QAAUC,KAAO,WAAYC,IAAM,EAAGC,SAAU,KACvEC,KAAK,SAASpC,GACd,IAAIqC,EACArC,EAAKsC,OAAStC,EAAKsC,MAAMjE,SAC5BgD,GAAWjC,EAAOS,SAASlB,QAAQ,SAAU,SACzCqB,EAAKsC,MAAM,GAAGC,QACbF,EAAOpE,EAAGuE,KAAKxC,EAAKsC,MAAM,GAAGC,UAC1BF,EAAKI,OACVJ,EAAKI,KAAO,EACZxE,EAAGyE,QAASC,SAAWN,OAI1BpE,EAAGE,IAAI,eAAgB,WACtBF,EAAGe,KAAK,OAAQgB,EAAKsC,MAAM,GAAGM,SAGhCnD,EAAKoD,YAELC,KAAK,SAAShB,GACVP,EAAIuB,MAA2B,mBAAZvB,EAAIuB,MAC1BvB,EAAIuB,KAAK7E,EAAIA,EAAG8E,WAAWjB,IAE5BrC,EAAKyB,OAAOY,KAGdrE,EAAKyB,OAAOU,eAAe,UAE5BL,EAAOjB,EAAE,8BAA8BwB,GAAG,UAAW,QAAS,SAASC,GACtE,IACCiD,EADGC,GAAO,EAEPlD,EAAEmD,UAAY5E,EAAE6E,GAAGD,QAAQE,QAC9B9E,EAAEC,KAAKgB,EAAKW,KAAK,+CAAgD,WAChE,GAAsB,KAAlB5B,EAAEZ,MAAM4D,MAGX,OAFA2B,GAAO,EACPD,EAAO1E,EAAEZ,OACF,IAGLuF,EACH3D,IAEA0D,EAAKrE,QAAQ,YAIhBa,EAAUlB,EAAE,UAGbd,EAAUc,EAAE,0DACV+E,OAAO/E,EAAE,SAAS+E,OAAO/E,EAAE,OAAOL,EAAGwC,KAAK,YAAY,UAAU4C,OAAO/E,EAAE,SAAS+E,OAAOjE,EAAOS,YAElGvB,EAAEC,KAAKd,EAAKK,QAAS,SAASwF,EAAGzD,GAC5BF,EAAEE,KACLT,EAAOS,SAASwD,OAAO,kBAAkBxD,EAAS,KAAK5B,EAAGwC,KAAKd,EAAEE,GAAU2B,MAAQ3B,GAAU,aAC7FvB,EAAEC,KAAKoB,EAAEE,GAAUT,OAAQ,SAASoC,EAAMC,GACzCA,EAAM8B,KAAK,OAAQ/B,GACO,UAAtBC,EAAM8B,KAAK,SACd9B,EAAMlB,SAAS,0CAA0CV,GACzDrC,EAAQ6F,OAAO/E,EAAE,SAASiC,SAAS,6CAA6CV,GAAUwD,OAAO/E,EAAE,OAAOL,EAAGwC,KAAKe,GAAM,UAAU6B,OAAO/E,EAAE,SAAS+E,OAAO5B,OAE3JA,EAAMlB,SAAS,4BAA4BV,GAC3CL,EAAO6D,OAAO5B,MAGhB9B,EAAEE,GAAUA,SAAWT,EAAOS,YAIhCrC,EAAQ6F,OAAO7D,GAEfhC,EAAQ0C,KAAK,yBAAyBC,OACtC3C,EAAQ0C,KAAK,yBAA2BzC,EAAKK,QAAQ,IAAIsC,OAEzDf,EAAK+B,QAAQnD,EAAGwC,KAAK,aAAenB,EAEpCD,EAAK+B,QAAQnD,EAAGwC,KAAK,cAAgB,WACpChD,EAAKyB,OAAOU,eAAe,UAG5BpC,EAAQ0C,KAAK,gBAAgBK,SAAS,oBAEtCrB,EAASzB,EAAK+F,SAASjE,EAAK8D,OAAO7F,GAAU6B,GAAMoE,MAAM,WACxDrE,EAAOS,SAASlB,QAAQ,UACxBO,EAAOU,eAAe,aAEvBX,EAAaC,EAAOwE,QAAQ,cACrBxE,GAUFO,EAAKkE,WAGblG,EAAKQ,GAAG2F,KAAK,WAAY,SAAS7D,GACjC,IAAIvB,EAAIuB,EAAEC,MAAQ,KACjBL,EAAIlC,EAAKgB,QACND,GAAKA,EAAEqB,UACNF,EAAEnB,EAAEqB,WAA0C,mBAAtBF,EAAEnB,EAAEqB,UAAUuC,OACzCzC,EAAEnB,EAAEqB,UAAUuC,KAAK3E,EAAKQ,GAAIO,GAC5BhB,EAAQ0C,KAAK,gBAAgBK,SAAS,oBACtC9C,EAAKyB,OAAOU,eAAe,oBAO/BxC,EAASC,UAAUC,SAASuG,WAAa,WAGxCnG,KAAKE,eAAiB,EACtBF,KAAKG,gBAAiB,EAEtBH,KAAKI,WAELJ,KAAKK,UACJC,KAAO,WACNN,KAAKI,QAAUJ,KAAKO,GAAGG,aAIzBV,KAAKqB,SAAW,SAAS+E,GACxB,IACCtB,EADGvE,EAAKP,KAAKO,GAEd,OAAS6F,GAAOpG,KAAKI,QAAQO,SAAWX,KAAKqG,YAAcvB,EAAOvE,EAAGuE,KAAKsB,EAAI,MAAQtB,EAAKwB,OAAS,GAAK,GAG1GtG,KAAKsB,KAAO,SAASiF,GACpB,IAAIxG,EAASC,KACZO,EAASP,KAAKO,GACdwB,EAASnB,EAAEoB,WACToD,KAAK,SAAShB,GACdA,GAAS7D,EAAG6D,MAAMA,KAEpBoC,EAASjG,EAAGuE,KAAKyB,EAAO,IA0BzB,OAAIvG,KAAKqG,UACDtE,EAAKyB,UAGO,WAAhBzB,EAAKwB,SACRhD,EAAGkG,SACF3D,MAAS/C,EAAK+C,MACd4D,KAASnG,EAAGwC,KAAK,iBAAkByD,EAAM1C,MACzC6C,QACCC,MAAW,aACXC,SAAW,WACV,IA8BOC,EA9BHC,EAAUP,EAAMtB,KACnB8B,EArCY,SAAS9B,GACxB,IACC+B,EADGD,KAqBJ,OAnBIzG,EAAG2G,YACND,KACArG,EAAEC,KAAKN,EAAG2G,UAAW,SAASrC,EAAO0B,GACpC,IACCY,EADGC,EAAU7G,EAAG6G,QAAQvC,IAEiB,KAArCsC,EAAMvG,EAAEyG,QAAQnC,EAAMkC,MAC1BD,EAAMC,EAAQzG,OAASwG,EACvBvG,EAAEC,KAAK0F,EAAQ,SAASX,EAAG0B,GAC1BL,EAAKM,MAAM3B,EAAGuB,EAAKjC,KAAMoC,SAIxBL,EAAKtG,SACRsG,EAAKO,KAAK,SAASC,EAAGC,GAAK,OAAOD,EAAE7B,EAAI8B,EAAE9B,IAC1ChF,EAAEC,KAAKoG,EAAM,SAASrB,EAAG3D,GACxB+E,EAAMO,KAAKtF,EAAEiD,UAIT8B,EAeIW,CAAcZ,GACtBa,KACAC,KACAC,EAAW,WACVlH,EAAEmH,KAAKH,GAAUlD,KAAK,WACrBnE,EAAG8D,SACF/B,MAAUlB,IAAO,WAAYe,SAAW,aAAcgC,KAAMqC,EAAMF,OAAQ0B,KAAOjB,EAAQkB,KAAO,OAChG3D,QAAUC,KAAO,aAAcC,IAAM,EAAGC,SAAU,GAClDyD,aAAc,IAEd9C,KAAK,SAAShB,GACdrC,EAAKyB,OAAOY,KAEZM,KAAK,SAASpC,GACdkE,EAAM2B,iBAAmB5H,EAAG6H,cAAc5B,EAAM2B,UAChDpG,EAAKoD,cAEJC,KAAK,SAAShB,GACZyD,EAAQlH,QACXJ,EAAG8H,QAASR,QAASA,IAEtB9F,EAAKyB,OAAOY,MAIX4C,EAAMrG,OACTJ,EAAGkG,SACF3D,MAAQ/C,EAAK+C,MACb4D,MACKI,GAAQ,mBACZlG,EAAEC,KAAKmG,EAAO,SAASpB,EAAGV,GACzB4B,EAAKS,MAAMhH,EAAGuE,KAAKI,GAAMpB,SAEnBgD,GAERH,QACCC,MAAQ,aACRC,SAAW,WACVjG,EAAEC,KAAKmG,EAAO,SAASpB,EAAGV,GACzB,IAAIpE,EAAIP,EAAGuE,KAAKI,GACZpE,EAAEwF,QACLsB,EAASL,KAAKhH,EAAG8D,SAChB/B,MAAUlB,IAAO,WAAYe,SAAW,aAAcgC,KAAMrD,EAAEwF,OAAQ0B,KAAOlH,EAAEoE,KAAM+C,KAAO,OAC5F3D,QAAUC,KAAO,aAAcC,IAAM,EAAGC,SAAU,GAClD6D,gBAAiB,IACf5D,KAAK,SAASpC,GACZA,EAAKuF,UACR/G,EAAEqH,iBAAmB5H,EAAG6H,cAActH,EAAEqH,UACxCN,EAAUA,EAAQU,OAAOjG,EAAKuF,eAKlCC,MAGFU,QACC5B,MAAQ,YACRC,SAAW,WACV9E,EAAKyB,cAKRoE,EAAW,KACXE,OAIHU,QACC5B,MAAW,YACXC,SAAW,WAAa9E,EAAKyB,aAKzBzB,KAKFrC","file":"../../commands/netmount.js","sourcesContent":["define([\n\t\"../elFinder\"\n],function(elFinder){\n\t/**\n\t * @class  elFinder command \"netmount\"\n\t * Mount network volume with user credentials.\n\t *\n\t * @author Dmitry (dio) Levashov\n\t **/\n\telFinder.prototype.commands.netmount = function() {\n\t\t\"use strict\";\n\t\tvar self = this,\n\t\t\thasMenus = false,\n\t\t\tcontent;\n\n\t\tthis.alwaysEnabled  = true;\n\t\tthis.updateOnSelect = false;\n\n\t\tthis.drivers = [];\n\t\t\n\t\tthis.handlers = {\n\t\t\tload : function() {\n\t\t\t\tvar fm = self.fm;\n\t\t\t\tif (fm.cookieEnabled) {\n\t\t\t\t\tfm.one('open', function() {\n\t\t\t\t\t\tself.drivers = fm.netDrivers;\n\t\t\t\t\t\tif (self.drivers.length) {\n\t\t\t\t\t\t\t$.each(self.drivers, function() {\n\t\t\t\t\t\t\t\tvar d = self.options[this];\n\t\t\t\t\t\t\t\tif (d) {\n\t\t\t\t\t\t\t\t\thasMenus = true;\n\t\t\t\t\t\t\t\t\tif (d.integrateInfo) {\n\t\t\t\t\t\t\t\t\t\tfm.trigger('helpIntegration', Object.assign({cmd: 'netmount'}, d.integrateInfo));\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tthis.getstate = function() {\n\t\t\treturn hasMenus ? 0 : -1;\n\t\t};\n\t\t\n\t\tthis.exec = function() {\n\t\t\tvar fm = self.fm,\n\t\t\t\tdfrd = $.Deferred(),\n\t\t\t\to = self.options,\n\t\t\t\tcreate = function() {\n\t\t\t\t\tvar winFocus = function() {\n\t\t\t\t\t\t\tinputs.protocol.trigger('change', 'winfocus');\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinputs = {\n\t\t\t\t\t\t\tprotocol : $('<select/>')\n\t\t\t\t\t\t\t.on('change', function(e, data){\n\t\t\t\t\t\t\t\tvar protocol = this.value;\n\t\t\t\t\t\t\t\tcontent.find('.elfinder-netmount-tr').hide();\n\t\t\t\t\t\t\t\tcontent.find('.elfinder-netmount-tr-'+protocol).show();\n\t\t\t\t\t\t\t\tdialogNode && dialogNode.children('.ui-dialog-buttonpane:first').find('button').show();\n\t\t\t\t\t\t\t\tif (typeof o[protocol].select == 'function') {\n\t\t\t\t\t\t\t\t\to[protocol].select(fm, e, data);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.addClass('ui-corner-all')\n\t\t\t\t\t\t},\n\t\t\t\t\t\topts = {\n\t\t\t\t\t\t\ttitle          : fm.i18n('netMountDialogTitle'),\n\t\t\t\t\t\t\tresizable      : true,\n\t\t\t\t\t\t\tmodal          : true,\n\t\t\t\t\t\t\tdestroyOnClose : false,\n\t\t\t\t\t\t\topen           : function() {\n\t\t\t\t\t\t\t\t$(window).on('focus.'+fm.namespace, winFocus);\n\t\t\t\t\t\t\t\tinputs.protocol.trigger('change');\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tclose          : function() { \n\t\t\t\t\t\t\t\tdfrd.state() == 'pending' && dfrd.reject();\n\t\t\t\t\t\t\t\t$(window).off('focus.'+fm.namespace, winFocus);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tbuttons        : {}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdoMount = function() {\n\t\t\t\t\t\t\tvar protocol = inputs.protocol.val(),\n\t\t\t\t\t\t\t\tdata = {cmd : 'netmount', protocol: protocol},\n\t\t\t\t\t\t\t\tcur = o[protocol],\n\t\t\t\t\t\t\t\tmnt2res;\n\t\t\t\t\t\t\t$.each(content.find('input.elfinder-netmount-inputs-'+protocol), function(name, input) {\n\t\t\t\t\t\t\t\tvar val, elm;\n\t\t\t\t\t\t\t\telm = $(input);\n\t\t\t\t\t\t\t\tif (elm.is(':radio,:checkbox')) {\n\t\t\t\t\t\t\t\t\tif (elm.is(':checked')) {\n\t\t\t\t\t\t\t\t\t\tval = $.trim(elm.val());\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tval = $.trim(elm.val());\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (val) {\n\t\t\t\t\t\t\t\t\tdata[input.name] = val;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tif (!data.host) {\n\t\t\t\t\t\t\t\treturn fm.trigger('error', {error : 'errNetMountHostReq', opts : {modal: true}});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (data.mnt2res) {\n\t\t\t\t\t\t\t\tmnt2res = true;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tfm.request({data : data, notify : {type : 'netmount', cnt : 1, hideCnt : true}})\n\t\t\t\t\t\t\t\t.done(function(data) {\n\t\t\t\t\t\t\t\t\tvar pdir;\n\t\t\t\t\t\t\t\t\tif (data.added && data.added.length) {\n\t\t\t\t\t\t\t\t\t\tmnt2res && inputs.protocol.trigger('change', 'reset');\n\t\t\t\t\t\t\t\t\t\tif (data.added[0].phash) {\n\t\t\t\t\t\t\t\t\t\t\tif (pdir = fm.file(data.added[0].phash)) {\n\t\t\t\t\t\t\t\t\t\t\t\tif (! pdir.dirs) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tpdir.dirs = 1;\n\t\t\t\t\t\t\t\t\t\t\t\t\tfm.change({ changed: [ pdir ] });\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tfm.one('netmountdone', function() {\n\t\t\t\t\t\t\t\t\t\t\tfm.exec('open', data.added[0].hash);\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tdfrd.resolve();\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.fail(function(error) {\n\t\t\t\t\t\t\t\t\tif (cur.fail && typeof cur.fail == 'function') {\n\t\t\t\t\t\t\t\t\t\tcur.fail(fm, fm.parseError(error));\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tdfrd.reject(error);\n\t\t\t\t\t\t\t\t});\n\t\t\n\t\t\t\t\t\t\tself.dialog.elfinderdialog('close');\n\t\t\t\t\t\t},\n\t\t\t\t\t\tform = $('<form autocomplete=\"off\"/>').on('keydown', 'input', function(e) {\n\t\t\t\t\t\t\tvar comp = true,\n\t\t\t\t\t\t\t\tnext;\n\t\t\t\t\t\t\tif (e.keyCode === $.ui.keyCode.ENTER) {\n\t\t\t\t\t\t\t\t$.each(form.find('input:visible:not(.elfinder-input-optional)'), function() {\n\t\t\t\t\t\t\t\t\tif ($(this).val() === '') {\n\t\t\t\t\t\t\t\t\t\tcomp = false;\n\t\t\t\t\t\t\t\t\t\tnext = $(this);\n\t\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tif (comp) {\n\t\t\t\t\t\t\t\t\tdoMount();\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tnext.trigger('focus');\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}),\n\t\t\t\t\t\thidden  = $('<div/>'),\n\t\t\t\t\t\tdialog;\n\n\t\t\t\t\tcontent = $('<table class=\"elfinder-info-tb elfinder-netmount-tb\"/>')\n\t\t\t\t\t\t.append($('<tr/>').append($('<td>'+fm.i18n('protocol')+'</td>')).append($('<td/>').append(inputs.protocol)));\n\n\t\t\t\t\t$.each(self.drivers, function(i, protocol) {\n\t\t\t\t\t\tif (o[protocol]) {\n\t\t\t\t\t\t\tinputs.protocol.append('<option value=\"'+protocol+'\">'+fm.i18n(o[protocol].name || protocol)+'</option>');\n\t\t\t\t\t\t\t$.each(o[protocol].inputs, function(name, input) {\n\t\t\t\t\t\t\t\tinput.attr('name', name);\n\t\t\t\t\t\t\t\tif (input.attr('type') != 'hidden') {\n\t\t\t\t\t\t\t\t\tinput.addClass('ui-corner-all elfinder-netmount-inputs-'+protocol);\n\t\t\t\t\t\t\t\t\tcontent.append($('<tr/>').addClass('elfinder-netmount-tr elfinder-netmount-tr-'+protocol).append($('<td>'+fm.i18n(name)+'</td>')).append($('<td/>').append(input)));\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tinput.addClass('elfinder-netmount-inputs-'+protocol);\n\t\t\t\t\t\t\t\t\thidden.append(input);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\to[protocol].protocol = inputs.protocol;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t\tcontent.append(hidden);\n\t\t\t\t\t\n\t\t\t\t\tcontent.find('.elfinder-netmount-tr').hide();\n\t\t\t\t\tcontent.find('.elfinder-netmount-tr-' + self.drivers[0]).show();\n\n\t\t\t\t\topts.buttons[fm.i18n('btnMount')] = doMount;\n\n\t\t\t\t\topts.buttons[fm.i18n('btnCancel')] = function() {\n\t\t\t\t\t\tself.dialog.elfinderdialog('close');\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tcontent.find('select,input').addClass('elfinder-tabstop');\n\t\t\t\t\t\n\t\t\t\t\tdialog = self.fmDialog(form.append(content), opts).ready(function() {\n\t\t\t\t\t\tinputs.protocol.trigger('change');\n\t\t\t\t\t\tdialog.elfinderdialog('posInit');\n\t\t\t\t\t});\n\t\t\t\t\tdialogNode = dialog.closest('.ui-dialog');\n\t\t\t\t\treturn dialog;\n\t\t\t\t},\n\t\t\t\tdialogNode;\n\t\t\t\n\t\t\tif (!self.dialog) {\n\t\t\t\tself.dialog = create();\n\t\t\t} else {\n\t\t\t\tself.dialog.elfinderdialog('open');\n\t\t\t}\n\n\t\t\treturn dfrd.promise();\n\t\t};\n\n\t\tself.fm.bind('netmount', function(e) {\n\t\t\tvar d = e.data || null,\n\t\t\t\to = self.options;\n\t\t\tif (d && d.protocol) {\n\t\t\t\tif (o[d.protocol] && typeof o[d.protocol].done == 'function') {\n\t\t\t\t\to[d.protocol].done(self.fm, d);\n\t\t\t\t\tcontent.find('select,input').addClass('elfinder-tabstop');\n\t\t\t\t\tself.dialog.elfinderdialog('tabstopsInit');\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t};\n\n\telFinder.prototype.commands.netunmount = function() {\n\t\tvar self = this;\n\n\t\tthis.alwaysEnabled  = true;\n\t\tthis.updateOnSelect = false;\n\n\t\tthis.drivers = [];\n\t\t\n\t\tthis.handlers = {\n\t\t\tload : function() {\n\t\t\t\tthis.drivers = this.fm.netDrivers;\n\t\t\t}\n\t\t};\n\n\t\tthis.getstate = function(sel) {\n\t\t\tvar fm = this.fm,\n\t\t\t\tfile;\n\t\t\treturn !!sel && this.drivers.length && !this._disabled && (file = fm.file(sel[0])) && file.netkey ? 0 : -1;\n\t\t};\n\t\t\n\t\tthis.exec = function(hashes) {\n\t\t\tvar self   = this,\n\t\t\t\tfm     = this.fm,\n\t\t\t\tdfrd   = $.Deferred()\n\t\t\t\t\t.fail(function(error) {\n\t\t\t\t\t\terror && fm.error(error);\n\t\t\t\t\t}),\n\t\t\t\tdrive  = fm.file(hashes[0]),\n\t\t\t\tchildrenRoots = function(hash) {\n\t\t\t\t\tvar roots = [],\n\t\t\t\t\t\twork;\n\t\t\t\t\tif (fm.leafRoots) {\n\t\t\t\t\t\twork = [];\n\t\t\t\t\t\t$.each(fm.leafRoots, function(phash, hashes) {\n\t\t\t\t\t\t\tvar parents = fm.parents(phash),\n\t\t\t\t\t\t\t\tidx, deep;\n\t\t\t\t\t\t\tif ((idx = $.inArray(hash, parents)) !== -1) {\n\t\t\t\t\t\t\t\tidx = parents.length - idx;\n\t\t\t\t\t\t\t\t$.each(hashes, function(i, h) {\n\t\t\t\t\t\t\t\t\twork.push({i: idx, hash: h});\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (work.length) {\n\t\t\t\t\t\t\twork.sort(function(a, b) { return a.i < b.i; });\n\t\t\t\t\t\t\t$.each(work, function(i, o) {\n\t\t\t\t\t\t\t\troots.push(o.hash);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn roots;\n\t\t\t\t};\n\n\t\t\tif (this._disabled) {\n\t\t\t\treturn dfrd.reject();\n\t\t\t}\n\n\t\t\tif (dfrd.state() == 'pending') {\n\t\t\t\tfm.confirm({\n\t\t\t\t\ttitle  : self.title,\n\t\t\t\t\ttext   : fm.i18n('confirmUnmount', drive.name),\n\t\t\t\t\taccept : {\n\t\t\t\t\t\tlabel    : 'btnUnmount',\n\t\t\t\t\t\tcallback : function() {  \n\t\t\t\t\t\t\tvar target =  drive.hash,\n\t\t\t\t\t\t\t\troots = childrenRoots(target),\n\t\t\t\t\t\t\t\trequests = [],\n\t\t\t\t\t\t\t\tremoved = [],\n\t\t\t\t\t\t\t\tdoUmount = function() {\n\t\t\t\t\t\t\t\t\t$.when(requests).done(function() {\n\t\t\t\t\t\t\t\t\t\tfm.request({\n\t\t\t\t\t\t\t\t\t\t\tdata   : {cmd  : 'netmount', protocol : 'netunmount', host: drive.netkey, user : target, pass : 'dum'}, \n\t\t\t\t\t\t\t\t\t\t\tnotify : {type : 'netunmount', cnt : 1, hideCnt : true},\n\t\t\t\t\t\t\t\t\t\t\tpreventFail : true\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t.fail(function(error) {\n\t\t\t\t\t\t\t\t\t\t\tdfrd.reject(error);\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t.done(function(data) {\n\t\t\t\t\t\t\t\t\t\t\tdrive.volumeid && delete fm.volumeExpires[drive.volumeid];\n\t\t\t\t\t\t\t\t\t\t\tdfrd.resolve();\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}).fail(function(error) {\n\t\t\t\t\t\t\t\t\t\tif (removed.length) {\n\t\t\t\t\t\t\t\t\t\t\tfm.remove({ removed: removed });\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tdfrd.reject(error);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (roots.length) {\n\t\t\t\t\t\t\t\tfm.confirm({\n\t\t\t\t\t\t\t\t\ttitle : self.title,\n\t\t\t\t\t\t\t\t\ttext  : (function() {\n\t\t\t\t\t\t\t\t\t\tvar msgs = ['unmountChildren'];\n\t\t\t\t\t\t\t\t\t\t$.each(roots, function(i, hash) {\n\t\t\t\t\t\t\t\t\t\t\tmsgs.push([fm.file(hash).name]);\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\treturn msgs;\n\t\t\t\t\t\t\t\t\t})(),\n\t\t\t\t\t\t\t\t\taccept : {\n\t\t\t\t\t\t\t\t\t\tlabel : 'btnUnmount',\n\t\t\t\t\t\t\t\t\t\tcallback : function() {\n\t\t\t\t\t\t\t\t\t\t\t$.each(roots, function(i, hash) {\n\t\t\t\t\t\t\t\t\t\t\t\tvar d = fm.file(hash);\n\t\t\t\t\t\t\t\t\t\t\t\tif (d.netkey) {\n\t\t\t\t\t\t\t\t\t\t\t\t\trequests.push(fm.request({\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdata   : {cmd  : 'netmount', protocol : 'netunmount', host: d.netkey, user : d.hash, pass : 'dum'}, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnotify : {type : 'netunmount', cnt : 1, hideCnt : true},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tpreventDefault : true\n\t\t\t\t\t\t\t\t\t\t\t\t\t}).done(function(data) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (data.removed) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\td.volumeid && delete fm.volumeExpires[d.volumeid];\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tremoved = removed.concat(data.removed);\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tdoUmount();\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tcancel : {\n\t\t\t\t\t\t\t\t\t\tlabel : 'btnCancel',\n\t\t\t\t\t\t\t\t\t\tcallback : function() {\n\t\t\t\t\t\t\t\t\t\t\tdfrd.reject();\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\trequests = null;\n\t\t\t\t\t\t\t\tdoUmount();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tcancel : {\n\t\t\t\t\t\tlabel    : 'btnCancel',\n\t\t\t\t\t\tcallback : function() { dfrd.reject(); }\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\t\t\n\t\t\treturn dfrd;\n\t\t};\n\n\t};\n\n\treturn elFinder;\n\n});"]}