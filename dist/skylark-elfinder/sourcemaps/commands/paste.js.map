{"version":3,"sources":["commands/paste.js"],"names":["define","elFinder","prototype","commands","paste","this","updateOnSelect","handlers","changeclipboard","update","shortcuts","pattern","getstate","dst","_disabled","Array","isArray","length","fm","file","cwd","clipboard","mime","write","exec","select","cOpts","parents","fparents","cutDfrd","self","opts","files","cnt","cut","cmd","_cmd","error","charAt","toUpperCase","substr","fpaste","fcopy","dfrd","$","Deferred","fail","always","unlockfiles","map","f","hash","each","i","read","locked","reject","name","inArray","uploadMimeCheck","pop","grep","h","d","phash","push","state","options","moveConfirm","confirm","title","text","i18n","i18","accept","label","callback","resolve","cancel","done","when","_commands","duplicate","internames","existed","hashes","intersect","names","ret","unshift","ndx","last","all","remove","buttons","rename","valid","existedArr","exists","v","n","concat","selFiles","targets","reqData","renames","suffix","backupSuffix","api","src","request","data","notify","type","navigate","toast","noToast","inbuffer","msg","action","cwdNot","dsts","added","shash","Object","keys","undo","reqs","apply","redo","flg","sync","isCommandEnabled","oldAPI","option","target","hideCnt","preventFail","list","cr","pr"],"mappings":"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","file":"../../commands/paste.js","sourcesContent":["define([\n\t\"../elFinder\"\n],function(elFinder){\n\t/**\n\t * @class  elFinder command \"paste\"\n\t * Paste filesfrom clipboard into directory.\n\t * If files pasted in its parent directory - files duplicates will created\n\t *\n\t * @author Dmitry (dio) Levashov\n\t **/\n\telFinder.prototype.commands.paste = function() {\n\t\t\"use strict\";\n\t\tthis.updateOnSelect  = false;\n\t\t\n\t\tthis.handlers = {\n\t\t\tchangeclipboard : function() { this.update(); }\n\t\t};\n\n\t\tthis.shortcuts = [{\n\t\t\tpattern     : 'ctrl+v shift+insert'\n\t\t}];\n\t\t\n\t\tthis.getstate = function(dst) {\n\t\t\tif (this._disabled) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tif (dst) {\n\t\t\t\tif (Array.isArray(dst)) {\n\t\t\t\t\tif (dst.length != 1) {\n\t\t\t\t\t\treturn -1;\n\t\t\t\t\t}\n\t\t\t\t\tdst = this.fm.file(dst[0]);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdst = this.fm.cwd();\n\t\t\t}\n\n\t\t\treturn this.fm.clipboard().length && dst.mime == 'directory' && dst.write ? 0 : -1;\n\t\t};\n\t\t\n\t\tthis.exec = function(select, cOpts) {\n\t\t\tvar self   = this,\n\t\t\t\tfm     = self.fm,\n\t\t\t\topts   = cOpts || {},\n\t\t\t\tdst    = select ? this.files(select)[0] : fm.cwd(),\n\t\t\t\tfiles  = fm.clipboard(),\n\t\t\t\tcnt    = files.length,\n\t\t\t\tcut    = cnt ? files[0].cut : false,\n\t\t\t\tcmd    = opts._cmd? opts._cmd : (cut? 'move' : 'copy'),\n\t\t\t\terror  = 'err' + cmd.charAt(0).toUpperCase() + cmd.substr(1),\n\t\t\t\tfpaste = [],\n\t\t\t\tfcopy  = [],\n\t\t\t\tdfrd   = $.Deferred()\n\t\t\t\t\t.fail(function(error) {\n\t\t\t\t\t\terror && fm.error(error);\n\t\t\t\t\t})\n\t\t\t\t\t.always(function() {\n\t\t\t\t\t\tfm.unlockfiles({files : $.map(files, function(f) { return f.hash; })});\n\t\t\t\t\t}),\n\t\t\t\tcopy  = function(files) {\n\t\t\t\t\treturn files.length && fm._commands.duplicate\n\t\t\t\t\t\t? fm.exec('duplicate', files)\n\t\t\t\t\t\t: $.Deferred().resolve();\n\t\t\t\t},\n\t\t\t\tpaste = function(files) {\n\t\t\t\t\tvar dfrd      = $.Deferred(),\n\t\t\t\t\t\texisted   = [],\n\t\t\t\t\t\thashes  = {},\n\t\t\t\t\t\tintersect = function(files, names) {\n\t\t\t\t\t\t\tvar ret = [], \n\t\t\t\t\t\t\t\ti   = files.length;\n\n\t\t\t\t\t\t\twhile (i--) {\n\t\t\t\t\t\t\t\t$.inArray(files[i].name, names) !== -1 && ret.unshift(i);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn ret;\n\t\t\t\t\t\t},\n\t\t\t\t\t\tconfirm   = function(ndx) {\n\t\t\t\t\t\t\tvar i    = existed[ndx],\n\t\t\t\t\t\t\t\tfile = files[i],\n\t\t\t\t\t\t\t\tlast = ndx == existed.length-1;\n\n\t\t\t\t\t\t\tif (!file) {\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tfm.confirm({\n\t\t\t\t\t\t\t\ttitle  : fm.i18n(cmd + 'Files'),\n\t\t\t\t\t\t\t\ttext   : ['errExists', file.name, cmd === 'restore'? 'confirmRest' : 'confirmRepl'], \n\t\t\t\t\t\t\t\tall    : !last,\n\t\t\t\t\t\t\t\taccept : {\n\t\t\t\t\t\t\t\t\tlabel    : 'btnYes',\n\t\t\t\t\t\t\t\t\tcallback : function(all) {\n\t\t\t\t\t\t\t\t\t\t!last && !all\n\t\t\t\t\t\t\t\t\t\t\t? confirm(++ndx)\n\t\t\t\t\t\t\t\t\t\t\t: paste(files);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\treject : {\n\t\t\t\t\t\t\t\t\tlabel    : 'btnNo',\n\t\t\t\t\t\t\t\t\tcallback : function(all) {\n\t\t\t\t\t\t\t\t\t\tvar i;\n\n\t\t\t\t\t\t\t\t\t\tif (all) {\n\t\t\t\t\t\t\t\t\t\t\ti = existed.length;\n\t\t\t\t\t\t\t\t\t\t\twhile (ndx < i--) {\n\t\t\t\t\t\t\t\t\t\t\t\tfiles[existed[i]].remove = true;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\tfiles[existed[ndx]].remove = true;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t!last && !all\n\t\t\t\t\t\t\t\t\t\t\t? confirm(++ndx)\n\t\t\t\t\t\t\t\t\t\t\t: paste(files);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tcancel : {\n\t\t\t\t\t\t\t\t\tlabel    : 'btnCancel',\n\t\t\t\t\t\t\t\t\tcallback : function() {\n\t\t\t\t\t\t\t\t\t\tdfrd.resolve();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tbuttons : [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tlabel : 'btnBackup',\n\t\t\t\t\t\t\t\t\t\tcallback : function(all) {\n\t\t\t\t\t\t\t\t\t\t\tvar i;\n\t\t\t\t\t\t\t\t\t\t\tif (all) {\n\t\t\t\t\t\t\t\t\t\t\t\ti = existed.length;\n\t\t\t\t\t\t\t\t\t\t\t\twhile (ndx < i--) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfiles[existed[i]].rename = true;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\tfiles[existed[ndx]].rename = true;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t!last && !all\n\t\t\t\t\t\t\t\t\t\t\t\t? confirm(++ndx)\n\t\t\t\t\t\t\t\t\t\t\t\t: paste(files);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t\tvalid     = function(names) {\n\t\t\t\t\t\t\tvar exists = {}, existedArr;\n\t\t\t\t\t\t\tif (names) {\n\t\t\t\t\t\t\t\tif (Array.isArray(names)) {\n\t\t\t\t\t\t\t\t\tif (names.length) {\n\t\t\t\t\t\t\t\t\t\tif (typeof names[0] == 'string') {\n\t\t\t\t\t\t\t\t\t\t\t// elFinder <= 2.1.6 command `is` results\n\t\t\t\t\t\t\t\t\t\t\texisted = intersect(files, names);\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t$.each(names, function(i, v) {\n\t\t\t\t\t\t\t\t\t\t\t\texists[v.name] = v.hash;\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\texisted = intersect(files, $.map(exists, function(h, n) { return n; }));\n\t\t\t\t\t\t\t\t\t\t\t$.each(files, function(i, file) {\n\t\t\t\t\t\t\t\t\t\t\t\tif (exists[file.name]) {\n\t\t\t\t\t\t\t\t\t\t\t\t\thashes[exists[file.name]] = file.name;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\texistedArr = [];\n\t\t\t\t\t\t\t\t\texisted = $.map(names, function(n) {\n\t\t\t\t\t\t\t\t\t\tif (typeof n === 'string') {\n\t\t\t\t\t\t\t\t\t\t\treturn n;\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t// support to >=2.1.11 plugin Normalizer, Sanitizer\n\t\t\t\t\t\t\t\t\t\t\texistedArr = existedArr.concat(n);\n\t\t\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\tif (existedArr.length) {\n\t\t\t\t\t\t\t\t\t\texisted = existed.concat(existedArr);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\texisted = intersect(files, existed);\n\t\t\t\t\t\t\t\t\thashes = names;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\texisted.length ? confirm(0) : paste(files);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tpaste     = function(selFiles) {\n\t\t\t\t\t\t\tvar renames = [],\n\t\t\t\t\t\t\t\tfiles  = $.grep(selFiles, function(file) { \n\t\t\t\t\t\t\t\t\tif (file.rename) {\n\t\t\t\t\t\t\t\t\t\trenames.push(file.name);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn !file.remove ? true : false;\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\tcnt    = files.length,\n\t\t\t\t\t\t\t\tgroups = {},\n\t\t\t\t\t\t\t\targs   = [],\n\t\t\t\t\t\t\t\ttargets, reqData;\n\n\t\t\t\t\t\t\tif (!cnt) {\n\t\t\t\t\t\t\t\treturn dfrd.resolve();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\ttargets = $.map(files, function(f) { return f.hash; });\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\treqData = {cmd : 'paste', dst : dst.hash, targets : targets, cut : cut ? 1 : 0, renames : renames, hashes : hashes, suffix : fm.options.backupSuffix};\n\t\t\t\t\t\t\tif (fm.api < 2.1) {\n\t\t\t\t\t\t\t\treqData.src = files[0].phash;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tfm.request({\n\t\t\t\t\t\t\t\t\tdata   : reqData,\n\t\t\t\t\t\t\t\t\tnotify : {type : cmd, cnt : cnt},\n\t\t\t\t\t\t\t\t\tcancel : true,\n\t\t\t\t\t\t\t\t\tnavigate : { \n\t\t\t\t\t\t\t\t\t\ttoast  : opts.noToast? {} : {\n\t\t\t\t\t\t\t\t\t\t\tinbuffer : {msg: fm.i18n(['complete', fm.i18n('cmd' + cmd)]), action: {\n\t\t\t\t\t\t\t\t\t\t\t\tcmd: 'open',\n\t\t\t\t\t\t\t\t\t\t\t\tmsg: 'cmdopendir',\n\t\t\t\t\t\t\t\t\t\t\t\tdata: [dst.hash],\n\t\t\t\t\t\t\t\t\t\t\t\tdone: 'select',\n\t\t\t\t\t\t\t\t\t\t\t\tcwdNot: dst.hash\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.done(function(data) {\n\t\t\t\t\t\t\t\t\tvar dsts = {},\n\t\t\t\t\t\t\t\t\t\tadded = data.added && data.added.length? data.added : null;\n\t\t\t\t\t\t\t\t\tif (cut && added) {\n\t\t\t\t\t\t\t\t\t\t// undo/redo\n\t\t\t\t\t\t\t\t\t\t$.each(files, function(i, f) {\n\t\t\t\t\t\t\t\t\t\t\tvar phash = f.phash,\n\t\t\t\t\t\t\t\t\t\t\t\tsrcHash = function(name) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar hash;\n\t\t\t\t\t\t\t\t\t\t\t\t\t$.each(added, function(i, f) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (f.name === name) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\thash = f.hash;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t\treturn hash;\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tshash = srcHash(f.name);\n\t\t\t\t\t\t\t\t\t\t\tif (shash) {\n\t\t\t\t\t\t\t\t\t\t\t\tif (dsts[phash]) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tdsts[phash].push(shash);\n\t\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t\tdsts[phash] = [ shash ];\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\tif (Object.keys(dsts).length) {\n\t\t\t\t\t\t\t\t\t\t\tdata.undo = {\n\t\t\t\t\t\t\t\t\t\t\t\tcmd : 'move',\n\t\t\t\t\t\t\t\t\t\t\t\tcallback : function() {\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar reqs = [];\n\t\t\t\t\t\t\t\t\t\t\t\t\t$.each(dsts, function(dst, targets) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\treqs.push(fm.request({\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdata : {cmd : 'paste', dst : dst, targets : targets, cut : 1},\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tnotify : {type : 'undo', cnt : targets.length}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t\treturn $.when.apply(null, reqs);\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t\tdata.redo = {\n\t\t\t\t\t\t\t\t\t\t\t\tcmd : 'move',\n\t\t\t\t\t\t\t\t\t\t\t\tcallback : function() {\n\t\t\t\t\t\t\t\t\t\t\t\t\treturn fm.request({\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdata : reqData,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnotify : {type : 'redo', cnt : cnt}\n\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tdfrd.resolve(data);\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.fail(function(flg) {\n\t\t\t\t\t\t\t\t\tdfrd.reject();\n\t\t\t\t\t\t\t\t\tif (flg === 0) {\n\t\t\t\t\t\t\t\t\t\t// canceling\n\t\t\t\t\t\t\t\t\t\tfm.sync();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.always(function() {\n\t\t\t\t\t\t\t\t\tfm.unlockfiles({files : files});\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinternames;\n\n\t\t\t\t\tif (!fm.isCommandEnabled(self.name, dst.hash) || !files.length) {\n\t\t\t\t\t\treturn dfrd.resolve();\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tif (fm.oldAPI) {\n\t\t\t\t\t\tpaste(files);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (!fm.option('copyOverwrite', dst.hash)) {\n\t\t\t\t\t\t\tpaste(files);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tinternames = $.map(files, function(f) { return f.name; });\n\t\t\t\t\t\t\tdst.hash == fm.cwd().hash\n\t\t\t\t\t\t\t\t? valid($.map(fm.files(), function(file) { return file.phash == dst.hash ? {hash: file.hash, name: file.name} : null; }))\n\t\t\t\t\t\t\t\t: fm.request({\n\t\t\t\t\t\t\t\t\tdata : {cmd : 'ls', target : dst.hash, intersect : internames},\n\t\t\t\t\t\t\t\t\tnotify : {type : 'prepare', cnt : 1, hideCnt : true},\n\t\t\t\t\t\t\t\t\tpreventFail : true\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.always(function(data) {\n\t\t\t\t\t\t\t\t\tvalid(data.list);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\treturn dfrd;\n\t\t\t\t},\n\t\t\t\tparents, fparents, cutDfrd;\n\n\n\t\t\tif (!cnt || !dst || dst.mime != 'directory') {\n\t\t\t\treturn dfrd.reject();\n\t\t\t}\n\t\t\t\t\n\t\t\tif (!dst.write)\t{\n\t\t\t\treturn dfrd.reject([error, files[0].name, 'errPerm']);\n\t\t\t}\n\t\t\t\n\t\t\tparents = fm.parents(dst.hash);\n\t\t\t\n\t\t\t$.each(files, function(i, file) {\n\t\t\t\tif (!file.read) {\n\t\t\t\t\treturn !dfrd.reject([error, file.name, 'errPerm']);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (cut && file.locked) {\n\t\t\t\t\treturn !dfrd.reject(['errLocked', file.name]);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif ($.inArray(file.hash, parents) !== -1) {\n\t\t\t\t\treturn !dfrd.reject(['errCopyInItself', file.name]);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (file.mime && file.mime !== 'directory' && ! fm.uploadMimeCheck(file.mime, dst.hash)) {\n\t\t\t\t\treturn !dfrd.reject([error, file.name, 'errUploadMime']);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfparents = fm.parents(file.hash);\n\t\t\t\tfparents.pop();\n\t\t\t\tif ($.inArray(dst.hash, fparents) !== -1) {\n\t\t\t\t\t\n\t\t\t\t\tif ($.grep(fparents, function(h) { var d = fm.file(h); return d.phash == dst.hash && d.name == file.name ? true : false; }).length) {\n\t\t\t\t\t\treturn !dfrd.reject(['errReplByChild', file.name]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (file.phash == dst.hash) {\n\t\t\t\t\tfcopy.push(file.hash);\n\t\t\t\t} else {\n\t\t\t\t\tfpaste.push({\n\t\t\t\t\t\thash  : file.hash,\n\t\t\t\t\t\tphash : file.phash,\n\t\t\t\t\t\tname  : file.name\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (dfrd.state() === 'rejected') {\n\t\t\t\treturn dfrd;\n\t\t\t}\n\n\t\t\tcutDfrd = $.Deferred();\n\t\t\tif (cut && self.options.moveConfirm) {\n\t\t\t\tfm.confirm({\n\t\t\t\t\ttitle  : 'moveFiles',\n\t\t\t\t\ttext   : fm.i18n('confirmMove', dst.i18 || dst.name),\n\t\t\t\t\taccept : {\n\t\t\t\t\t\tlabel    : 'btnYes',\n\t\t\t\t\t\tcallback : function() {  \n\t\t\t\t\t\t\tcutDfrd.resolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tcancel : {\n\t\t\t\t\t\tlabel    : 'btnCancel',\n\t\t\t\t\t\tcallback : function() {\n\t\t\t\t\t\t\tcutDfrd.reject();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tcutDfrd.resolve();\n\t\t\t}\n\n\t\t\tcutDfrd.done(function() {\n\t\t\t\t$.when(\n\t\t\t\t\tcopy(fcopy),\n\t\t\t\t\tpaste(fpaste)\n\t\t\t\t)\n\t\t\t\t.done(function(cr, pr) {\n\t\t\t\t\tdfrd.resolve(pr && pr.undo? pr : void(0));\n\t\t\t\t})\n\t\t\t\t.fail(function() {\n\t\t\t\t\tdfrd.reject();\n\t\t\t\t})\n\t\t\t\t.always(function() {\n\t\t\t\t\tcut && fm.clipboard([]);\n\t\t\t\t});\n\t\t\t}).fail(function() {\n\t\t\t\tdfrd.reject();\n\t\t\t});\n\t\t\t\n\t\t\treturn dfrd;\n\t\t};\n\n\t};\n\n\treturn elFinder;\n\n});"]}